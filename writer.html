import React, { useState, useRef, useEffect } from 'react';
import { 
  Bold, Italic, Underline, AlignLeft, AlignCenter, AlignRight, 
  AlignJustify, Image as ImageIcon, Save, FileUp, 
  Cloud, CloudLightning, Check, MoreVertical,
  Undo, Redo, Printer, FileText,
  List, ListOrdered, Indent, Outdent, Link as LinkIcon, 
  RemoveFormatting, Strikethrough, Subscript, Superscript, 
  Table as TableIcon, Type, Highlighter, Heading1, Palette,
  Search, Maximize, Minimize, Clock, FileDown
} from 'lucide-react';

// --- Components ---

const Tooltip = ({ children, text }) => (
  <div className="group relative flex flex-col items-center">
    {children}
    <div className="absolute top-full mt-2 hidden flex-col items-center group-hover:flex z-50 pointer-events-none">
      <span className="relative z-10 p-2 text-xs leading-none text-white whitespace-no-wrap bg-gray-900 shadow-lg rounded-md border border-gray-700">
        {text}
      </span>
      <div className="w-3 h-3 -mt-2 rotate-45 bg-gray-900 border-l border-t border-gray-700"></div>
    </div>
  </div>
);

const IconButton = ({ onClick, icon: Icon, active, tooltip, color }) => (
  <Tooltip text={tooltip}>
    <button
      onMouseDown={(e) => e.preventDefault()} // Prevents focus loss from editor
      onClick={onClick}
      className={`p-2 rounded-xl transition-all duration-200 ease-in-out border border-transparent ${
        active 
          ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/30' 
          : 'hover:bg-white/10 hover:border-white/10 text-gray-400 hover:text-white hover:shadow-sm'
      }`}
    >
      <Icon className="w-4 h-4" color={color} />
    </button>
  </Tooltip>
);

const Divider = () => <div className="w-px h-6 bg-white/10 mx-2 self-center"></div>;

export default function WordEditor() {
  const [content, setContent] = useState('');
  const [fileName, setFileName] = useState('Untitled Document');
  const [isDirty, setIsDirty] = useState(false);
  const [syncStatus, setSyncStatus] = useState('saved'); 
  const [showCloudModal, setShowCloudModal] = useState(false);
  const [isConnectedToDrive, setIsConnectedToDrive] = useState(false);
  const [wordCount, setWordCount] = useState(0);
  const [charCount, setCharCount] = useState(0);
  const [focusMode, setFocusMode] = useState(false);
  const [showFind, setShowFind] = useState(false);
  const [findTerm, setFindTerm] = useState('');
  
  const editorRef = useRef(null);
  const imageInputRef = useRef(null);

  // Initialize
  useEffect(() => {
    const savedContent = localStorage.getItem('local-draft');
    if (savedContent) {
      if (editorRef.current) editorRef.current.innerHTML = savedContent;
      setContent(savedContent);
      updateStats(savedContent);
    } else {
      const defaultText = `<h1 style="color: #4f46e5;">Welcome to CloudWrite</h1><p>Start typing your document here...</p>`;
      if (editorRef.current) editorRef.current.innerHTML = defaultText;
      setContent(defaultText);
      updateStats(defaultText);
    }
  }, []);

  // Auto-save
  useEffect(() => {
    const interval = setInterval(() => {
      if (isDirty) {
        setSyncStatus('syncing');
        setTimeout(() => {
          localStorage.setItem('local-draft', content);
          setIsDirty(false);
          setSyncStatus('saved');
        }, 800);
      }
    }, 3000);
    return () => clearInterval(interval);
  }, [content, isDirty]);

  const updateStats = (htmlContent) => {
    const text = htmlContent.replace(/<[^>]*>/g, ' ').trim();
    setWordCount(text ? text.split(/\s+/).length : 0);
    setCharCount(text.replace(/\s/g, '').length);
  };

  const handleInput = (e) => {
    const newContent = e.currentTarget.innerHTML;
    setContent(newContent);
    setIsDirty(true);
    setSyncStatus('unsaved');
    updateStats(newContent);
  };

  const execCmd = (command, value = null) => {
    document.execCommand(command, false, value);
    if (editorRef.current) {
      setTimeout(() => editorRef.current.focus(), 0); 
    }
    if (editorRef.current) {
      handleInput({ currentTarget: editorRef.current });
    }
  };

  const handleInsertImage = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const imgHtml = `<img src="${e.target.result}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;" />`;
        execCmd('insertHTML', imgHtml);
      };
      reader.readAsDataURL(file);
    }
    e.target.value = null;
  };

  const handleInsertTable = () => {
    const rows = 3;
    const cols = 3;
    let tableHTML = '<table style="width:100%; border-collapse: collapse; margin: 1rem 0; border: 1px solid #e2e8f0;"><tbody>';
    for(let i=0; i<rows; i++){
        tableHTML += '<tr>';
        for(let j=0; j<cols; j++){
            tableHTML += '<td style="border: 1px solid #e2e8f0; padding: 12px; min-width: 50px;">Cell</td>';
        }
        tableHTML += '</tr>';
    }
    tableHTML += '</tbody></table><p><br/></p>';
    execCmd('insertHTML', tableHTML);
  };

  const handleSaveLocal = () => {
    const blob = new Blob([`
      <!DOCTYPE html>
      <html>
      <head>
        <title>${fileName}</title>
        <style>
          body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; line-height: 1.6; color: #333; }
          table { width: 100%; border-collapse: collapse; }
          td, th { border: 1px solid #ccc; padding: 8px; }
          img { max-width: 100%; }
        </style>
      </head>
      <body>${content}</body>
      </html>
    `], { type: 'text/html' });
    
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${fileName}.html`;
    a.click();
    URL.revokeObjectURL(url);
    setSyncStatus('saved');
  };

  const handleSaveTxt = () => {
     const text = editorRef.current.innerText;
     const blob = new Blob([text], { type: 'text/plain' });
     const url = URL.createObjectURL(blob);
     const a = document.createElement('a');
     a.href = url;
     a.download = `${fileName}.txt`;
     a.click();
     URL.revokeObjectURL(url);
  };

  const handleOpenLocal = (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        // Simple heuristic to check if it's HTML
        if (text.trim().startsWith('<')) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const newContent = doc.body.innerHTML;
            if (editorRef.current) editorRef.current.innerHTML = newContent;
            setContent(newContent);
            updateStats(newContent);
        } else {
            // Treat as plain text
            const newContent = text.replace(/\n/g, '<br/>');
            if (editorRef.current) editorRef.current.innerHTML = newContent;
            setContent(newContent);
            updateStats(newContent);
        }
        setFileName(file.name.replace(/\.[^/.]+$/, ""));
      };
      reader.readAsText(file);
    }
  };

  const handleFind = () => {
    if (window.find && findTerm) {
        window.find(findTerm);
    }
  };

  const simulateDriveSync = () => {
    setSyncStatus('syncing');
    setTimeout(() => {
      setIsConnectedToDrive(true);
      setShowCloudModal(false);
      setSyncStatus('saved');
    }, 1500);
  };
  
  const getReadingTime = () => {
      const wordsPerMinute = 200;
      const minutes = Math.ceil(wordCount / wordsPerMinute);
      return minutes + ' min read';
  };

  return (
    <div className="flex flex-col h-screen overflow-hidden font-sans text-slate-800 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 selection:bg-purple-500/30 selection:text-white">
      
      {/* --- Glassy Header --- */}
      {!focusMode && (
      <div className="flex items-center justify-between px-6 py-3 bg-black/20 backdrop-blur-md border-b border-white/5 shadow-sm z-20">
        <div className="flex items-center space-x-4">
          <div className="bg-gradient-to-br from-purple-600 to-indigo-700 p-2.5 rounded-xl shadow-lg shadow-black/20">
            <FileText className="w-6 h-6 text-white" />
          </div>
          <div>
            <input 
              type="text" 
              value={fileName} 
              onChange={(e) => setFileName(e.target.value)}
              className="text-lg font-bold text-gray-200 placeholder-gray-500 border-b-2 border-transparent hover:border-gray-500 focus:border-purple-500 focus:outline-none bg-transparent transition-all truncate w-48 sm:w-64"
            />
            <div className="flex items-center space-x-3 text-xs font-medium text-gray-400 mt-1">
              <button className="hover:text-white transition-colors">File</button>
              <button className="hover:text-white transition-colors">Edit</button>
              <button className="hover:text-white transition-colors">View</button>
              <button className="hover:text-white transition-colors">Insert</button>
            </div>
          </div>
        </div>

        <div className="flex items-center space-x-4">
          <div className="hidden md:flex items-center text-xs font-medium mr-2 bg-black/30 text-gray-300 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-md">
            {syncStatus === 'syncing' && (
              <span className="flex items-center animate-pulse text-blue-400">
                <CloudLightning className="w-3 h-3 mr-1.5" /> Syncing...
              </span>
            )}
            {syncStatus === 'saved' && (
              <span className="flex items-center text-emerald-400">
                <Check className="w-3 h-3 mr-1.5" /> Saved locally
              </span>
            )}
            {syncStatus === 'unsaved' && (
              <span className="text-amber-400">Unsaved changes</span>
            )}
          </div>

          <button 
            onClick={() => setShowCloudModal(true)}
            className={`flex items-center space-x-2 px-4 py-2 rounded-full text-sm font-semibold transition-all shadow-lg ${
              isConnectedToDrive 
                ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30 hover:bg-emerald-500/30' 
                : 'bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 hover:text-white'
            }`}
          >
            <Cloud className="w-4 h-4" />
            <span className="hidden sm:inline">{isConnectedToDrive ? 'Synced' : 'Connect'}</span>
          </button>
          
          <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-purple-500 to-indigo-500 text-white flex items-center justify-center text-sm font-bold shadow-md ring-2 ring-white/10 cursor-pointer hover:scale-105 transition-transform">
            JD
          </div>
        </div>
      </div>
      )}

      {/* --- Glassy Toolbar --- */}
      {!focusMode && (
      <div className="flex items-center px-6 py-2 bg-black/20 backdrop-blur-md border-b border-white/5 overflow-x-auto gap-2 shadow-sm z-10 no-scrollbar">
        
        <div className="flex items-center space-x-1 pr-2">
          <IconButton onClick={() => execCmd('undo')} icon={Undo} tooltip="Undo" />
          <IconButton onClick={() => execCmd('redo')} icon={Redo} tooltip="Redo" />
          <IconButton onClick={() => window.print()} icon={Printer} tooltip="Print" />
        </div>

        <Divider />

        <div className="flex items-center space-x-2 pr-2 pl-2">
          <div className="relative group">
             <select 
               onChange={(e) => execCmd('formatBlock', e.target.value)} 
               className="appearance-none h-9 pl-3 pr-8 bg-white/5 border border-white/10 rounded-xl text-sm font-medium text-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-white/10 transition-colors cursor-pointer w-28 backdrop-blur-sm"
               onMouseDown={(e) => e.stopPropagation()}
             >
              <option value="div" className="bg-gray-800">Normal</option>
              <option value="h1" className="bg-gray-800">Heading 1</option>
              <option value="h2" className="bg-gray-800">Heading 2</option>
              <option value="h3" className="bg-gray-800">Heading 3</option>
              <option value="blockquote" className="bg-gray-800">Quote</option>
            </select>
          </div>
          
          <select 
            onChange={(e) => execCmd('fontName', e.target.value)} 
            className="appearance-none h-9 pl-3 pr-8 bg-white/5 border border-white/10 rounded-xl text-sm font-medium text-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-white/10 transition-colors cursor-pointer w-32 backdrop-blur-sm"
          >
            <option value="ui-sans-serif, system-ui, sans-serif" className="bg-gray-800">Sans Serif</option>
            <option value="ui-serif, Georgia, serif" className="bg-gray-800">Serif</option>
            <option value="ui-monospace, SFMono-Regular, monospace" className="bg-gray-800">Monospace</option>
            <option value="Comic Sans MS" className="bg-gray-800">Comic Sans</option>
          </select>
        </div>

        <Divider />

        <div className="flex items-center space-x-1 pr-2 pl-2">
          <IconButton onClick={() => execCmd('bold')} icon={Bold} tooltip="Bold" />
          <IconButton onClick={() => execCmd('italic')} icon={Italic} tooltip="Italic" />
          <IconButton onClick={() => execCmd('underline')} icon={Underline} tooltip="Underline" />
          <IconButton onClick={() => execCmd('strikeThrough')} icon={Strikethrough} tooltip="Strikethrough" />
          
          <div className="relative flex items-center justify-center mx-1 group">
            <label className="cursor-pointer flex items-center justify-center p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent transition-colors" title="Text Color">
              <Palette className="w-4 h-4 text-gray-400 hover:text-white" />
              <input 
                type="color" 
                className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                onChange={(e) => execCmd('foreColor', e.target.value)}
              />
            </label>
          </div>
          <div className="relative flex items-center justify-center mx-1 group">
            <label className="cursor-pointer flex items-center justify-center p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent transition-colors" title="Highlight Color">
              <Highlighter className="w-4 h-4 text-gray-400 hover:text-white" />
              <input 
                type="color" 
                defaultValue="#ffff00"
                className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                onChange={(e) => execCmd('hiliteColor', e.target.value)}
              />
            </label>
          </div>
        </div>

        <Divider />

        <div className="flex items-center space-x-1 pr-2 pl-2">
          <IconButton onClick={() => execCmd('justifyLeft')} icon={AlignLeft} tooltip="Left" />
          <IconButton onClick={() => execCmd('justifyCenter')} icon={AlignCenter} tooltip="Center" />
          <IconButton onClick={() => execCmd('justifyRight')} icon={AlignRight} tooltip="Right" />
        </div>

        <Divider />

        <div className="flex items-center space-x-1 pr-2 pl-2">
          <IconButton onClick={() => execCmd('insertUnorderedList')} icon={List} tooltip="Bullet List" />
          <IconButton onClick={() => execCmd('insertOrderedList')} icon={ListOrdered} tooltip="Number List" />
          <IconButton onClick={() => execCmd('indent')} icon={Indent} tooltip="Indent" />
        </div>

        <Divider />

        <div className="flex items-center space-x-1 pl-2">
          <IconButton onClick={() => {
             const url = prompt('Enter URL:');
             if(url) execCmd('createLink', url);
          }} icon={LinkIcon} tooltip="Link" />
          
          <Tooltip text="Upload Image">
            <label className="p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent text-gray-400 hover:text-white cursor-pointer transition-colors block">
              <ImageIcon className="w-4 h-4" />
              <input 
                type="file" 
                accept="image/*" 
                className="hidden" 
                ref={imageInputRef}
                onChange={handleInsertImage}
              />
            </label>
          </Tooltip>

          <IconButton onClick={handleInsertTable} icon={TableIcon} tooltip="Table" />
          
          <div className="w-px h-6 bg-white/10 mx-2"></div>
          
          <Tooltip text="Open File">
            <label className="p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent text-gray-400 hover:text-white cursor-pointer transition-colors block">
              <FileUp className="w-4 h-4" />
              <input type="file" className="hidden" accept=".html,.txt" onChange={handleOpenLocal} />
            </label>
          </Tooltip>
          
          <IconButton onClick={handleSaveLocal} icon={Save} tooltip="Save HTML" />
          <IconButton onClick={handleSaveTxt} icon={FileDown} tooltip="Save TXT" />

          <div className="w-px h-6 bg-white/10 mx-2"></div>
          
          <IconButton onClick={() => setShowFind(!showFind)} active={showFind} icon={Search} tooltip="Find" />
          <IconButton onClick={() => setFocusMode(!focusMode)} active={focusMode} icon={Maximize} tooltip="Focus Mode" />

        </div>
      </div>
      )}

      {/* --- Find Bar --- */}
      {showFind && !focusMode && (
        <div className="flex items-center px-6 py-2 bg-gray-800/80 backdrop-blur-xl border-b border-white/10 shadow-inner z-10 animate-in slide-in-from-top-2">
            <span className="text-sm font-medium text-gray-300 mr-2">Find:</span>
            <input 
                type="text" 
                value={findTerm}
                onChange={(e) => setFindTerm(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleFind()}
                className="h-8 px-3 rounded-lg bg-black/40 border border-white/10 text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 w-64 mr-2 placeholder-gray-500"
                placeholder="Type and press Enter..."
                autoFocus
            />
            <button onClick={handleFind} className="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700">Next</button>
            <button onClick={() => setShowFind(false)} className="ml-2 text-gray-400 hover:text-white text-sm">Close</button>
        </div>
      )}

      {/* --- Main Editor Area --- */}
      <div 
        className="flex-1 overflow-y-auto cursor-text p-8 md:p-12"
        onClick={() => editorRef.current?.focus()}
      >
        <div className="max-w-[210mm] mx-auto transition-transform duration-500 ease-out">
            {focusMode && (
                <div className="fixed top-4 right-8 z-50 group">
                    <button 
                        onClick={() => setFocusMode(false)}
                        className="bg-black/40 hover:bg-black/60 text-white p-2 rounded-full backdrop-blur-sm transition-colors border border-white/10"
                    >
                        <Minimize className="w-5 h-5" />
                    </button>
                    <span className="absolute right-full mr-2 top-1.5 text-xs text-white bg-black/50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Exit Focus</span>
                </div>
            )}
          
          {/* The Page */}
          <div 
            className={`bg-white min-h-[297mm] p-[25mm] shadow-2xl rounded-sm ring-1 ring-black/5 transition-all duration-700 ${focusMode ? 'scale-105 shadow-[0_0_100px_rgba(0,0,0,0.5)]' : ''}`}
            style={{ width: '100%' }}
          >
            <div
              ref={editorRef}
              contentEditable
              suppressContentEditableWarning
              className="outline-none min-h-full text-base leading-relaxed text-left text-black empty:before:content-[attr(placeholder)] empty:before:text-slate-400 selection:bg-purple-200 selection:text-purple-900"
              onInput={handleInput}
              spellCheck={true}
              placeholder="Type something amazing..."
              style={{
                color: 'inherit'
              }}
            />
          </div>
          
          <div className="h-24 text-center text-white/20 text-sm font-medium py-8 italic">
             End of Document
          </div>
        </div>
      </div>

      {/* --- Footer / Status Bar --- */}
      {!focusMode && (
      <div className="bg-black/20 backdrop-blur-md border-t border-white/5 px-6 py-2 flex justify-between items-center text-xs font-medium text-gray-400 z-20">
         <div className="flex space-x-6">
           <span className="hover:text-white transition-colors cursor-pointer">Page 1 of 1</span>
           <span className="hover:text-white transition-colors cursor-pointer">{wordCount} words</span>
           <span className="hover:text-white transition-colors cursor-pointer">{charCount} chars</span>
           <span className="flex items-center hover:text-white transition-colors cursor-pointer"><Clock className="w-3 h-3 mr-1"/> {getReadingTime()}</span>
         </div>
         <div className="flex items-center space-x-3">
           <div className="w-32 bg-white/10 rounded-full h-1.5 overflow-hidden">
             <div className="bg-purple-500 w-full h-1.5 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)]"></div>
           </div>
           <span className="text-gray-300 font-bold drop-shadow-md">100%</span>
         </div>
      </div>
      )}

      {/* --- Modern Glass Modal --- */}
      {showCloudModal && (
        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-in fade-in duration-200">
          <div className="bg-gray-900/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-md p-8 border border-white/10 transform transition-all scale-100 ring-1 ring-white/10">
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center space-x-3">
                 <div className="bg-purple-500/20 p-2 rounded-xl shadow-inner border border-purple-500/20">
                    <Cloud className="w-6 h-6 text-purple-400" />
                 </div>
                 <h3 className="text-xl font-bold text-white">Sync Settings</h3>
              </div>
              <button 
                onClick={() => setShowCloudModal(false)} 
                className="text-gray-500 hover:text-white p-1 hover:bg-white/10 rounded-full transition-colors"
              >
                <MoreVertical className="w-5 h-5" />
              </button>
            </div>
            
            <p className="text-gray-400 mb-8 leading-relaxed">
              Connect your Google Drive account to keep your documents safe and accessible everywhere. 
            </p>

            {!isConnectedToDrive ? (
              <div className="space-y-4">
                 <button 
                  onClick={simulateDriveSync}
                  className="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-purple-900/50 transition-all hover:scale-[1.02] flex justify-center items-center group"
                 >
                   <span className="group-hover:animate-pulse mr-2">âš¡</span> Connect Account
                 </button>
                 <p className="text-xs text-center text-gray-500">
                   Secured by standard OAuth 2.0 protocols.
                 </p>
              </div>
            ) : (
               <div className="text-center py-6 bg-emerald-900/20 rounded-xl border border-emerald-500/20">
                 <div className="mx-auto w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mb-4 shadow-sm border border-emerald-500/20">
                    <Check className="w-8 h-8 text-emerald-400" />
                 </div>
                 <p className="text-lg font-bold text-white">Sync Active</p>
                 <p className="text-sm text-gray-400 mt-1">Last synced just now</p>
                 <button 
                   onClick={() => { setIsConnectedToDrive(false); setShowCloudModal(false); }}
                   className="mt-6 text-rose-400 text-sm font-semibold hover:text-rose-300 transition-colors"
                 >
                   Disconnect Account
                 </button>
               </div>
            )}
          </div>
        </div>
      )}

    </div>
  );
}