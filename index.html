<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NarrativeOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 20px;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .shadow-glow {
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        
        /* Editor Title Styling */
        [contenteditable] [data-format="title"] {
            font-size: 2rem !important;
            font-weight: bold !important;
            color: #1e293b !important;
            margin-bottom: 0.5rem !important;
            line-height: 1.2 !important;
            display: block;
        }
        [contenteditable] [data-format="subtitle"] {
            font-size: 1.25rem !important;
            font-style: italic !important;
            color: #64748b !important;
            margin-bottom: 1rem !important;
            line-height: 1.4 !important;
            display: block;
        }
        [contenteditable] h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 1.5rem 0 1rem 0;
            line-height: 1.2;
            font-family: Georgia, serif;
            border-bottom: 3px solid #4f46e5;
            padding-bottom: 0.5rem;
        }
        [contenteditable] h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #334155;
            margin: 1.25rem 0 0.75rem 0;
            line-height: 1.3;
            font-family: Georgia, serif;
        }
        [contenteditable] h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #475569;
            margin: 1rem 0 0.5rem 0;
            line-height: 1.4;
        }
        [contenteditable] p {
            margin: 0.75rem 0;
            line-height: 1.8;
        }
    </style>
</head>
<body class="bg-[#0b0c0f] text-slate-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Layout, Map, BarChart2, Settings, ChevronRight, ChevronDown, 
            Plus, MoreHorizontal, User, Search, Maximize2, Minimize2, Mic, Eye, 
            EyeOff, GitBranch, Target, Clock, Zap, Coffee, Cloud, Save, PenTool, 
            Anchor, Volume2, Image as ImageIcon, MessageSquare, AlertTriangle, 
            RefreshCcw, Play, Pause, Headphones,
            Bold, Italic, Underline, AlignLeft, AlignCenter, AlignRight, 
            AlignJustify, FileUp, CloudLightning, Check, MoreVertical,
            Undo, Redo, Printer, FileText,
            List, ListOrdered, Indent, Outdent, Link as LinkIcon, 
            RemoveFormatting, Strikethrough, Subscript, Superscript, 
            Table as TableIcon, Type, Highlighter, Heading1, Palette,
            Maximize, Minimize, FileDown, X, Loader2, Trash2
        } from 'https://esm.sh/lucide-react@0.263.1';

        /**
         * NARRATIVE OS: ULTIMATE EDITION
         * A Next-Generation Visual Book Writing Platform Prototype
         */

        // --- PROJECT DATA STRUCTURE ---
        
        const DEFAULT_PROJECT = {
            id: 'default-project',
            name: 'My Novel',
            created: Date.now(),
            lastModified: Date.now(),
            sections: [
                {
                    id: 'section-1',
                    name: 'Part I: The Beginning',
                    chapters: [
                        {
                            id: 'ch-1',
                            title: 'Chapter 1',
                            subtitle: '',
                            content: '<h1>Chapter 1</h1><p>Start writing your story here...</p>',
                            status: 'draft',
                            targetWords: 2500,
                            characterTags: [],
                            notes: ''
                        }
                    ]
                }
            ],
            characters: [],
            locations: [],
            timeline: [],
            settings: {
                targetWords: 80000,
                genre: '',
                theme: ''
            }
        };

        // Storage Management
        const ProjectStorage = {
            getAllProjects() {
                const stored = localStorage.getItem('narrativeos-projects');
                if (!stored) {
                    const defaultProj = { ...DEFAULT_PROJECT };
                    // Save directly without calling getAllProjects
                    localStorage.setItem('narrativeos-projects', JSON.stringify([defaultProj]));
                    return [defaultProj];
                }
                return JSON.parse(stored);
            },
            
            saveProject(project) {
                project.lastModified = Date.now();
                const stored = localStorage.getItem('narrativeos-projects');
                const projects = stored ? JSON.parse(stored) : [];
                const filtered = projects.filter(p => p.id !== project.id);
                filtered.push(project);
                localStorage.setItem('narrativeos-projects', JSON.stringify(filtered));
            },
            
            getProject(id) {
                const projects = this.getAllProjects();
                return projects.find(p => p.id === id) || DEFAULT_PROJECT;
            },
            
            createProject(name) {
                const project = {
                    ...DEFAULT_PROJECT,
                    id: `project-${Date.now()}`,
                    name: name,
                    created: Date.now(),
                    lastModified: Date.now(),
                    sections: [
                        {
                            id: 'section-1',
                            name: 'Part I: The Beginning',
                            chapters: [
                                {
                                    id: 'ch-1',
                                    title: 'Chapter 1',
                                    subtitle: '',
                                    content: '<h1>Chapter 1</h1><p>Start writing your story here...</p>',
                                    status: 'draft',
                                    targetWords: 2500,
                                    characterTags: [],
                                    notes: ''
                                }
                            ]
                        }
                    ]
                };
                this.saveProject(project);
                return project;
            }
        };

        // --- UTILITY COMPONENTS ---

        const ProgressBar = ({ current, max, color = 'bg-blue-500' }) => {
            const percent = Math.min((current / max) * 100, 100);
            return (
                <div className="h-1 w-full bg-slate-800 rounded-full overflow-hidden mt-1">
                <div className={`h-full ${color} transition-all duration-500`} style={{ width: `${percent}%` }} />
                </div>
            );
        };

        // --- GOOGLE DRIVE CONFIGURATION ---
        // GUIDE FOR: https://marcoj03rgensen.github.io/NarrativeOS/
        // 1. Go to Google Cloud Console: https://console.cloud.google.com/
        // 2. Create a new project (e.g., "NarrativeOS").
        // 3. Enable "Google Drive API" in "APIs & Services" > "Library".
        // 4. Configure "OAuth Consent Screen" (User Type: External).
        // 5. Create Credentials > OAuth Client ID (Application Type: Web application).
        //    - Authorized JavaScript origins: https://marcoj03rgensen.github.io  (EXACTLY THIS, NO SLASH AT END)
        //    - Authorized redirect URIs:      https://marcoj03rgensen.github.io/NarrativeOS/
        // 6. Create Credentials > API Key.
        
        // TODO: PASTE YOUR KEYS BELOW
        const CLIENT_ID = '692298824206-ffqjkrgits24tqsk6h22tfcb2gv1m0ip.apps.googleusercontent.com'; 
        const API_KEY = 'AIzaSyCBwO7tdzYM7B8dJE0BfTz_2WzKNSBhKQg'; 
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // --- EDITOR COMPONENTS ---

        const Tooltip = ({ children, text }) => (
          <div className="group relative flex flex-col items-center">
            {children}
            <div className="absolute top-full mt-2 hidden flex-col items-center group-hover:flex z-50 pointer-events-none">
              <span className="relative z-10 p-2 text-xs leading-none text-white whitespace-no-wrap bg-gray-900 shadow-lg rounded-md border border-gray-700">
                {text}
              </span>
              <div className="w-3 h-3 -mt-2 rotate-45 bg-gray-900 border-l border-t border-gray-700"></div>
            </div>
          </div>
        );

        const IconButton = ({ onClick, icon: Icon, active, tooltip, color }) => (
          <Tooltip text={tooltip}>
            <button
              onMouseDown={(e) => e.preventDefault()} 
              onClick={onClick}
              className={`p-2 rounded-xl transition-all duration-200 ease-in-out border border-transparent ${
                active 
                  ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/30' 
                  : 'hover:bg-white/10 hover:border-white/10 text-gray-400 hover:text-white hover:shadow-sm'
              }`}
            >
              <Icon className="w-4 h-4" color={color} />
            </button>
          </Tooltip>
        );

        const Divider = () => <div className="w-px h-6 bg-white/10 mx-2 self-center"></div>;

        function WordEditor({ initialContent, onStatsUpdate, onContentChange, projectName, geminiApiKey, setGeminiApiKey, availableModels, selectedModel, setSelectedModel, aiProvider, setAiProvider, hfToken, setHfToken, hfModel, setHfModel, HF_MODELS, githubToken, setGithubToken, githubModel, setGithubModel, GITHUB_MODELS }) {
          const [content, setContent] = useState(initialContent || '');
          const [fileName, setFileName] = useState(projectName || 'Untitled Project');
          const [isDirty, setIsDirty] = useState(false);
          const [syncStatus, setSyncStatus] = useState('saved'); 
          const [showCloudModal, setShowCloudModal] = useState(false);
          const [isConnectedToDrive, setIsConnectedToDrive] = useState(() => {
              const stored = localStorage.getItem('narrativeos-connected');
              return stored === 'true';
          });
          const [wordCount, setWordCount] = useState(0);
          const [charCount, setCharCount] = useState(0);
          const [focusMode, setFocusMode] = useState(false);
          const [showFind, setShowFind] = useState(false);
          const [findTerm, setFindTerm] = useState('');
          
          // Narrative Features State
          const [splitScreen, setSplitScreen] = useState(false);
          const [showAiPanel, setShowAiPanel] = useState(false);
          const [ambientSound, setAmbientSound] = useState(null);
          const [textMode, setTextMode] = useState('normal'); // normal, rhythm, hemingway, blind, dialogue

          const audioRef = useRef(null);

          // Ambient Sound Effect
          useEffect(() => {
              if (ambientSound) {
                  console.log(`Playing ambient sound: ${ambientSound}`);
              }
          }, [ambientSound]);
          
          // Google Drive State
          const [tokenClient, setTokenClient] = useState(null);
          const [gapiInited, setGapiInited] = useState(false);
          const [gisInited, setGisInited] = useState(false);
          const [driveFolderId, setDriveFolderId] = useState(() => {
              const stored = localStorage.getItem('narrativeos-drive-folder');
              return stored || null;
          });
          const [driveFileId, setDriveFileId] = useState(null);
          
          // AI State
          const [aiPrompt, setAiPrompt] = useState('');
          const [isAiLoading, setIsAiLoading] = useState(false);
          const [chatHistory, setChatHistory] = useState([]);
          const [showChat, setShowChat] = useState(false);

          const [userInfo, setUserInfo] = useState(() => {
              const stored = localStorage.getItem('narrativeos-user-info');
              return stored ? JSON.parse(stored) : null;
          });

          const editorRef = useRef(null);
          const imageInputRef = useRef(null);
          
          // Sync filename with project name
          useEffect(() => {
              setFileName(projectName || 'Untitled Project');
          }, [projectName]);

          // Initialize Google Drive API
          useEffect(() => {
            const initGapi = () => {
                if (typeof gapi === 'undefined') {
                    setTimeout(initGapi, 500);
                    return;
                }
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: [DISCOVERY_DOC],
                        });
                        setGapiInited(true);
                    } catch (error) {
                        console.error("Error initializing GAPI client:", error);
                    }
                });
            };

            const initGis = () => {
                if (typeof google === 'undefined') {
                    setTimeout(initGis, 500);
                    return;
                }
                try {
                    const client = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: '', // defined later
                    });
                    setTokenClient(client);
                    setGisInited(true);
                } catch (error) {
                    console.error("Error initializing GIS client:", error);
                }
            };

            initGapi();
            initGis();
          }, []);
          
          // Check for existing token on mount
          useEffect(() => {
              if (gapiInited && gisInited) {
                  const token = gapi.client.getToken();
                  if (token && token.access_token) {
                      setIsConnectedToDrive(true);
                      localStorage.setItem('narrativeos-connected', 'true');
                      // Fetch user info if we have a token
                      gapi.client.drive.about.get({fields: 'user'}).then(resp => {
                          setUserInfo(resp.result.user);
                          localStorage.setItem('narrativeos-user-info', JSON.stringify(resp.result.user));
                      }).catch(err => {
                          console.error('Failed to fetch user info:', err);
                      });
                  }
              }
          }, [gapiInited, gisInited]);

          // Initialize Content
          useEffect(() => {
            if (initialContent) {
                if (editorRef.current) editorRef.current.innerHTML = initialContent;
                setContent(initialContent);
                updateStats(initialContent);
            }
          }, [initialContent]);

          // Auto-save
          useEffect(() => {
            const interval = setInterval(() => {
              if (isDirty) {
                setSyncStatus('syncing');
                
                // Save via callback
                if (onContentChange) {
                    onContentChange(content);
                }
                
                // Cloud Save
                if (isConnectedToDrive && driveFolderId) {
                    saveToDrive();
                } else {
                    setTimeout(() => {
                        setIsDirty(false);
                        setSyncStatus('saved');
                    }, 800);
                }
              }
            }, 5000); // Auto-save every 5s
            return () => clearInterval(interval);
          }, [content, isDirty, isConnectedToDrive, driveFolderId, onContentChange]);

          const handleConnectDrive = () => {
            if (CLIENT_ID === 'YOUR_CLIENT_ID_HERE' || API_KEY === 'YOUR_API_KEY_HERE') {
                alert('Please configure your Google Cloud CLIENT_ID and API_KEY in the code to enable Google Drive integration.');
                return;
            }
            if (!tokenClient) {
                alert('Google Sign-In client not initialized. Please check your internet connection or API keys.');
                return;
            }
            
            tokenClient.callback = async (resp) => {
              if (resp.error !== undefined) {
                throw (resp);
              }
              setIsConnectedToDrive(true);
              localStorage.setItem('narrativeos-connected', 'true');
              
              // Fetch user info to confirm identity
              try {
                  const about = await gapi.client.drive.about.get({fields: 'user'});
                  setUserInfo(about.result.user);
                  localStorage.setItem('narrativeos-user-info', JSON.stringify(about.result.user));
              } catch (e) {
                  console.error("Could not fetch user info", e);
              }

              await ensureProjectFolder();
            };

            if (gapi.client.getToken() === null) {
              tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
              tokenClient.requestAccessToken({prompt: ''});
            }
          };

          const ensureProjectFolder = async () => {
              try {
                  // Check if folder exists
                  const response = await gapi.client.drive.files.list({
                      q: "mimeType='application/vnd.google-apps.folder' and name='NarrativeOS Projects' and trashed=false",
                      fields: 'files(id, name)',
                  });
                  
                  let folderId;
                  if (response.result.files && response.result.files.length > 0) {
                      folderId = response.result.files[0].id;
                  } else {
                      // Create folder
                      const fileMetadata = {
                          'name': 'NarrativeOS Projects',
                          'mimeType': 'application/vnd.google-apps.folder'
                      };
                      const createResponse = await gapi.client.drive.files.create({
                          resource: fileMetadata,
                          fields: 'id'
                      });
                      folderId = createResponse.result.id;
                  }
                  setDriveFolderId(folderId);
                  localStorage.setItem('narrativeos-drive-folder', folderId);
                  setShowCloudModal(false);
                  setSyncStatus('saved');
                  alert('Connected to Google Drive! Folder "NarrativeOS Projects" ready.');
              } catch (err) {
                  console.error('Error creating/finding folder', err);
                  alert('Error connecting to Drive. Check console.');
              }
          };

          const saveToDrive = async () => {
              if (!driveFolderId) return;
              
              try {
                  // Get current full project from storage
                  const allProjects = ProjectStorage.getAllProjects();
                  const currentProjectData = allProjects.find(p => p.name === fileName);
                  
                  // Create JSON content with full project data
                  const projectData = currentProjectData || {
                      name: fileName,
                      content: content,
                      lastModified: Date.now()
                  };
                  
                  const fileContent = new Blob([JSON.stringify(projectData, null, 2)], {type: 'application/json'});
                  const metadata = {
                      'name': fileName + '.json',
                      'mimeType': 'application/json',
                      'parents': [driveFolderId],
                      'description': 'NarrativeOS Project Data'
                  };

                  if (driveFileId) {
                      // Update existing file
                      const form = new FormData();
                      const updateMetadata = { name: fileName + '.json' };
                      form.append('metadata', new Blob([JSON.stringify(updateMetadata)], {type: 'application/json'}));
                      form.append('file', fileContent);

                      const accessToken = gapi.client.getToken().access_token;

                      fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                          method: 'PATCH',
                          headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                          body: form
                      }).then((res) => res.json()).then((val) => {
                          console.log("Project updated:", val);
                          setIsDirty(false);
                          setSyncStatus('saved');
                      }).catch(err => {
                          console.error("Error updating file:", err);
                          setSyncStatus('error');
                      });
                  } else {
                      // Create file
                      const form = new FormData();
                      form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                      form.append('file', fileContent);

                      const accessToken = gapi.client.getToken().access_token;
                      
                      fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                          method: 'POST',
                          headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                          body: form
                      }).then((res) => res.json()).then((val) => {
                          setDriveFileId(val.id);
                          setIsDirty(false);
                          setSyncStatus('saved');
                      }).catch(err => {
                          console.error("Error creating file:", err);
                          setSyncStatus('error');
                      });
                  }
              } catch (err) {
                  console.error('Error saving to drive', err);
                  setSyncStatus('unsaved');
              }
          };

          const updateStats = (htmlContent) => {
            const text = htmlContent.replace(/<[^>]*>/g, ' ').trim();
            const w = text ? text.split(/\s+/).length : 0;
            const c = text.replace(/\s/g, '').length;
            setWordCount(w);
            setCharCount(c);
            if (onStatsUpdate) onStatsUpdate(w, c);
          };

          const handleInput = (e) => {
            const newContent = e.currentTarget.innerHTML;
            setContent(newContent);
            setIsDirty(true);
            setSyncStatus('unsaved');
            updateStats(newContent);
            
            // Extract and update title/subtitle if they exist
            const parser = new DOMParser();
            const doc = parser.parseFromString(newContent, 'text/html');
            const titleElement = doc.querySelector('[data-format="title"]');
            const subtitleElement = doc.querySelector('[data-format="subtitle"]');
            
            if (titleElement || subtitleElement) {
              const newTitle = titleElement ? titleElement.textContent.trim() : null;
              const newSubtitle = subtitleElement ? subtitleElement.textContent.trim() : null;
              
              // Notify parent to update chapter metadata
              if (onContentChange) {
                onContentChange(newContent, newTitle, newSubtitle);
              }
            }
          };

          const execCmd = (command, value = null) => {
            document.execCommand(command, false, value);
            if (editorRef.current) {
              setTimeout(() => editorRef.current.focus(), 0); 
            }
            if (editorRef.current) {
              handleInput({ currentTarget: editorRef.current });
            }
          };

          const handleInsertImage = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const imgHtml = `<img src="${e.target.result}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;" />`;
                execCmd('insertHTML', imgHtml);
              };
              reader.readAsDataURL(file);
            }
            e.target.value = null;
          };

          const handleInsertTable = () => {
            const rows = 3;
            const cols = 3;
            let tableHTML = '<table style="width:100%; border-collapse: collapse; margin: 1rem 0; border: 1px solid #e2e8f0;"><tbody>';
            for(let i=0; i<rows; i++){
                tableHTML += '<tr>';
                for(let j=0; j<cols; j++){
                    tableHTML += '<td style="border: 1px solid #e2e8f0; padding: 12px; min-width: 50px;">Cell</td>';
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table><p><br/></p>';
            execCmd('insertHTML', tableHTML);
          };

          const handleSaveLocal = () => {
            const blob = new Blob([`
              <!DOCTYPE html>
              <html>
              <head>
                <title>${fileName}</title>
                <style>
                  body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; line-height: 1.6; color: #333; }
                  table { width: 100%; border-collapse: collapse; }
                  td, th { border: 1px solid #ccc; padding: 8px; }
                  img { max-width: 100%; }
                </style>
              </head>
              <body>${content}</body>
              </html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.html`;
            a.click();
            URL.revokeObjectURL(url);
            setSyncStatus('saved');
          };

          const handleSaveTxt = () => {
             const text = editorRef.current.innerText;
             const blob = new Blob([text], { type: 'text/plain' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `${fileName}.txt`;
             a.click();
             URL.revokeObjectURL(url);
          };

          const handleOpenLocal = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const text = e.target.result;
                if (text.trim().startsWith('<')) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newContent = doc.body.innerHTML;
                    if (editorRef.current) editorRef.current.innerHTML = newContent;
                    setContent(newContent);
                    updateStats(newContent);
                } else {
                    const newContent = text.replace(/\n/g, '<br/>');
                    if (editorRef.current) editorRef.current.innerHTML = newContent;
                    setContent(newContent);
                    updateStats(newContent);
                }
                setFileName(file.name.replace(/\.[^/.]+$/, ""));
              };
              reader.readAsText(file);
            }
          };

          const handleFind = () => {
            if (window.find && findTerm) {
                window.find(findTerm);
            }
          };
          
          const getReadingTime = () => {
              const wordsPerMinute = 200;
              const minutes = Math.ceil(wordCount / wordsPerMinute);
              return minutes + ' min read';
          };

          // Render Visual Mode Overlay
          const renderVisualOverlay = () => {
              if (textMode === 'normal') return null;
              
              const text = editorRef.current ? editorRef.current.innerText : content.replace(/<[^>]*>/g, ' ');
              
              if (textMode === 'blind') {
                  return (
                      <div className="absolute inset-0 bg-white z-10 p-[25mm] font-serif text-lg leading-relaxed whitespace-pre-wrap pointer-events-none overflow-hidden">
                          <span className="blur-sm select-none opacity-50">{text.slice(0, -100)}</span>
                          <span className="blur-none">{text.slice(-100)}</span>
                      </div>
                  );
              }

              // Dialogue highlighting mode
              if (textMode === 'dialogue') {
                  const dialogueRegex = /([\"'])(.*?)\1|(".*?")/g;
                  const parts = [];
                  let lastIndex = 0;
                  let match;
                  
                  while ((match = dialogueRegex.exec(text)) !== null) {
                      if (match.index > lastIndex) {
                          parts.push({ text: text.slice(lastIndex, match.index), isDialogue: false });
                      }
                      parts.push({ text: match[0], isDialogue: true });
                      lastIndex = match.index + match[0].length;
                  }
                  if (lastIndex < text.length) {
                      parts.push({ text: text.slice(lastIndex), isDialogue: false });
                  }
                  
                  return (
                      <div className="absolute inset-0 bg-white z-10 p-[25mm] font-serif text-lg leading-relaxed whitespace-pre-wrap pointer-events-none overflow-y-auto">
                          {parts.map((part, i) => (
                              <span key={i} className={part.isDialogue ? 'bg-cyan-400/30 border-l-4 border-cyan-500 pl-1 font-medium text-cyan-900' : ''}>
                                  {part.text}
                              </span>
                          ))}
                      </div>
                  );
              }
              
              const sentences = text.split(/(?<=[.!?])\s+/);
              return (
                  <div className="absolute inset-0 bg-white z-10 p-[25mm] font-serif text-lg leading-relaxed whitespace-pre-wrap pointer-events-none overflow-y-auto">
                      {sentences.map((s, i) => {
                          let className = "";
                          if (textMode === 'rhythm') {
                              const wc = s.split(' ').length;
                              if (wc < 8) className = "bg-emerald-500/20 border-b-2 border-emerald-500/50";
                              else if (wc > 25) className = "bg-red-500/20 border-b-2 border-red-500/50";
                              else className = "bg-yellow-500/20 border-b-2 border-yellow-500/50";
                          } else if (textMode === 'hemingway') {
                              if (s.includes('ly')) className = "bg-blue-500/20 text-blue-200";
                              if (s.includes('was') || s.includes('were')) className = "bg-pink-500/20 text-pink-200";
                          }
                          return <span key={i} className={`rounded px-0.5 ${className}`}>{s} </span>
                      })}
                  </div>
              );
          };

          const handleAiSubmit = async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!aiPrompt.trim()) return;
                
                if (aiProvider === 'gemini' && !geminiApiKey) {
                    alert('Please enter your Google Gemini API Key first.');
                    return;
                }
                if (aiProvider === 'huggingface' && !hfToken) {
                    alert('Please enter your Hugging Face Token first.');
                    return;
                }
                if (aiProvider === 'github' && !githubToken) {
                    alert('Please enter your GitHub Personal Access Token first.');
                    return;
                }

                const userMessage = { role: 'user', text: aiPrompt };
                setChatHistory(prev => [...prev, userMessage]);
                setAiPrompt('');
                setIsAiLoading(true);

                try {
                    let aiText = "";

                    if (aiProvider === 'gemini') {
                        // Handle model name format (ensure it starts with models/)
                        const modelPath = selectedModel.startsWith('models/') ? selectedModel : `models/${selectedModel}`;
                        
                        // Construct history for API
                        const contents = chatHistory.map(msg => ({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.text }]
                        }));
                        
                        // Add current prompt
                        contents.push({
                            role: 'user',
                            parts: [{ text: `Context: The user is writing a story. Here is the current content: ${content.substring(0, 5000)}... (truncated). 
                            
                            Task: ${userMessage.text}` }]
                        });

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${modelPath}:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ contents })
                        });

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message);
                        }

                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            aiText = data.candidates[0].content.parts[0].text;
                        }
                    } else if (aiProvider === 'github') {
                        // GitHub Models (Azure AI Inference)
                        const messages = [
                            { role: "system", content: `You are a creative writing assistant. Context: ${content.substring(0, 2000)}...` },
                            ...chatHistory.map(msg => ({ role: msg.role === 'model' ? 'assistant' : 'user', content: msg.text })),
                            { role: "user", content: userMessage.text }
                        ];

                        const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${githubToken}`
                            },
                            body: JSON.stringify({
                                messages: messages,
                                model: githubModel,
                                temperature: 0.7,
                                max_tokens: 1000
                            })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`GitHub Models Error ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        aiText = data.choices[0].message.content;

                    } else {
                        // Hugging Face
                        const promptText = `[INST] You are a creative writing assistant. Context: ${content.substring(0, 2000)}... Task: ${userMessage.text} [/INST]`;
                        
                        try {
                            // Helper function for retrying with delay
                            const fetchWithRetry = async (retries = 5) => {
                                const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
                                    method: "POST",
                                    headers: {
                                        "Authorization": `Bearer ${hfToken}`,
                                        "Content-Type": "application/json",
                                        "x-use-cache": "false"
                                    },
                                    body: JSON.stringify({ 
                                        inputs: promptText,
                                        parameters: {
                                            max_new_tokens: 500,
                                            return_full_text: false,
                                            temperature: 0.7
                                        }
                                    }),
                                });

                                if (response.status === 503) {
                                    const data = await response.json();
                                    if (retries > 0 && data.estimated_time) {
                                        console.log(`Model loading... waiting ${data.estimated_time}s`);
                                        await new Promise(r => setTimeout(r, (data.estimated_time * 1000) + 1000));
                                        return fetchWithRetry(retries - 1);
                                    }
                                }

                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`HF Error ${response.status}: ${errorText}`);
                                }

                                return response.json();
                            };

                            const result = await fetchWithRetry();
                            
                            if (result.error) throw new Error(result.error);
                            aiText = Array.isArray(result) ? result[0].generated_text : result.generated_text;
                            
                            // Clean up [INST] tags if model returns them
                            aiText = aiText.replace(/\[INST\].*?\[\/INST\]/s, '').trim();

                        } catch (hfErr) {
                            console.error("Hugging Face Fetch Error:", hfErr);
                            if (hfErr.message.includes('Failed to fetch')) {
                                throw new Error(`CORS/Network Error. Hugging Face blocked the browser request. Please try using Gemini (Google) which works reliably in the browser, or check the README for the CORS extension workaround.`);
                            }
                            throw new Error(`Failed to connect to Hugging Face. ${hfErr.message}.`);
                        }
                    }

                    setChatHistory(prev => [...prev, { role: 'model', text: aiText }]);

                } catch (error) {
                    console.error('AI Error:', error);
                    setChatHistory(prev => [...prev, { role: 'model', text: `Error: ${error.message}` }]);
                } finally {
                    setIsAiLoading(false);
                }
            }
          };



          return (
            <div className="flex flex-col h-full overflow-hidden font-sans text-slate-800 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 selection:bg-purple-500/30 selection:text-white">
              
              {/* --- Glassy Header --- */}
              {!focusMode && (
              <div className="flex items-center justify-between px-6 py-3 bg-black/20 backdrop-blur-md border-b border-white/5 shadow-sm z-20">
                <div className="flex items-center space-x-4">
                  <div className="bg-gradient-to-br from-purple-600 to-indigo-700 p-2.5 rounded-xl shadow-lg shadow-black/20">
                    <FileText className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <input 
                      type="text" 
                      value={fileName} 
                      onChange={(e) => setFileName(e.target.value)}
                      className="text-lg font-bold text-gray-200 placeholder-gray-500 border-b-2 border-transparent hover:border-gray-500 focus:border-purple-500 focus:outline-none bg-transparent transition-all truncate w-48 sm:w-64"
                    />
                    <div className="flex items-center space-x-3 text-xs font-medium text-gray-400 mt-1">
                      <button className="hover:text-white transition-colors">File</button>
                      <button className="hover:text-white transition-colors">Edit</button>
                      <button className="hover:text-white transition-colors">View</button>
                      <button className="hover:text-white transition-colors">Insert</button>
                    </div>
                  </div>
                </div>

                <div className="flex items-center space-x-4">
                  {/* Narrative Tools */}
                  <div className="flex items-center bg-black/30 rounded-full p-1 border border-white/5 mr-4">
                      <button 
                          onClick={() => {
                              if (textMode === 'normal') setTextMode('rhythm');
                              else if (textMode === 'rhythm') setTextMode('dialogue');
                              else setTextMode('normal');
                          }}
                          className={`p-2 rounded-full transition-all ${textMode === 'rhythm' ? 'bg-indigo-600 text-white' : textMode === 'dialogue' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white'}`}
                          title={textMode === 'normal' ? 'Enable Rhythm Mode' : textMode === 'rhythm' ? 'Enable Dialogue Mode' : 'Disable Visual Mode'}
                      >
                          <BarChart2 className="w-4 h-4" />
                      </button>
                      <button 
                          onClick={() => setAmbientSound(ambientSound === 'rain' ? null : 'rain')}
                          className={`p-2 rounded-full transition-all ${ambientSound === 'rain' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                          title="Ambient Sound"
                      >
                          <Cloud className="w-4 h-4" />
                      </button>
                      <button 
                          onClick={() => setSplitScreen(!splitScreen)}
                          className={`p-2 rounded-full transition-all ${splitScreen ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}`}
                          title="Split Screen"
                      >
                          <Layout className="w-4 h-4" />
                      </button>
                  </div>

                  <div className="hidden md:flex items-center text-xs font-medium mr-2 bg-black/30 text-gray-300 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-md">
                    {syncStatus === 'syncing' && (
                      <span className="flex items-center animate-pulse text-blue-400">
                        <CloudLightning className="w-3 h-3 mr-1.5" /> Syncing...
                      </span>
                    )}
                    {syncStatus === 'saved' && (
                      <span className="flex items-center text-emerald-400">
                        <Check className="w-3 h-3 mr-1.5" /> Saved locally
                      </span>
                    )}
                    {syncStatus === 'unsaved' && (
                      <span className="text-amber-400">Unsaved changes</span>
                    )}
                  </div>

                  <button 
                    onClick={() => setShowCloudModal(true)}
                    className={`flex items-center space-x-2 px-4 py-2 rounded-full text-sm font-semibold transition-all shadow-lg ${
                      isConnectedToDrive 
                        ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30 hover:bg-emerald-500/30' 
                        : 'bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 hover:text-white'
                    }`}
                  >
                    <Cloud className="w-4 h-4" />
                    <span className="hidden sm:inline">{isConnectedToDrive ? 'Synced' : 'Connect'}</span>
                  </button>
                  
                  <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-purple-500 to-indigo-500 text-white flex items-center justify-center text-sm font-bold shadow-md ring-2 ring-white/10 cursor-pointer hover:scale-105 transition-transform" title={userInfo ? `Signed in as ${userInfo.displayName} (${userInfo.emailAddress})` : 'Not signed in'}>
                    {userInfo ? (userInfo.photoLink ? <img src={userInfo.photoLink} className="w-full h-full rounded-full" alt="User" /> : userInfo.displayName.charAt(0)) : 'USER'}
                  </div>
                </div>
              </div>
              )}

              {/* --- Glassy Toolbar --- */}
              {!focusMode && (
              <div className="flex items-center px-6 py-2 bg-black/20 backdrop-blur-md border-b border-white/5 overflow-x-auto gap-2 shadow-sm z-10 no-scrollbar">
                
                <div className="flex items-center space-x-1 pr-2">
                  <IconButton onClick={() => execCmd('undo')} icon={Undo} tooltip="Undo" />
                  <IconButton onClick={() => execCmd('redo')} icon={Redo} tooltip="Redo" />
                  <IconButton onClick={() => window.print()} icon={Printer} tooltip="Print" />
                </div>

                <Divider />

                <div className="flex items-center space-x-2 pr-2 pl-2">
                  <div className="relative group">
                     <select 
                       onChange={(e) => {
                         const value = e.target.value;
                         if (value === 'title' || value === 'subtitle') {
                           // Mark as special format
                           execCmd('formatBlock', 'p');
                           const selection = window.getSelection();
                           if (selection.rangeCount > 0) {
                             const range = selection.getRangeAt(0);
                             const container = range.commonAncestorContainer;
                             const element = container.nodeType === 3 ? container.parentNode : container;
                             element.setAttribute('data-format', value);
                             if (value === 'title') {
                               element.style.fontSize = '2rem';
                               element.style.fontWeight = 'bold';
                               element.style.color = '#1e293b';
                               element.style.marginBottom = '0.5rem';
                             } else if (value === 'subtitle') {
                               element.style.fontSize = '1.25rem';
                               element.style.fontStyle = 'italic';
                               element.style.color = '#64748b';
                               element.style.marginBottom = '1rem';
                             }
                           }
                         } else {
                           execCmd('formatBlock', value);
                         }
                         e.target.value = 'div'; // Reset to Normal
                       }}
                       className="appearance-none h-9 pl-3 pr-8 bg-white/5 border border-white/10 rounded-xl text-sm font-medium text-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-white/10 transition-colors cursor-pointer w-28 backdrop-blur-sm"
                       onMouseDown={(e) => e.stopPropagation()}
                     >
                      <option value="div" className="bg-gray-800">Normal</option>
                      <option value="title" className="bg-gray-800">Title</option>
                      <option value="subtitle" className="bg-gray-800">Subtitle</option>
                      <option value="h1" className="bg-gray-800">Heading 1</option>
                      <option value="h2" className="bg-gray-800">Heading 2</option>
                      <option value="h3" className="bg-gray-800">Heading 3</option>
                      <option value="blockquote" className="bg-gray-800">Quote</option>
                    </select>
                  </div>
                  
                  <select 
                    onChange={(e) => execCmd('fontName', e.target.value)} 
                    className="appearance-none h-9 pl-3 pr-8 bg-white/5 border border-white/10 rounded-xl text-sm font-medium text-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-white/10 transition-colors cursor-pointer w-32 backdrop-blur-sm"
                  >
                    <option value="ui-sans-serif, system-ui, sans-serif" className="bg-gray-800">Sans Serif</option>
                    <option value="ui-serif, Georgia, serif" className="bg-gray-800">Serif</option>
                    <option value="ui-monospace, SFMono-Regular, monospace" className="bg-gray-800">Monospace</option>
                    <option value="Comic Sans MS" className="bg-gray-800">Comic Sans</option>
                  </select>
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pr-2 pl-2">
                  <IconButton onClick={() => execCmd('bold')} icon={Bold} tooltip="Bold" />
                  <IconButton onClick={() => execCmd('italic')} icon={Italic} tooltip="Italic" />
                  <IconButton onClick={() => execCmd('underline')} icon={Underline} tooltip="Underline" />
                  <IconButton onClick={() => execCmd('strikeThrough')} icon={Strikethrough} tooltip="Strikethrough" />
                  
                  <div className="relative flex items-center justify-center mx-1 group">
                    <label className="cursor-pointer flex items-center justify-center p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent transition-colors" title="Text Color">
                      <Palette className="w-4 h-4 text-gray-400 hover:text-white" />
                      <input 
                        type="color" 
                        className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                        onChange={(e) => execCmd('foreColor', e.target.value)}
                      />
                    </label>
                  </div>
                  <div className="relative flex items-center justify-center mx-1 group">
                    <label className="cursor-pointer flex items-center justify-center p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent transition-colors" title="Highlight Color">
                      <Highlighter className="w-4 h-4 text-gray-400 hover:text-white" />
                      <input 
                        type="color" 
                        defaultValue="#ffff00"
                        className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                        onChange={(e) => execCmd('hiliteColor', e.target.value)}
                      />
                    </label>
                  </div>
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pr-2 pl-2">
                  <IconButton onClick={() => execCmd('justifyLeft')} icon={AlignLeft} tooltip="Left" />
                  <IconButton onClick={() => execCmd('justifyCenter')} icon={AlignCenter} tooltip="Center" />
                  <IconButton onClick={() => execCmd('justifyRight')} icon={AlignRight} tooltip="Right" />
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pr-2 pl-2">
                  <IconButton onClick={() => execCmd('insertUnorderedList')} icon={List} tooltip="Bullet List" />
                  <IconButton onClick={() => execCmd('insertOrderedList')} icon={ListOrdered} tooltip="Number List" />
                  <IconButton onClick={() => execCmd('indent')} icon={Indent} tooltip="Indent" />
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pl-2">
                  <IconButton onClick={() => {
                     const url = prompt('Enter URL:');
                     if(url) execCmd('createLink', url);
                  }} icon={LinkIcon} tooltip="Link" />
                  
                  <Tooltip text="Upload Image">
                    <label className="p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent text-gray-400 hover:text-white cursor-pointer transition-colors block">
                      <ImageIcon className="w-4 h-4" />
                      <input 
                        type="file" 
                        accept="image/*" 
                        className="hidden" 
                        ref={imageInputRef}
                        onChange={handleInsertImage}
                      />
                    </label>
                  </Tooltip>

                  <IconButton onClick={handleInsertTable} icon={TableIcon} tooltip="Table" />
                  
                  <div className="w-px h-6 bg-white/10 mx-2"></div>
                  
                  <Tooltip text="Open File">
                    <label className="p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent text-gray-400 hover:text-white cursor-pointer transition-colors block">
                      <FileUp className="w-4 h-4" />
                      <input type="file" className="hidden" accept=".html,.txt" onChange={handleOpenLocal} />
                    </label>
                  </Tooltip>
                  
                  <IconButton onClick={handleSaveLocal} icon={Save} tooltip="Save HTML" />
                  <IconButton onClick={handleSaveTxt} icon={FileDown} tooltip="Save TXT" />

                  <div className="w-px h-6 bg-white/10 mx-2"></div>
                  
                  <IconButton onClick={() => setShowFind(!showFind)} active={showFind} icon={Search} tooltip="Find" />
                  <IconButton onClick={() => setFocusMode(!focusMode)} active={focusMode} icon={Maximize} tooltip="Focus Mode" />

                </div>
              </div>
              )}

              {/* --- Find Bar --- */}
              {showFind && !focusMode && (
                <div className="flex items-center px-6 py-2 bg-gray-800/80 backdrop-blur-xl border-b border-white/10 shadow-inner z-10 animate-in slide-in-from-top-2">
                    <span className="text-sm font-medium text-gray-300 mr-2">Find:</span>
                    <input 
                        type="text" 
                        value={findTerm}
                        onChange={(e) => setFindTerm(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleFind()}
                        className="h-8 px-3 rounded-lg bg-black/40 border border-white/10 text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 w-64 mr-2 placeholder-gray-500"
                        placeholder="Type and press Enter..."
                        autoFocus
                    />
                    <button onClick={handleFind} className="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700">Next</button>
                    <button onClick={() => setShowFind(false)} className="ml-2 text-gray-400 hover:text-white text-sm">Close</button>
                </div>
              )}

              {/* --- Main Editor Area --- */}
              <div className="flex-1 flex overflow-hidden">
                  <div 
                    className="flex-1 overflow-y-auto cursor-text p-8 md:p-12 relative"
                    onClick={() => editorRef.current?.focus()}
                  >
                    <div className="max-w-[210mm] mx-auto transition-transform duration-500 ease-out relative">
                    {focusMode && (
                        <div className="fixed top-4 right-8 z-50 group">
                            <button 
                                onClick={() => setFocusMode(false)}
                                className="bg-black/40 hover:bg-black/60 text-white p-2 rounded-full backdrop-blur-sm transition-colors border border-white/10"
                            >
                                <Minimize className="w-5 h-5" />
                            </button>
                            <span className="absolute right-full mr-2 top-1.5 text-xs text-white bg-black/50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Exit Focus</span>
                        </div>
                    )}
                  
                  {/* The Page */}
                  <div 
                    className={`bg-white min-h-[297mm] p-[25mm] shadow-2xl rounded-sm ring-1 ring-black/5 transition-all duration-700 relative ${focusMode ? 'scale-105 shadow-[0_0_100px_rgba(0,0,0,0.5)]' : ''}`}
                    style={{ width: '100%' }}
                  >
                        {/* Visual Mode Overlay */}
                        {renderVisualOverlay()}
                        
                        {/* Sign-in Overlay */}
                        {!isConnectedToDrive && (
                          <div className="absolute inset-0 bg-white/95 backdrop-blur-sm z-20 flex items-center justify-center">
                            <div className="text-center max-w-md p-8">
                              <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <Cloud className="w-8 h-8 text-white" />
                              </div>
                              <h2 className="text-2xl font-bold text-gray-900 mb-3">Sign in to Start Writing</h2>
                              <p className="text-gray-600 mb-6">Connect your Google Drive to save your work securely and access it from anywhere.</p>
                              <button 
                                onClick={handleConnectDrive}
                                className="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl font-semibold shadow-lg transition-all hover:scale-105 flex items-center gap-2 mx-auto"
                              >
                                <Cloud className="w-5 h-5" />
                                Sign in with Google
                              </button>
                            </div>
                          </div>
                        )}
                    <div
                      ref={editorRef}
                      contentEditable={isConnectedToDrive}
                      suppressContentEditableWarning
                      className="outline-none min-h-full text-base leading-relaxed text-left text-black empty:before:content-[attr(placeholder)] empty:before:text-slate-400 selection:bg-purple-200 selection:text-purple-900"
                      onInput={handleInput}
                      spellCheck={true}
                      placeholder="Type something amazing..."
                      style={{
                        color: 'inherit'
                      }}
                    />
                  </div>
                  
                  <div className="h-24 text-center text-white/20 text-sm font-medium py-8 italic">
                     End of Document
                  </div>
                </div>
              </div>

                  {/* Split Pane (Context) */}
                  {splitScreen && (
                        <div className="w-[400px] border-l border-slate-800 bg-[#0f1116] flex flex-col animate-in slide-in-from-right-10 z-30">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Contextual Reference</h3>
                            <button onClick={() => setSplitScreen(false)}><Minimize2 className="w-3 h-3 text-slate-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {/* Auto-detected Entity Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800 hover:border-indigo-500/50 transition-colors cursor-pointer group">
                                <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">K</div>
                                <div>
                                    <div className="font-bold text-slate-200 group-hover:text-indigo-400 transition-colors">Kael</div>
                                    <div className="text-xs text-slate-500">Protagonist  Mercenary</div>
                                </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-3">
                                    <div className="bg-slate-950 p-2 rounded">AGE: 32</div>
                                    <div className="bg-slate-950 p-2 rounded">EYES: Cybernetic</div>
                                </div>
                                <p className="text-sm text-slate-400 leading-snug">
                                <span className="text-indigo-400 font-bold">Goal:</span> Secure credits for optic repair.<br/>
                                <span className="text-indigo-400 font-bold">Lie:</span> "I don't need anyone."
                                </p>
                            </div>

                            {/* Location Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                <div className="flex items-center gap-2 mb-2">
                                <Map className="w-4 h-4 text-emerald-500" />
                                <span className="font-bold text-slate-200">Sector 7 Docks</span>
                                </div>
                                <div className="h-32 bg-slate-950 rounded mb-2 overflow-hidden relative group border border-slate-800">
                                    {/* Mock Map */}
                                    <svg className="w-full h-full opacity-50" viewBox="0 0 100 100">
                                        <rect width="100" height="100" fill="#0f172a" />
                                        <path d="M 20 20 L 40 40 L 80 20" stroke="#334155" fill="none" />
                                        <circle cx="40" cy="40" r="3" fill="#10b981" />
                                        <text x="45" y="42" fill="white" fontSize="5">You Are Here</text>
                                    </svg>
                                </div>
                                <p className="text-xs text-slate-500">
                                    Atmosphere: Rain, Neon, Industrial Decay.<br/>
                                    Sensory: Smell of ozone and rotting fish.
                                </p>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* AI FAB */}
                    {!focusMode && (
                        <div className="absolute bottom-8 right-8 z-30">
                        <button 
                            onClick={() => setShowAiPanel(true)}
                            className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-full shadow-[0_0_20px_rgba(79,70,229,0.5)] flex items-center justify-center text-white transition-transform hover:scale-110 active:scale-95"
                            title="AI Creative Assistant"
                        >
                            <Zap className="w-6 h-6" />
                        </button>
                        </div>
                    )}

                    {/* AI MODAL */}
                    {showAiPanel && (
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-end">
                            <div className="w-[450px] h-full bg-purple-900/20 backdrop-blur-xl border-l border-white/10 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                                <div className="p-6 border-b border-white/10 flex justify-between items-center bg-purple-900/30">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2"><Zap className="w-5 h-5 text-purple-400" /> Creative Assistant</h2>
                                    <button onClick={() => setShowAiPanel(false)} className="text-slate-400 hover:text-white"><Minimize2 className="w-4 h-4" /></button>
                                </div>
                                
                                {/* Chat History Area */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
                                    {chatHistory.length === 0 && (
                                        <div className="text-center text-slate-400 mt-10">
                                            <Zap className="w-12 h-12 mx-auto mb-4 opacity-20" />
                                            <p>Ask me anything about your story.</p>
                                            <p className="text-xs mt-2 opacity-50">I can read your current chapter context.</p>
                                        </div>
                                    )}
                                    {chatHistory.map((msg, idx) => (
                                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] rounded-2xl p-3 text-sm whitespace-pre-wrap ${
                                                msg.role === 'user' 
                                                    ? 'bg-indigo-600 text-white rounded-br-none' 
                                                    : 'bg-slate-800/80 text-slate-200 rounded-bl-none border border-white/5'
                                            }`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    {isAiLoading && (
                                        <div className="flex justify-start">
                                            <div className="bg-slate-800/80 rounded-2xl p-3 rounded-bl-none border border-white/5">
                                                <div className="flex gap-1">
                                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 border-t border-white/10 bg-purple-900/30">
                                    {/* Provider Selector */}
                                    <div className="flex justify-between items-center mb-3 px-1">
                                        <span className="text-[10px] text-slate-400 uppercase font-bold">Provider</span>
                                        <select 
                                            value={aiProvider}
                                            onChange={(e) => {
                                                setAiProvider(e.target.value);
                                                localStorage.setItem('narrativeos-ai-provider', e.target.value);
                                            }}
                                            className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none font-bold"
                                        >
                                            <option value="gemini" className="bg-slate-900 text-slate-300">Google Gemini</option>
                                            <option value="huggingface" className="bg-slate-900 text-slate-300">Hugging Face (Open Source)</option>
                                            <option value="github" className="bg-slate-900 text-slate-300">GitHub Models (Azure AI)</option>
                                        </select>
                                    </div>

                                    {/* Gemini Configuration */}
                                    {aiProvider === 'gemini' && (
                                        <>
                                            {!geminiApiKey ? (
                                                <div className="space-y-2 mb-3">
                                                    <p className="text-xs text-slate-300">Enter your Google Gemini API Key (Free):</p>
                                                    <input 
                                                        type="password" 
                                                        placeholder="Paste API Key here..." 
                                                        className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-purple-500"
                                                        onChange={(e) => {
                                                            setGeminiApiKey(e.target.value);
                                                            localStorage.setItem('gemini-api-key', e.target.value);
                                                        }}
                                                    />
                                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-purple-300 hover:underline block">Get a free API key here</a>
                                                </div>
                                            ) : (
                                                availableModels.length > 0 && (
                                                    <div className="flex justify-between items-center px-1 mb-3">
                                                        <span className="text-[10px] text-slate-400 uppercase font-bold">Model</span>
                                                        <select 
                                                            value={selectedModel}
                                                            onChange={(e) => {
                                                                setSelectedModel(e.target.value);
                                                                localStorage.setItem('gemini-model', e.target.value);
                                                            }}
                                                            className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none"
                                                        >
                                                            {availableModels.map(model => (
                                                                <option key={model.name} value={model.name} className="bg-slate-900 text-slate-300">
                                                                    {model.displayName || model.name.replace('models/', '')}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                )
                                            )}
                                        </>
                                    )}

                                    {/* Hugging Face Configuration */}
                                    {aiProvider === 'huggingface' && (
                                        <>
                                            {!hfToken ? (
                                                <div className="space-y-2 mb-3">
                                                    <p className="text-xs text-slate-300">Enter your Hugging Face Token:</p>
                                                    <input 
                                                        type="password" 
                                                        placeholder="Paste HF Token here..." 
                                                        className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-purple-500"
                                                        onChange={(e) => {
                                                            setHfToken(e.target.value);
                                                            localStorage.setItem('hf-token', e.target.value);
                                                        }}
                                                    />
                                                    <a href="https://huggingface.co/settings/tokens" target="_blank" className="text-xs text-purple-300 hover:underline block">Get a free token here</a>
                                                </div>
                                            ) : (
                                                <div className="flex justify-between items-center px-1 mb-3">
                                                    <span className="text-[10px] text-slate-400 uppercase font-bold">Model</span>
                                                    <select 
                                                        value={hfModel}
                                                        onChange={(e) => {
                                                            setHfModel(e.target.value);
                                                            localStorage.setItem('hf-model', e.target.value);
                                                        }}
                                                        className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none"
                                                    >
                                                        {HF_MODELS.map(model => (
                                                            <option key={model.id} value={model.id} className="bg-slate-900 text-slate-300">
                                                                {model.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {/* GitHub Models Settings */}
                                    {aiProvider === 'github' && (
                                        <>
                                            {!githubToken ? (
                                                <div className="space-y-2 mb-3">
                                                    <input 
                                                        type="password" 
                                                        placeholder="Enter GitHub Personal Access Token" 
                                                        className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-purple-500"
                                                        onChange={(e) => {
                                                            setGithubToken(e.target.value);
                                                            localStorage.setItem('github-token', e.target.value);
                                                        }}
                                                    />
                                                    <a href="https://github.com/settings/tokens" target="_blank" className="text-xs text-purple-300 hover:underline block">Get a token here (Classic, No scopes needed)</a>
                                                </div>
                                            ) : (
                                                <div className="flex justify-between items-center px-1 mb-3">
                                                    <span className="text-[10px] text-slate-400 uppercase font-bold">Model</span>
                                                    <select 
                                                        value={githubModel}
                                                        onChange={(e) => {
                                                            setGithubModel(e.target.value);
                                                            localStorage.setItem('github-model', e.target.value);
                                                        }}
                                                        className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none"
                                                    >
                                                        {GITHUB_MODELS.map(model => (
                                                            <option key={model.id} value={model.id} className="bg-slate-900 text-slate-300">
                                                                {model.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    <div className="relative">
                                        <input 
                                            type="text" 
                                            value={aiPrompt}
                                            onChange={(e) => setAiPrompt(e.target.value)}
                                            onKeyDown={handleAiSubmit}
                                            disabled={isAiLoading}
                                            placeholder={isAiLoading ? "AI is thinking..." : "Ask AI..."} 
                                            className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500/50 disabled:opacity-50 placeholder-slate-500" 
                                        />
                                        <button 
                                            onClick={() => handleAiSubmit({ key: 'Enter', preventDefault: () => {} })}
                                            className="absolute right-2 top-2 p-1 text-purple-400 hover:text-white transition-colors"
                                        >
                                            <Zap className="w-4 h-4" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
              </div>

              {/* --- Footer / Status Bar --- */}
              {!focusMode && (
              <div className="bg-black/20 backdrop-blur-md border-t border-white/5 px-6 py-2 flex justify-between items-center text-xs font-medium text-gray-400 z-20">
                 <div className="flex space-x-6">
                   <span className="hover:text-white transition-colors cursor-pointer">Page 1 of 1</span>
                   <span className="hover:text-white transition-colors cursor-pointer">{wordCount} words</span>
                   <span className="hover:text-white transition-colors cursor-pointer">{charCount} chars</span>
                   <span className="flex items-center hover:text-white transition-colors cursor-pointer"><Clock className="w-3 h-3 mr-1"/> {getReadingTime()}</span>
                 </div>
                 <div className="flex items-center space-x-3">
                   <div className="w-32 bg-white/10 rounded-full h-1.5 overflow-hidden">
                     <div className="bg-purple-500 w-full h-1.5 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)]"></div>
                   </div>
                   <span className="text-gray-300 font-bold drop-shadow-md">100%</span>
                 </div>
              </div>
              )}

              {/* --- Modern Glass Modal --- */}
              {showCloudModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 animate-in fade-in duration-200">
                  <div className="bg-gray-900/90 backdrop-blur-2xl rounded-3xl shadow-2xl w-full max-w-md p-8 border border-white/10 transform transition-all scale-100 ring-1 ring-white/10">
                    <div className="flex items-center justify-between mb-6">
                      <div className="flex items-center space-x-3">
                         <div className="bg-purple-500/20 p-2 rounded-xl shadow-inner border border-purple-500/20">
                            <Cloud className="w-6 h-6 text-purple-400" />
                         </div>
                         <h3 className="text-xl font-bold text-white">Sync Settings</h3>
                      </div>
                      <button 
                        onClick={() => setShowCloudModal(false)} 
                        className="text-gray-500 hover:text-white p-1 hover:bg-white/10 rounded-full transition-colors"
                      >
                        <MoreVertical className="w-5 h-5" />
                      </button>
                    </div>
                    
                    <p className="text-gray-400 mb-8 leading-relaxed">
                      This application connects directly to <strong>your personal Google Drive</strong>. 
                      Your work is saved to a folder named 'NarrativeOS Projects' in your own cloud storage.
                      <br/><br/>
                      <span className="text-xs text-gray-500">Privacy Note: No data is sent to any external servers. The app only has access to files it creates.</span>
                      <br/>
                      <span className="text-xs text-yellow-500">Dev Note: You must configure CLIENT_ID and API_KEY in the code for this to work.</span>
                    </p>

                    {!isConnectedToDrive ? (
                      <div className="space-y-4">
                         <button 
                          onClick={handleConnectDrive}
                          className="w-full py-3 px-4 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-purple-900/50 transition-all hover:scale-[1.02] flex justify-center items-center group"
                         >
                           <span className="group-hover:animate-pulse mr-2"></span> Connect Account
                         </button>
                         <p className="text-xs text-center text-gray-500">
                           Secured by standard OAuth 2.0 protocols.
                         </p>
                      </div>
                    ) : (
                       <div className="text-center py-6 bg-emerald-900/20 rounded-xl border border-emerald-500/20">
                         <div className="mx-auto w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mb-4 shadow-sm border border-emerald-500/20">
                            <Check className="w-8 h-8 text-emerald-400" />
                         </div>
                         <p className="text-lg font-bold text-white">Sync Active</p>
                         {userInfo && <p className="text-sm text-emerald-300 mt-1">Connected as {userInfo.displayName}</p>}
                         <p className="text-sm text-gray-400 mt-1">Folder: NarrativeOS Projects</p>
                         <button 
                           onClick={() => { 
                               setIsConnectedToDrive(false); 
                               setUserInfo(null); 
                               setShowCloudModal(false);
                               localStorage.removeItem('narrativeos-connected');
                               localStorage.removeItem('narrativeos-user-info');
                               localStorage.removeItem('narrativeos-drive-folder');
                               // Revoke token
                               const token = gapi.client.getToken();
                               if (token !== null) {
                                   google.accounts.oauth2.revoke(token.access_token);
                                   gapi.client.setToken('');
                               }
                           }}
                           className="mt-6 text-rose-400 text-sm font-semibold hover:text-rose-300 transition-colors"
                         >
                           Disconnect Account
                         </button>
                       </div>
                    )}
                  </div>
                </div>
              )}

            </div>
          );
        }

        // --- MAIN APPLICATION ---

        const WorldView = ({
            currentProject,
            setCurrentProject,
            relationships,
            setRelationships,
            relationshipTimeline,
            setRelationshipTimeline,
            timelineIndex,
            setTimelineIndex,
            showRelationshipEditor,
            setShowRelationshipEditor,
            aiProvider,
            selectedModel,
            hfModel,
            githubModel,
            availableModels,
            HF_MODELS,
            GITHUB_MODELS,
            setSelectedModel,
            setHfModel,
            setGithubModel,
            analyzeRelationships,
            isAiLoading,
            analysisScope,
            setAnalysisScope
        }) => {
            // Icons are imported at the top level

            if (!currentProject) return null;
            
            const characters = currentProject.characters || [];
            const hasCharacters = characters.length > 0;

            // --- Force Directed Graph Logic ---
            const [nodes, setNodes] = useState([]);
            const [links, setLinks] = useState([]);

            useEffect(() => {
                if (relationships.length > 0) {
                    // 1. Extract unique nodes from relationships
                    const uniqueNames = new Set();
                    relationships.forEach(r => {
                        uniqueNames.add(r.source);
                        uniqueNames.add(r.target);
                    });
                    
                    // Create node objects
                    const newNodes = Array.from(uniqueNames).map((name, i) => ({
                        id: name,
                        x: Math.random() * 800,
                        y: Math.random() * 600,
                        vx: 0,
                        vy: 0,
                        color: `hsl(${Math.random() * 360}, 70%, 60%)`
                    }));

                    // Create link objects
                    const newLinks = relationships.map(r => ({
                        source: r.source,
                        target: r.target,
                        type: r.type,
                        strength: r.strength || 1
                    }));

                    setNodes(newNodes);
                    setLinks(newLinks);
                }
            }, [relationships]);

            // Simple Force Simulation Loop
            useEffect(() => {
                if (nodes.length === 0) return;

                let animationFrameId;
                
                const simulate = () => {
                    setNodes(prevNodes => {
                        const nextNodes = prevNodes.map(n => ({ ...n })); // Deep copy for immutability
                        const width = 1000; // Canvas width
                        const height = 800; // Canvas height
                        const center = { x: width / 2, y: height / 2 };

                        // 1. Repulsion (Nodes push away from each other)
                        for (let i = 0; i < nextNodes.length; i++) {
                            for (let j = i + 1; j < nextNodes.length; j++) {
                                const dx = nextNodes[i].x - nextNodes[j].x;
                                const dy = nextNodes[i].y - nextNodes[j].y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                const force = 2000 / (dist * dist); // Repulsion strength
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;

                                nextNodes[i].vx += fx;
                                nextNodes[i].vy += fy;
                                nextNodes[j].vx -= fx;
                                nextNodes[j].vy -= fy;
                            }
                        }

                        // 2. Attraction (Links pull nodes together)
                        links.forEach(link => {
                            const source = nextNodes.find(n => n.id === link.source);
                            const target = nextNodes.find(n => n.id === link.target);
                            if (source && target) {
                                const dx = target.x - source.x;
                                const dy = target.y - source.y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                const force = (dist - 150) * 0.05; // Spring force (target distance 150)
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;

                                source.vx += fx;
                                source.vy += fy;
                                target.vx -= fx;
                                target.vy -= fy;
                            }
                        });

                        // 3. Center Gravity (Keep nodes on screen)
                        nextNodes.forEach(node => {
                            node.vx += (center.x - node.x) * 0.01;
                            node.vy += (center.y - node.y) * 0.01;

                            // Apply Velocity
                            node.vx *= 0.8; // Damping
                            node.vy *= 0.8;
                            node.x += node.vx;
                            node.y += node.vy;
                        });

                        return nextNodes;
                    });
                    animationFrameId = requestAnimationFrame(simulate);
                };

                simulate();
                return () => cancelAnimationFrame(animationFrameId);
            }, [links]); // Re-run simulation setup only when links change (which implies nodes changed too)

            
            return (
            <div className="flex-1 bg-slate-950 relative flex flex-col items-center justify-center overflow-hidden">
                <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-slate-950 z-0"></div>

                <div className="absolute top-6 left-6 z-10 bg-slate-900/80 backdrop-blur p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h2 className="text-lg font-bold text-slate-200">Story Codex</h2>
                    <p className="text-xs text-slate-500">Characters, Locations & Relationships</p>
                </div>

                {/* Visualization Layer */}
                {nodes.length > 0 ? (
                    <div className="absolute inset-0 z-0 flex items-center justify-center">
                        <svg width="100%" height="100%" viewBox="0 0 1000 800" className="overflow-visible">
                            <defs>
                                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            {/* Links */}
                            {links.map((link, i) => {
                                const source = nodes.find(n => n.id === link.source);
                                const target = nodes.find(n => n.id === link.target);
                                if (!source || !target) return null;
                                return (
                                    <g key={i}>
                                        <line 
                                            x1={source.x} y1={source.y} 
                                            x2={target.x} y2={target.y} 
                                            stroke="#4f46e5" 
                                            strokeWidth={Math.max(1, link.strength / 2)} 
                                            strokeOpacity="0.4" 
                                        />
                                        <text 
                                            x={(source.x + target.x) / 2} 
                                            y={(source.y + target.y) / 2} 
                                            fill="#94a3b8" 
                                            fontSize="10" 
                                            textAnchor="middle"
                                            className="bg-black"
                                        >
                                            {link.type}
                                        </text>
                                    </g>
                                );
                            })}
                            {/* Nodes */}
                            {nodes.map((node, i) => (
                                <g key={node.id} transform={`translate(${node.x},${node.y})`} className="cursor-pointer hover:scale-110 transition-transform duration-200">
                                    <circle r="25" fill="#1e1b4b" stroke={node.color} strokeWidth="2" filter="url(#glow)" />
                                    <text dy="5" textAnchor="middle" fill="white" fontSize="14" fontWeight="bold" pointerEvents="none">
                                        {node.id.substring(0, 2).toUpperCase()}
                                    </text>
                                    <text dy="40" textAnchor="middle" fill="#cbd5e1" fontSize="12" fontWeight="bold" className="drop-shadow-md">
                                        {node.id}
                                    </text>
                                </g>
                            ))}
                        </svg>
                    </div>
                ) : (
                    !hasCharacters && (
                    <div className="text-center text-slate-500 z-10">
                        <Map className="w-16 h-16 mx-auto mb-4 opacity-30" />
                        <p className="text-lg mb-2">No characters yet</p>
                        <p className="text-sm mb-6">Add characters to visualize relationships</p>
                    </div>
                    )
                )}

                {/* Timeline & Editor Controls */}
                <div className="absolute bottom-8 left-8 z-10 flex flex-col gap-4">
                    {relationshipTimeline.length > 1 && (
                        <div className="bg-slate-900/90 backdrop-blur p-4 rounded-xl border border-slate-800 shadow-xl w-[400px]">
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs font-bold text-slate-400 uppercase">Timeline</span>
                                <span className="text-xs text-indigo-400 font-bold">{relationshipTimeline[timelineIndex].label}</span>
                            </div>
                            <input 
                                type="range" 
                                min="0" 
                                max={relationshipTimeline.length - 1} 
                                value={timelineIndex} 
                                onChange={(e) => {
                                    const idx = parseInt(e.target.value);
                                    setTimelineIndex(idx);
                                    setRelationships(relationshipTimeline[idx].relationships);
                                }}
                                className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                            />
                            <p className="text-xs text-slate-300 mt-2 italic">
                                "{relationshipTimeline[timelineIndex].description}"
                            </p>
                        </div>
                    )}
                    
                    <button 
                        onClick={() => setShowRelationshipEditor(true)}
                        className="self-start px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-xs font-bold border border-slate-700 flex items-center gap-2"
                    >
                        <PenTool className="w-3 h-3" /> Edit Data
                    </button>
                </div>

                {/* Relationship Editor Modal */}
                {showRelationshipEditor && (
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-10">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
                            <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                                <h3 className="text-xl font-bold text-white">Edit Relationships</h3>
                                <button onClick={() => setShowRelationshipEditor(false)} className="text-slate-400 hover:text-white">
                                    <X className="w-6 h-6" />
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6">
                                <table className="w-full text-left text-sm text-slate-300">
                                    <thead className="text-xs uppercase bg-slate-800 text-slate-400">
                                        <tr>
                                            <th className="p-3 rounded-tl-lg">Source</th>
                                            <th className="p-3">Target</th>
                                            <th className="p-3">Type</th>
                                            <th className="p-3">Strength (1-10)</th>
                                            <th className="p-3 rounded-tr-lg">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-800">
                                        {relationships.map((rel, idx) => (
                                            <tr key={idx} className="hover:bg-slate-800/50">
                                                <td className="p-3">
                                                    <input 
                                                        type="text" 
                                                        value={rel.source} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].source = e.target.value;
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-full"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input 
                                                        type="text" 
                                                        value={rel.target} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].target = e.target.value;
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-full"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input 
                                                        type="text" 
                                                        value={rel.type} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].type = e.target.value;
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-full"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input 
                                                        type="number" 
                                                        min="1" max="10"
                                                        value={rel.strength} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].strength = parseInt(e.target.value);
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-16"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <button 
                                                        onClick={() => {
                                                            const newRels = relationships.filter((_, i) => i !== idx);
                                                            setRelationships(newRels);
                                                        }}
                                                        className="text-red-400 hover:text-red-300"
                                                    >
                                                        <X className="w-4 h-4" />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <button 
                                    onClick={() => setRelationships([...relationships, { source: 'New', target: 'New', type: 'unknown', strength: 1 }])}
                                    className="mt-4 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold flex items-center gap-2"
                                >
                                    <Plus className="w-4 h-4" /> Add Relationship
                                </button>
                            </div>
                            <div className="p-6 border-t border-slate-800 flex justify-end">
                                <button 
                                    onClick={() => setShowRelationshipEditor(false)}
                                    className="px-6 py-3 bg-white text-slate-900 hover:bg-slate-200 rounded-lg font-bold"
                                >
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Controls */}
                <div className="absolute bottom-8 right-8 z-10 flex gap-2 items-center">
                    {/* Model Selector */}
                    <div className="bg-slate-900/80 backdrop-blur rounded-full border border-slate-700 px-4 py-3 flex items-center gap-2 shadow-lg">
                        <span className="text-xs text-slate-400 font-bold uppercase mr-1">{aiProvider}</span>
                        <select 
                            className="bg-transparent text-xs text-white font-mono outline-none cursor-pointer max-w-[150px] truncate"
                            value={
                                aiProvider === 'gemini' ? selectedModel :
                                aiProvider === 'huggingface' ? hfModel :
                                githubModel
                            }
                            onChange={(e) => {
                                if (aiProvider === 'gemini') setSelectedModel(e.target.value);
                                else if (aiProvider === 'huggingface') setHfModel(e.target.value);
                                else setGithubModel(e.target.value);
                            }}
                        >
                            {aiProvider === 'gemini' && availableModels.map(m => (
                                <option key={m.name} value={m.name} className="bg-slate-900">{m.displayName || m.name.split('/').pop()}</option>
                            ))}
                            {aiProvider === 'gemini' && availableModels.length === 0 && (
                                <option value="gemini-1.5-flash" className="bg-slate-900">Gemini 1.5 Flash</option>
                            )}
                            
                            {aiProvider === 'huggingface' && HF_MODELS.map(m => (
                                <option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>
                            ))}
                            
                            {aiProvider === 'github' && GITHUB_MODELS.map(m => (
                                <option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>
                            ))}
                        </select>
                        <ChevronDown className="w-3 h-3 text-slate-500" />
                    </div>

                    {/* Scope Selector */}
                    <div className="bg-slate-900/80 backdrop-blur rounded-full border border-slate-700 px-4 py-3 flex items-center gap-2 shadow-lg">
                        <span className="text-xs text-slate-400 font-bold uppercase mr-1">Scope</span>
                        <select 
                            className="bg-transparent text-xs text-white font-mono outline-none cursor-pointer"
                            value={analysisScope}
                            onChange={(e) => setAnalysisScope(e.target.value)}
                        >
                            <option value="project" className="bg-slate-900">Full Book</option>
                            <option value="chapter" className="bg-slate-900">Current Chapter</option>
                        </select>
                        <ChevronDown className="w-3 h-3 text-slate-500" />
                    </div>

                        <button 
                        onClick={() => analyzeRelationships()}
                        disabled={isAiLoading}
                        className={`px-6 py-3 ${isAiLoading ? 'bg-purple-800 cursor-wait' : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500'} text-white rounded-full font-bold shadow-lg shadow-purple-900/50 flex items-center gap-2 transition-all hover:scale-105`}
                    >
                        {isAiLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Zap className="w-5 h-5" />} 
                        {isAiLoading ? 'Analyzing Story...' : 'Generate Relationship Graph'}
                    </button>
                    
                    <button 
                        onClick={() => {
                            const name = prompt('Character name:');
                            if (name && currentProject) {
                                const newChar = {
                                    id: `char-${Date.now()}`,
                                    name: name,
                                    role: '',
                                    description: '',
                                    avatar: name.charAt(0).toUpperCase(),
                                    color: `#${Math.floor(Math.random()*16777215).toString(16)}`
                                };
                                const updatedProject = { ...currentProject };
                                updatedProject.characters = [...(updatedProject.characters || []), newChar];
                                setCurrentProject(updatedProject);
                                ProjectStorage.saveProject(updatedProject);
                            }
                        }}
                        className="px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-full font-bold shadow-lg border border-slate-700 flex items-center gap-2"
                    >
                        <Plus className="w-5 h-5" /> Add Node
                    </button>
                </div>
            </div>
            );
        };

        function NarrativeOS() {
            // Project State
            const [currentProject, setCurrentProject] = useState(null);
            const [projects, setProjects] = useState([]);
            const [showProjectModal, setShowProjectModal] = useState(false);
            const [selectedSectionId, setSelectedSectionId] = useState(null);
            const [selectedChapterId, setSelectedChapterId] = useState(null);
            
            // Navigation State
            const [activeTab, setActiveTab] = useState('write'); 
            
            // Editor State
            const [focusMode, setFocusMode] = useState(false);
            const [splitScreen, setSplitScreen] = useState(false);
            const [textMode, setTextMode] = useState('normal'); // normal, rhythm, hemingway, blind
            const [ambientSound, setAmbientSound] = useState(null); // null, rain, coffee
            
            // Feature Panels
            const [showAiPanel, setShowAiPanel] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showComments, setShowComments] = useState(false);
            
            // Visualization State
            const [timeSlider, setTimeSlider] = useState(1);
            const [versionSlider, setVersionSlider] = useState(10);

            // Global Document State
            const [globalWordCount, setGlobalWordCount] = useState(0);
            const [globalCharCount, setGlobalCharCount] = useState(0);

            // AI State (Lifted from WordEditor)
            const [aiProvider, setAiProvider] = useState(() => localStorage.getItem('narrativeos-ai-provider') || 'gemini'); // 'gemini' | 'huggingface' | 'github'
            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini-api-key') || '');
            const [hfToken, setHfToken] = useState(() => localStorage.getItem('hf-token') || '');
            const [githubToken, setGithubToken] = useState(() => localStorage.getItem('github-token') || '');
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState(() => localStorage.getItem('gemini-model') || 'gemini-1.5-flash');
            const [hfModel, setHfModel] = useState(() => localStorage.getItem('hf-model') || 'bigscience/bloom');
            const [githubModel, setGithubModel] = useState(() => localStorage.getItem('github-model') || 'gpt-4o');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [relationships, setRelationships] = useState([]); // Store AI-analyzed relationships
            const [analysisScope, setAnalysisScope] = useState('project'); // 'project' or 'chapter'
            const [relationshipTimeline, setRelationshipTimeline] = useState([]); // Store timeline of relationships
            const [timelineIndex, setTimelineIndex] = useState(0); // Current point in timeline
            const [showRelationshipEditor, setShowRelationshipEditor] = useState(false); // Toggle for editor modal

            // Hugging Face Models List
            const HF_MODELS = [
                { id: 'bigscience/bloom', name: 'Bloom (176B) - May Timeout' },
                { id: 'bigscience/bloomz-7b1', name: 'Bloomz (7B) - Recommended' },
                { id: 'meta-llama/Meta-Llama-3-8B-Instruct', name: 'Llama 3 (8B)' },
                { id: 'mistralai/Mistral-7B-Instruct-v0.2', name: 'Mistral 7B' },
                { id: 'google/gemma-7b-it', name: 'Gemma 7B' }
            ];

            // GitHub Models List
            const GITHUB_MODELS = [
                { id: 'gpt-4o', name: 'GPT-4o' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini' },
                { id: 'Phi-3-mini-4k-instruct', name: 'Phi-3 Mini' },
                { id: 'Mistral-Nemo', name: 'Mistral Nemo' },
                { id: 'Llama-3.1-8B-Instruct', name: 'Llama 3.1 (8B)' },
                { id: 'Llama-3.1-70B-Instruct', name: 'Llama 3.1 (70B)' }
            ];

            // Fetch available models when API key is set (Gemini Only)
            useEffect(() => {
                if (aiProvider === 'gemini' && geminiApiKey) {
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiApiKey}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.models) {
                                const generateModels = data.models.filter(m => 
                                    m.supportedGenerationMethods && 
                                    m.supportedGenerationMethods.includes('generateContent')
                                ).sort((a, b) => {
                                    const aName = a.name.toLowerCase();
                                    const bName = b.name.toLowerCase();
                                    if (aName.includes('flash') && !bName.includes('flash')) return -1;
                                    if (!aName.includes('flash') && bName.includes('flash')) return 1;
                                    return aName.localeCompare(bName);
                                });
                                setAvailableModels(generateModels);
                                
                                if (!selectedModel || !generateModels.find(m => m.name === selectedModel || m.name === `models/${selectedModel}`)) {
                                    const defaultModel = generateModels.find(m => m.name.includes('gemini-1.5-flash')) || generateModels[0];
                                    if (defaultModel) {
                                        setSelectedModel(defaultModel.name);
                                    }
                                }
                            }
                        })
                        .catch(err => console.error('Failed to fetch models:', err));
                }
            }, [geminiApiKey, aiProvider]);

            const callHuggingFace = async (promptText) => {
                // Helper function for retrying with delay
                const fetchWithRetry = async (retries = 5) => {
                    const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${hfToken}`,
                            "Content-Type": "application/json",
                            "x-use-cache": "false"
                        },
                        body: JSON.stringify({ 
                            inputs: promptText,
                            parameters: {
                                max_new_tokens: 1000,
                                return_full_text: false,
                                temperature: 0.7
                            }
                        }),
                    });

                    if (response.status === 503) {
                        const data = await response.json();
                        if (retries > 0 && data.estimated_time) {
                            console.log(`Model loading... waiting ${data.estimated_time}s`);
                            await new Promise(r => setTimeout(r, (data.estimated_time * 1000) + 1000));
                            return fetchWithRetry(retries - 1);
                        }
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HF Error ${response.status}: ${errorText}`);
                    }

                    return response.json();
                };

                const result = await fetchWithRetry();
                if (result.error) throw new Error(result.error);
                // HF returns array of objects or single object depending on task
                return Array.isArray(result) ? result[0].generated_text : result.generated_text;
            };

            const analyzeRelationships = async () => {
                  console.log("Starting AI Analysis...");
                  
                  if (aiProvider === 'gemini' && !geminiApiKey) {
                      alert('Please enter your Google Gemini API Key.');
                      return;
                  }
                  if (aiProvider === 'huggingface' && !hfToken) {
                      alert('Please enter your Hugging Face Token.');
                      return;
                  }
                  if (aiProvider === 'github' && !githubToken) {
                      alert('Please enter your GitHub Personal Access Token.');
                      return;
                  }
                  
                  if (!currentProject) {
                      console.error("No current project loaded.");
                      return;
                  }

                  let textToAnalyze = "";
                  if (analysisScope === 'chapter') {
                      if (!selectedChapterId) {
                          alert("Please select a chapter in the editor first.");
                          return;
                      }
                      // Find the chapter
                      let foundChapter = null;
                      for (const section of currentProject.sections) {
                          const ch = section.chapters.find(c => c.id === selectedChapterId);
                          if (ch) {
                              foundChapter = ch;
                              break;
                          }
                      }
                      if (foundChapter) {
                          textToAnalyze = foundChapter.content.replace(/<[^>]*>/g, ' ');
                      } else {
                          alert("Could not find selected chapter content.");
                          return;
                      }
                  } else {
                      // Full Project
                      textToAnalyze = currentProject.sections.map(s => s.chapters.map(c => c.content).join('\n')).join('\n').replace(/<[^>]*>/g, ' ');
                  }

                  console.log(`Analyzing text length: ${textToAnalyze.length} chars (Scope: ${analysisScope})`);
                  
                  const prompt = `
                  Analyze the relationships between characters based on the following fictional story content.
                  
                  CRITICAL: You must return a JSON object with a "timeline" property.
                  The "timeline" property must be an array of objects, representing the evolution of relationships through the story (e.g. "Beginning", "Middle", "End" or by Chapter).
                  
                  Each item in the "timeline" array must have:
                  - "label": string (e.g. "Chapter 1" or "The Meeting")
                  - "description": string (short summary of relationship dynamics at this point)
                  - "relationships": array of objects with fields: source (character name), target (character name), type (relationship type e.g. friend, enemy, sibling), strength (1-10).
                  
                  If the story is short, just return one timeline item labeled "Current State".
                  
                  STORY CONTENT (FICTIONAL):
                  ${textToAnalyze.substring(0, 95000)}`;
                  
                  setIsAiLoading(true);
                  try {
                      let jsonString = "";

                      if (aiProvider === 'gemini') {
                        const modelPath = selectedModel.startsWith('models/') ? selectedModel : `models/${selectedModel}`;
                        console.log(`Using Gemini model: ${modelPath}`);
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${modelPath}:generateContent?key=${geminiApiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    system_instruction: {
                                        parts: [{ text: "You are a literary analysis tool. Your task is to analyze fictional stories and extract character relationships for a database. You are analyzing creative writing. Do not censor the analysis of fictional themes." }]
                                    },
                                    contents: [{ parts: [{ text: prompt }] }],
                                    safetySettings: [
                                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                                    ]
                                })
                            });
                            
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        if (data.promptFeedback && data.promptFeedback.blockReason) {
                            throw new Error(`Blocked: ${data.promptFeedback.blockReason}`);
                        }
                        if (data.candidates && data.candidates[0]) {
                            jsonString = data.candidates[0].content.parts[0].text;
                        }
                      } else if (aiProvider === 'github') {
                          // GitHub Models
                          console.log(`Using GitHub model: ${githubModel}`);
                          const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${githubToken}`
                                },
                                body: JSON.stringify({
                                    messages: [{ role: "user", content: prompt }],
                                    model: githubModel,
                                    temperature: 0.7,
                                    max_tokens: 2000
                                })
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`GitHub Models Error ${response.status}: ${errorText}`);
                            }
                            
                            const data = await response.json();
                            jsonString = data.choices[0].message.content;
                      } else {
                          // Hugging Face
                          console.log(`Using HF model: ${hfModel}`);
                          jsonString = await callHuggingFace(prompt);
                      }

                      // Try to extract JSON
                      const jsonMatch = jsonString.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                      if (jsonMatch) {
                          const parsedData = JSON.parse(jsonMatch[0]);
                          
                          if (parsedData.timeline && Array.isArray(parsedData.timeline)) {
                              setRelationshipTimeline(parsedData.timeline);
                              setTimelineIndex(parsedData.timeline.length - 1); // Start at the end
                              setRelationships(parsedData.timeline[parsedData.timeline.length - 1].relationships);
                          } else if (Array.isArray(parsedData)) {
                              // Fallback for old format (just array of relationships)
                              const fallbackTimeline = [{ label: "Current State", description: "Analysis of current text", relationships: parsedData }];
                              setRelationshipTimeline(fallbackTimeline);
                              setTimelineIndex(0);
                              setRelationships(parsedData);
                          } else {
                              console.error("Unexpected JSON format", parsedData);
                          }
                      } else {
                          console.warn("No JSON found in response", jsonString);
                      }

                  } catch (err) {
                      console.error("Analysis failed:", err);
                      alert('Analysis failed: ' + err.message);
                  } finally {
                      setIsAiLoading(false);
                  }
              };
            
            // Initialize Projects
            useEffect(() => {
                const allProjects = ProjectStorage.getAllProjects();
                setProjects(allProjects);
                if (allProjects.length > 0) {
                    setCurrentProject(allProjects[0]);
                    if (allProjects[0].sections.length > 0) {
                        setSelectedSectionId(allProjects[0].sections[0].id);
                        if (allProjects[0].sections[0].chapters.length > 0) {
                            setSelectedChapterId(allProjects[0].sections[0].chapters[0].id);
                        }
                    }
                }
            }, []);
            
            // Calculate total word count
            useEffect(() => {
                if (!currentProject) return;
                let totalWords = 0;
                let totalChars = 0;
                currentProject.sections.forEach(section => {
                    section.chapters.forEach(chapter => {
                        const text = chapter.content.replace(/<[^>]*>/g, ' ').trim();
                        totalWords += text ? text.split(/\s+/).length : 0;
                        totalChars += text.replace(/\s/g, '').length;
                    });
                });
                setGlobalWordCount(totalWords);
                setGlobalCharCount(totalChars);
            }, [currentProject]);
            
            // Get current chapter
            const getCurrentChapter = () => {
                if (!currentProject || !selectedSectionId || !selectedChapterId) return null;
                const section = currentProject.sections.find(s => s.id === selectedSectionId);
                if (!section) return null;
                return section.chapters.find(c => c.id === selectedChapterId);
            };
            
            // Save chapter content
            const saveChapterContent = (content, title, subtitle) => {
                if (!currentProject || !selectedSectionId || !selectedChapterId) return;
                
                const updatedProject = { ...currentProject };
                const sectionIndex = updatedProject.sections.findIndex(s => s.id === selectedSectionId);
                if (sectionIndex === -1) return;
                
                const chapterIndex = updatedProject.sections[sectionIndex].chapters.findIndex(c => c.id === selectedChapterId);
                if (chapterIndex === -1) return;
                
                updatedProject.sections[sectionIndex].chapters[chapterIndex].content = content;
                
                // Update title and subtitle if provided
                if (title !== null && title !== undefined) {
                    updatedProject.sections[sectionIndex].chapters[chapterIndex].title = title;
                }
                if (subtitle !== null && subtitle !== undefined) {
                    updatedProject.sections[sectionIndex].chapters[chapterIndex].subtitle = subtitle;
                }
                
                updatedProject.lastModified = Date.now();
                
                setCurrentProject(updatedProject);
                ProjectStorage.saveProject(updatedProject);
            };
            
            // Add new section
            const addSection = (name) => {
                if (!currentProject) return;
                const newSection = {
                    id: `section-${Date.now()}`,
                    name: name,
                    chapters: []
                };
                const updatedProject = { ...currentProject };
                updatedProject.sections.push(newSection);
                setCurrentProject(updatedProject);
                ProjectStorage.saveProject(updatedProject);
            };
            
            // Add new chapter
            const addChapter = (sectionId) => {
                if (!currentProject) return;
                const section = currentProject.sections.find(s => s.id === sectionId);
                if (!section) return;
                
                const chapterNum = section.chapters.length + 1;
                const newChapter = {
                    id: `ch-${Date.now()}`,
                    title: `Chapter ${chapterNum}`,
                    subtitle: '',
                    content: `<h1>Chapter ${chapterNum}</h1><p>Start writing...</p>`,
                    status: 'draft',
                    targetWords: 2500,
                    characterTags: [],
                    notes: ''
                };
                
                const updatedProject = { ...currentProject };
                const sectionIndex = updatedProject.sections.findIndex(s => s.id === sectionId);
                updatedProject.sections[sectionIndex].chapters.push(newChapter);
                setCurrentProject(updatedProject);
                ProjectStorage.saveProject(updatedProject);
                setSelectedChapterId(newChapter.id);
            };
            
            // Update chapter details
            const updateChapter = (sectionId, chapterId, updates) => {
                if (!currentProject) return;
                const updatedProject = { ...currentProject };
                const sectionIndex = updatedProject.sections.findIndex(s => s.id === sectionId);
                if (sectionIndex === -1) return;
                
                const chapterIndex = updatedProject.sections[sectionIndex].chapters.findIndex(c => c.id === chapterId);
                if (chapterIndex === -1) return;
                
                updatedProject.sections[sectionIndex].chapters[chapterIndex] = {
                    ...updatedProject.sections[sectionIndex].chapters[chapterIndex],
                    ...updates
                };
                
                setCurrentProject(updatedProject);
                ProjectStorage.saveProject(updatedProject);
            };

            // --- RENDERERS ---

            // 1. THE SIDEBAR (BINDER)
            const renderSidebar = () => {
                if (focusMode || !currentProject) return null;

                return (
                <aside className="w-72 bg-slate-950 border-r border-slate-900 flex flex-col h-full transition-all duration-300">
                    <div className="p-4 border-b border-slate-900 flex items-center justify-between">
                        <div className="flex items-center gap-2 flex-1 min-w-0">
                            <div className="w-6 h-6 bg-indigo-600 rounded-lg flex items-center justify-center font-bold text-white text-xs shadow-glow flex-shrink-0">N</div>
                            <input 
                                type="text" 
                                value={currentProject.name}
                                onChange={(e) => {
                                    const updatedProject = { ...currentProject, name: e.target.value };
                                    setCurrentProject(updatedProject);
                                    ProjectStorage.saveProject(updatedProject);
                                }}
                                className="font-bold text-slate-200 tracking-wide bg-transparent border-none outline-none hover:text-white focus:text-white truncate flex-1 min-w-0"
                                placeholder="Project Name"
                            />
                        </div>
                        <div className="flex items-center gap-2 flex-shrink-0">
                            <button 
                                onClick={() => setShowProjectModal(true)}
                                className="text-slate-600 hover:text-slate-300 cursor-pointer"
                                title="Projects"
                            >
                                <BookOpen className="w-4 h-4" />
                            </button>
                            <Settings className="w-4 h-4 text-slate-600 hover:text-slate-300 cursor-pointer" />
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-2 scrollbar-thin">
                        <div className="flex items-center justify-between text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-2 px-2">
                            <span>Manuscript Structure</span>
                            <button 
                                onClick={() => {
                                    const name = prompt('Section name:', `Part ${currentProject.sections.length + 1}`);
                                    if (name) addSection(name);
                                }}
                                className="text-indigo-500 hover:text-indigo-400"
                                title="Add Section"
                            >
                                <Plus className="w-3 h-3" />
                            </button>
                        </div>
                        
                        {/* Render Sections and Chapters */}
                        {currentProject.sections.map((section, sectionIdx) => (
                            <div key={section.id} className="mb-2">
                                <div className="flex items-center text-slate-300 hover:bg-slate-900 p-2 rounded cursor-pointer group">
                                    <ChevronDown className="w-3 h-3 mr-2 text-slate-500" />
                                    <input
                                        type="text"
                                        value={section.name}
                                        onChange={(e) => {
                                            const updatedProject = { ...currentProject };
                                            updatedProject.sections[sectionIdx].name = e.target.value;
                                            setCurrentProject(updatedProject);
                                            ProjectStorage.saveProject(updatedProject);
                                        }}
                                        className="font-medium text-sm flex-1 bg-transparent border-none outline-none"
                                        onClick={(e) => e.stopPropagation()}
                                    />
                                    <button
                                        onClick={() => addChapter(section.id)}
                                        className="opacity-0 group-hover:opacity-100 text-indigo-500 hover:text-indigo-400"
                                        title="Add Chapter"
                                    >
                                        <Plus className="w-3 h-3" />
                                    </button>
                                </div>
                                
                                <div className="ml-4 border-l border-slate-800 pl-2">
                                    {section.chapters.map((chapter) => {
                                        const text = chapter.content.replace(/<[^>]*>/g, ' ').trim();
                                        const wordCount = text ? text.split(/\s+/).length : 0;
                                        const isSelected = selectedChapterId === chapter.id;
                                        
                                        return (
                                            <div 
                                                key={chapter.id}
                                                onClick={() => { 
                                                    setSelectedSectionId(section.id);
                                                    setSelectedChapterId(chapter.id); 
                                                    setActiveTab('write'); 
                                                }}
                                                className={`group relative p-2 rounded mb-1 cursor-pointer transition-all border border-transparent ${isSelected ? 'bg-slate-900 border-slate-800' : 'hover:bg-slate-900/50'}`}
                                            >
                                                <div className="flex items-center justify-between mb-1">
                                                    <input
                                                        type="text"
                                                        value={chapter.title}
                                                        onChange={(e) => updateChapter(section.id, chapter.id, { title: e.target.value })}
                                                        className={`text-sm ${isSelected ? 'text-white' : 'text-slate-400'} bg-transparent border-none outline-none flex-1`}
                                                        onClick={(e) => e.stopPropagation()}
                                                    />
                                                    <div 
                                                        className={`w-2 h-2 rounded-full ${
                                                            chapter.status === 'final' ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' :
                                                            chapter.status === 'revised' ? 'bg-yellow-500' :
                                                            'bg-red-500'
                                                        }`} 
                                                        title={`Status: ${chapter.status}`} 
                                                    />
                                                </div>
                                                <input
                                                    type="text"
                                                    value={chapter.subtitle}
                                                    onChange={(e) => updateChapter(section.id, chapter.id, { subtitle: e.target.value })}
                                                    placeholder="Chapter subtitle..."
                                                    className="text-xs text-slate-500 truncate mb-1 bg-transparent border-none outline-none w-full"
                                                    onClick={(e) => e.stopPropagation()}
                                                />
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-1">
                                                        {chapter.characterTags.map(tag => (
                                                            <span key={tag} className="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20">{tag}</span>
                                                        ))}
                                                    </div>
                                                    <span className="text-[10px] text-slate-600">{wordCount} / {chapter.targetWords}</span>
                                                </div>
                                                <ProgressBar current={wordCount} max={chapter.targetWords} color={wordCount >= chapter.targetWords ? "bg-emerald-500" : "bg-indigo-500"} />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}

                        <div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-6 px-2">Story Codex</div>
                        {['Characters', 'Locations', 'Lore', 'Items'].map(item => (
                            <div 
                                key={item} 
                                onClick={() => setActiveTab('world')}
                                className="flex items-center text-slate-400 hover:bg-slate-800 p-2 rounded cursor-pointer text-sm"
                            >
                                <BookOpen className="w-3 h-3 mr-2 text-indigo-500" /> {item}
                            </div>
                        ))}
                    </div>
                </aside>
                );
            };

            // 2. THE EDITOR (CREATOR MODE)
            const renderEditor = () => {
                const currentChapter = getCurrentChapter();
                if (!currentChapter) {
                    return (
                        <div className="flex-1 h-full bg-[#0b0c0f] flex items-center justify-center">
                            <div className="text-center text-slate-500">
                                <PenTool className="w-12 h-12 mx-auto mb-4 opacity-50" />
                                <p>Select or create a chapter to start writing</p>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div className="flex-1 h-full bg-[#0b0c0f] relative">
                        <WordEditor 
                            key={selectedChapterId}
                            initialContent={currentChapter.content}
                            projectName={currentProject.name}
                            geminiApiKey={geminiApiKey}
                            setGeminiApiKey={setGeminiApiKey}
                            availableModels={availableModels}
                            selectedModel={selectedModel}
                            setSelectedModel={setSelectedModel}
                            aiProvider={aiProvider}
                            setAiProvider={setAiProvider}
                            hfToken={hfToken}
                            setHfToken={setHfToken}
                            hfModel={hfModel}
                            setHfModel={setHfModel}
                            HF_MODELS={HF_MODELS}
                            githubToken={githubToken}
                            setGithubToken={setGithubToken}
                            githubModel={githubModel}
                            setGithubModel={setGithubModel}
                            GITHUB_MODELS={GITHUB_MODELS}
                            onContentChange={(content) => saveChapterContent(content)}
                            onStatsUpdate={(w, c) => {
                                setGlobalWordCount(w);
                                setGlobalCharCount(c);
                            }}
                        />
                    </div>
                );
            };

            const renderEditorOld = () => {
                // Text Processing Logic for Visual Modes
                const renderText = () => {
                    if (textMode === 'blind') {
                        return (
                            <div className="font-serif text-slate-300 leading-relaxed text-lg whitespace-pre-wrap outline-none relative">
                                <span className="blur-sm select-none opacity-50 transition-all duration-1000">{SAMPLE_TEXT.slice(0, -100)}</span>
                                <span className="blur-none">{SAMPLE_TEXT.slice(-100)}</span>
                                <span className="animate-pulse text-indigo-500">|</span>
                            </div>
                        )
                    }

                    const sentences = SAMPLE_TEXT.split(/(?<=[.!?])\s+/);
                    
                    return (
                        <div className="font-serif text-slate-300 leading-relaxed text-lg whitespace-pre-wrap outline-none">
                            {sentences.map((s, i) => {
                                let className = "";
                                let style = {};
                                
                                if (textMode === 'rhythm') {
                                    const wordCount = s.split(' ').length;
                                    if (wordCount < 8) className = "bg-emerald-500/20 border-b-2 border-emerald-500/50";
                                    else if (wordCount > 25) className = "bg-red-500/20 border-b-2 border-red-500/50";
                                    else className = "bg-yellow-500/20 border-b-2 border-yellow-500/50";
                                } else if (textMode === 'hemingway') {
                                    if (s.includes('ly')) className = "bg-blue-500/20 text-blue-200"; // crude adverb check
                                    if (s.includes('was') || s.includes('were')) className = "bg-pink-500/20 text-pink-200"; // crude passive check
                                }

                                return <span key={i} className={`rounded px-0.5 transition-colors duration-500 ${className}`}>{s} </span>
                            })}
                        </div>
                    )
                };

                return (
                <div className={`flex-1 flex flex-col h-full bg-[#0b0c0f] relative transition-all duration-700 ${focusMode ? 'scale-100' : ''}`}>
                    
                    {/* Editor Toolbar */}
                    <div className={`h-14 border-b border-slate-900 flex items-center justify-between px-6 bg-[#0b0c0f] z-20 transition-opacity duration-500 ${focusMode ? 'opacity-0 hover:opacity-100' : 'opacity-100'}`}>
                    <div className="flex items-center gap-4">
                        <span className="text-slate-400 font-serif italic text-lg">Chapter 1: The Inciting Incident</span>
                        <div className="h-4 w-px bg-slate-800"></div>
                        
                        {/* VISUAL LAYERS MENU */}
                        <div className="flex bg-slate-900 rounded-lg p-0.5 border border-slate-800">
                            <button 
                                onClick={() => setTextMode('normal')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'normal' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-white'}`}
                            >Normal</button>
                            <button 
                                onClick={() => setTextMode('rhythm')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'rhythm' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-white'}`}
                            >Rhythm</button>
                            <button 
                                onClick={() => setTextMode('hemingway')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'hemingway' ? 'bg-pink-600 text-white' : 'text-slate-500 hover:text-white'}`}
                            >Hemingway</button>
                            <button 
                                onClick={() => setTextMode('blind')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'blind' ? 'bg-slate-200 text-black' : 'text-slate-500 hover:text-white'}`}
                            >Blind</button>
                        </div>

                        {/* AMBIENT CONTROL */}
                        <div className="flex items-center gap-2 ml-2">
                            <button 
                                onClick={() => setAmbientSound(ambientSound === 'rain' ? null : 'rain')}
                                className={`p-1.5 rounded-full ${ambientSound === 'rain' ? 'bg-blue-500/20 text-blue-400' : 'text-slate-600 hover:text-slate-300'}`}
                                title="Rain Soundscape"
                            >
                                <Cloud className="w-4 h-4" />
                            </button>
                            <button 
                                onClick={() => setAmbientSound(ambientSound === 'coffee' ? null : 'coffee')}
                                className={`p-1.5 rounded-full ${ambientSound === 'coffee' ? 'bg-amber-500/20 text-amber-400' : 'text-slate-600 hover:text-slate-300'}`}
                                title="Coffee Shop"
                            >
                                <Coffee className="w-4 h-4" />
                            </button>
                        </div>
                    </div>

                    <div className="flex items-center gap-3">
                        <button 
                            onClick={() => setShowHistory(!showHistory)}
                            className={`p-2 rounded ${showHistory ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500 hover:bg-slate-800'}`}
                            title="Version History (Time Machine)"
                        >
                        <GitBranch className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setShowComments(!showComments)}
                            className={`p-2 rounded ${showComments ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500 hover:bg-slate-800'}`}
                            title="Beta Reader Reactions"
                        >
                        <MessageSquare className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setSplitScreen(!splitScreen)}
                            className={`p-2 rounded ${splitScreen ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500 hover:bg-slate-800'}`}
                            title="Split Screen Reference"
                        >
                        <Layout className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setFocusMode(!focusMode)} 
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full transition-all border ${focusMode ? 'bg-indigo-500 border-indigo-500 text-white shadow-[0_0_15px_rgba(99,102,241,0.5)]' : 'bg-transparent border-slate-700 text-slate-300 hover:border-slate-500'}`}
                        >
                        {focusMode ? <Minimize2 className="w-3 h-3" /> : <Maximize2 className="w-3 h-3" />}
                        <span className="text-xs font-medium">{focusMode ? 'Exit Focus' : 'Deep Focus'}</span>
                        </button>
                    </div>
                    </div>

                    {/* TIME MACHINE OVERLAY (Version Control) */}
                    {showHistory && (
                        <div className="h-16 bg-[#0f1116] border-b border-slate-800 flex items-center px-8 gap-4 animate-in slide-in-from-top-2">
                            <GitBranch className="w-4 h-4 text-emerald-500" />
                            <span className="text-xs font-bold text-slate-400 uppercase">Time Machine</span>
                            <input 
                                type="range" 
                                min="1" max="10" 
                                value={versionSlider} 
                                onChange={(e) => setVersionSlider(e.target.value)}
                                className="flex-1 accent-emerald-500 h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer"
                            />
                            <div className="text-xs text-slate-300 font-mono">
                                {versionSlider === 10 ? 'Current Draft' : `Draft v1.${versionSlider} (${10 - versionSlider} days ago)`}
                            </div>
                            <div className="flex gap-2">
                                <span className="text-[10px] text-red-400">-12 deletions</span>
                                <span className="text-[10px] text-emerald-400">+45 additions</span>
                            </div>
                        </div>
                    )}

                    {/* Main Typing Area */}
                    <div className="flex-1 overflow-y-auto relative flex scrollbar-hide">
                    
                    {/* Main Pane */}
                    <div className={`flex-1 flex justify-center py-12 transition-all duration-500 relative`}>
                        {/* REACTION MAP LAYER */}
                        {showComments && (
                            <div className="absolute top-0 right-8 bottom-0 w-8 py-12 flex flex-col items-center gap-12 pointer-events-none opacity-80">
                                <div className="mt-[320px] text-xl" title="3 Readers loved this"></div>
                                <div className="mt-[20px] text-xl grayscale opacity-50" title="1 Reader was bored"></div>
                                <div className="mt-[100px] text-xl" title="5 Readers were shocked"></div>
                            </div>
                        )}

                        <div className="w-full max-w-2xl px-8">
                        {/* Typewriter Padding */}
                        <div className="h-[35vh] w-full pointer-events-none"></div>
                        
                        <h1 className="text-4xl font-serif text-slate-100 mb-10 tracking-tight">Chapter 1: The Inciting Incident</h1>
                        
                        {renderText()}
                        
                        {/* Bottom Padding */}
                        <div className="h-[50vh] w-full pointer-events-none"></div>
                        </div>
                    </div>

                    {/* Split Pane (Context) */}
                    {splitScreen && (
                        <div className="w-[400px] border-l border-slate-800 bg-[#0f1116] flex flex-col animate-in slide-in-from-right-10">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Contextual Reference</h3>
                            <button onClick={() => setSplitScreen(false)}><Minimize2 className="w-3 h-3 text-slate-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {/* Auto-detected Entity Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800 hover:border-indigo-500/50 transition-colors cursor-pointer group">
                                <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">K</div>
                                <div>
                                    <div className="font-bold text-slate-200 group-hover:text-indigo-400 transition-colors">Kael</div>
                                    <div className="text-xs text-slate-500">Protagonist  Mercenary</div>
                                </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-3">
                                    <div className="bg-slate-950 p-2 rounded">AGE: 32</div>
                                    <div className="bg-slate-950 p-2 rounded">EYES: Cybernetic</div>
                                </div>
                                <p className="text-sm text-slate-400 leading-snug">
                                <span className="text-indigo-400 font-bold">Goal:</span> Secure credits for optic repair.<br/>
                                <span className="text-indigo-400 font-bold">Lie:</span> "I don't need anyone."
                                </p>
                            </div>

                            {/* Location Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                <div className="flex items-center gap-2 mb-2">
                                <Map className="w-4 h-4 text-emerald-500" />
                                <span className="font-bold text-slate-200">Sector 7 Docks</span>
                                </div>
                                <div className="h-32 bg-slate-950 rounded mb-2 overflow-hidden relative group border border-slate-800">
                                    {/* Mock Map */}
                                    <svg className="w-full h-full opacity-50" viewBox="0 0 100 100">
                                        <rect width="100" height="100" fill="#0f172a" />
                                        <path d="M 20 20 L 40 40 L 80 20" stroke="#334155" fill="none" />
                                        <circle cx="40" cy="40" r="3" fill="#10b981" />
                                        <text x="45" y="42" fill="white" fontSize="5">You Are Here</text>
                                    </svg>
                                </div>
                                <p className="text-xs text-slate-500">
                                    Atmosphere: Rain, Neon, Industrial Decay.<br/>
                                    Sensory: Smell of ozone and rotting fish.
                                </p>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* AI FAB */}
                    {!focusMode && (
                        <div className="absolute bottom-8 right-8 z-30">
                        <button 
                            onClick={() => setShowAiPanel(true)}
                            className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-full shadow-[0_0_20px_rgba(79,70,229,0.5)] flex items-center justify-center text-white transition-transform hover:scale-110 active:scale-95"
                            title="AI Creative Assistant"
                        >
                            <Zap className="w-6 h-6" />
                        </button>
                        </div>
                    )}
                    </div>
                    
                    {/* AI MODAL */}
                    {showAiPanel && (
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-end">
                            <div className="w-[450px] h-full bg-[#13151a] border-l border-slate-800 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                                <div className="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2"><Zap className="w-5 h-5 text-purple-400" /> Creative Assistant</h2>
                                    <button onClick={() => setShowAiPanel(false)} className="text-slate-500 hover:text-white"><Minimize2 className="w-4 h-4" /></button>
                                </div>
                                <div className="p-6 flex-1 overflow-y-auto space-y-6">
                                    {/* 1. Generate Image */}
                                    <div className="bg-slate-900 rounded-xl p-4 border border-slate-800">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><ImageIcon className="w-3 h-3" /> Generative Storyboard</h3>
                                        <div className="bg-black/40 p-3 rounded text-sm text-slate-300 italic mb-3 border border-slate-800">
                                            "The neon reflections of the noodle shop dancing in his artificial retina..."
                                        </div>
                                        <div className="aspect-video bg-slate-950 rounded border border-slate-800 flex items-center justify-center mb-3 group cursor-pointer relative overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 to-purple-900/20 group-hover:scale-105 transition-transform"></div>
                                            <span className="text-xs text-slate-500 flex items-center gap-2 z-10"><RefreshCcw className="w-3 h-3" /> Generate Image</span>
                                        </div>
                                    </div>

                                    {/* 2. Structural Critique */}
                                    <div className="bg-slate-900 rounded-xl p-4 border border-slate-800">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><AlertTriangle className="w-3 h-3" /> The Brutal Bot</h3>
                                        <div className="space-y-3">
                                            <div className="flex gap-3">
                                                <div className="w-1 h-full bg-red-500 rounded-full"></div>
                                                <div>
                                                    <div className="text-xs text-red-400 font-bold">Pacing Alert</div>
                                                    <p className="text-xs text-slate-400 mt-1">Paragraph 3 is 40% slower than the preceding action beat. Consider shortening sentences to maintain tension.</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-3">
                                                <div className="w-1 h-full bg-yellow-500 rounded-full"></div>
                                                <div>
                                                    <div className="text-xs text-yellow-400 font-bold">Show, Don't Tell</div>
                                                    <p className="text-xs text-slate-400 mt-1">"He was angry" detected. Try describing his physical reaction instead.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-900">
                                    <input type="text" placeholder="Ask AI to expand scene..." className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500" />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                );
            };

            // 3. THE ARCHITECT (TIMELINE MODE)
            // 3. THE TIMELINE (ARCHITECT)
            const renderTimeline = () => {
                if (!currentProject) return null;
                
                const timeline = currentProject.timeline || [];
                const hasTimeline = timeline.length > 0;
                const totalChapters = currentProject.sections.reduce((acc, s) => acc + s.chapters.length, 0);
                
                return (
                <div className="flex-1 bg-[#13151a] flex flex-col overflow-hidden">
                    <div className="h-12 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900">
                        <div className="flex items-center gap-4">
                            <div className="flex bg-slate-800 rounded p-1">
                                <button className="px-3 py-1 text-xs font-medium bg-slate-700 text-white rounded shadow-sm">Timeline View</button>
                            </div>
                            <div className="text-xs text-slate-400">
                                {timeline.length} beat(s)  {totalChapters} chapter(s)
                            </div>
                        </div>
                        <button 
                            onClick={() => {
                                const title = prompt('Beat title:');
                                if (title && currentProject) {
                                    const newBeat = {
                                        id: `beat-${Date.now()}`,
                                        title: title,
                                        lane: 'Main Plot',
                                        start: 1,
                                        duration: 1,
                                        color: 'bg-blue-500',
                                        type: 'beat'
                                    };
                                    const updatedProject = { ...currentProject };
                                    updatedProject.timeline = [...(updatedProject.timeline || []), newBeat];
                                    setCurrentProject(updatedProject);
                                    ProjectStorage.saveProject(updatedProject);
                                }
                            }}
                            className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded shadow-lg"
                        >
                            <Plus className="w-3 h-3" /> Add Beat
                        </button>
                    </div>

                    {!hasTimeline ? (
                        <div className="flex-1 flex items-center justify-center text-slate-500">
                            <div className="text-center">
                                <Layout className="w-16 h-16 mx-auto mb-4 opacity-30" />
                                <p className="text-lg mb-2">No timeline beats yet</p>
                                <p className="text-sm">Add story beats to visualize your narrative structure</p>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-x-auto overflow-y-hidden p-8 relative min-w-full bg-[#13151a]">
                            <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)', backgroundSize: '40px 40px' }}></div>
                            
                            <div className="flex flex-col gap-6 min-w-[1200px] relative z-10">
                                <div className="flex pl-24">
                                    {Array.from({ length: Math.max(10, totalChapters) }).map((_, ch) => (
                                        <div key={ch} className="w-48 text-xs font-bold text-slate-600 uppercase mb-2 border-b border-slate-800 pb-2">Ch {ch + 1}</div>
                                    ))}
                                </div>

                                {/* Main Plot Lane */}
                                <div className="flex items-center h-28 relative group">
                                    <div className="w-24 text-[10px] font-bold text-slate-400 text-right pr-4 uppercase tracking-wider">Main Plot</div>
                                    <div className="flex-1 bg-slate-900/50 rounded-lg h-24 flex items-center relative border border-slate-800/50 backdrop-blur-sm">
                                        {timeline.filter(t => t.lane === 'Main Plot').map(beat => (
                                            <div 
                                                key={beat.id}
                                                className={`absolute top-2 bottom-2 rounded-md p-3 ${beat.color || 'bg-blue-500'} shadow-lg cursor-grab hover:brightness-110 flex flex-col justify-between border-t border-white/10`}
                                                style={{ left: `${(beat.start - 1) * 12}rem`, width: `${beat.duration * 11}rem` }}
                                            >
                                                <span className="text-xs font-bold text-white/90 drop-shadow-md">{beat.title}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="h-40 bg-[#0f1116] border-t border-slate-800 p-4 relative">
                        <div className="absolute top-2 left-4 text-[10px] font-bold text-slate-500 uppercase flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-indigo-500"></span> Tension
                        </div>
                        <svg className="w-full h-full pt-4" viewBox="0 0 1000 100" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="gradientTension" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stopColor="#6366f1" stopOpacity="0.4" />
                                    <stop offset="100%" stopColor="#6366f1" stopOpacity="0" />
                                </linearGradient>
                            </defs>
                            <line x1="0" y1="50" x2="1000" y2="50" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />
                            <path d="M0,80 C100,80 150,20 200,30 C250,40 300,90 400,85 C500,80 600,10 700,20 C800,30 900,50 1000,40" fill="none" stroke="#6366f1" strokeWidth="2" />
                            <path d="M0,80 C100,80 150,20 200,30 C250,40 300,90 400,85 C500,80 600,10 700,20 C800,30 900,50 1000,40 L1000,100 L0,100 Z" fill="url(#gradientTension)" />
                        </svg>
                    </div>
                </div>
                );
            };



            // 5. INSIGHTS (STATS)
            const renderStats = () => (
                <div className="flex-1 bg-[#0b0c0f] p-12 overflow-y-auto">
                <header className="mb-10 flex justify-between items-end">
                    <div>
                        <h2 className="text-3xl font-bold text-white mb-2">Writer Analytics</h2>
                        <p className="text-slate-500">Productivity & Linguistic Texture Analysis</p>
                    </div>
                    <div className="flex gap-2">
                        <div className="px-4 py-2 bg-slate-800 rounded-lg border border-slate-700 text-center">
                            <div className="text-xs text-slate-500 uppercase">Streak</div>
                            <div className="font-bold text-emerald-400">12 Days</div>
                        </div>
                        <div className="px-4 py-2 bg-slate-800 rounded-lg border border-slate-700 text-center">
                            <div className="text-xs text-slate-500 uppercase">Words</div>
                            <div className="font-bold text-blue-400">{globalWordCount}</div>
                        </div>
                    </div>
                </header>
                
                <div className="grid grid-cols-2 gap-8">
                    {/* Heatmap */}
                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg">
                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-6 flex items-center gap-2"><Anchor className="w-4 h-4" /> Activity Heatmap (Year in Pixels)</h3>
                    <div className="grid grid-cols-[repeat(14,minmax(0,1fr))] gap-1.5 h-auto">
                        {Array.from({ length: 98 }).map((_, i) => (
                            <div 
                            key={i} 
                            className={`aspect-square rounded-sm transition-all hover:scale-125 ${Math.random() > 0.7 ? 'bg-emerald-500' : Math.random() > 0.5 ? 'bg-emerald-900' : 'bg-slate-800/50'}`}
                            title={`${Math.floor(Math.random() * 2000)} words`}
                            />
                        ))}
                    </div>
                    </div>

                    {/* Burn Down */}
                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden flex flex-col">
                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-6 flex items-center gap-2"><Target className="w-4 h-4" /> Adaptive Goal Tracking</h3>
                    <div className="flex items-end gap-3 flex-1 px-4 pb-4 border-b border-slate-800 mb-4">
                        {[40, 60, 45, 80, 30, 90, 100].map((h, i) => (
                            <div key={i} className="flex-1 bg-indigo-500/10 rounded-t relative group flex flex-col justify-end h-full">
                            <div className="bg-gradient-to-t from-indigo-600 to-indigo-400 rounded-t w-full transition-all duration-1000 relative" style={{ height: `${h}%` }}>
                                {i === 6 && <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-white bg-indigo-600 px-1.5 py-0.5 rounded">Today</div>}
                            </div>
                            </div>
                        ))}
                    </div>
                    <p className="text-xs text-slate-500 text-center italic">"You are 5% ahead of schedule. Weekend 'Surge' goal activated."</p>
                    </div>
                    
                    {/* Sentiment Analysis */}
                    <div className="col-span-2 bg-slate-900 p-8 rounded-2xl border border-slate-800 shadow-lg">
                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-6">Linguistic Texture (Rhythm Analysis)</h3>
                    <div className="h-12 w-full flex rounded-xl overflow-hidden opacity-90 mb-4">
                        <div className="w-[10%] bg-emerald-500 flex items-center justify-center text-[10px] text-emerald-900 font-bold">Short</div>
                        <div className="w-[20%] bg-amber-500 flex items-center justify-center text-[10px] text-amber-900 font-bold">Medium</div>
                        <div className="w-[50%] bg-emerald-500 flex items-center justify-center text-[10px] text-emerald-900 font-bold">Short</div>
                        <div className="w-[5%] bg-red-500 flex items-center justify-center text-[10px] text-white font-bold">!</div>
                        <div className="w-[15%] bg-amber-500 flex items-center justify-center text-[10px] text-amber-900 font-bold">Medium</div>
                    </div>
                    <div className="flex gap-8">
                        <div className="flex-1">
                            <p className="text-sm text-slate-400">
                                Visual representation of sentence length variation. High variation indicates dynamic flow.
                            </p>
                        </div>
                        <div className="flex gap-4">
                            <div className="flex items-center gap-2 text-xs text-emerald-400"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> Punchy</div>
                            <div className="flex items-center gap-2 text-xs text-amber-400"><div className="w-2 h-2 rounded-full bg-amber-500"></div> Flowing</div>
                            <div className="flex items-center gap-2 text-xs text-red-400"><div className="w-2 h-2 rounded-full bg-red-500"></div> Tedious</div>
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            );

            // -- MAIN LAYOUT COMPOSITION --
            
            return (
                <div className="h-screen w-full font-sans flex text-slate-300 bg-[#0b0c0f] selection:bg-indigo-500/30 overflow-hidden">
                
                {/* 1. App Rail (Navigation) */}
                <div className={`w-16 bg-[#050608] border-r border-slate-900 flex flex-col items-center py-6 gap-6 z-50 transition-all duration-500 ${focusMode ? '-translate-x-full absolute' : ''}`}>
                    <div title="Editor" onClick={() => setActiveTab('write')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'write' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <PenTool className="w-5 h-5" />
                    </div>
                    <div title="Architect (Timeline)" onClick={() => setActiveTab('plan')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'plan' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <Layout className="w-5 h-5" />
                    </div>
                    <div title="Story Codex" onClick={() => setActiveTab('world')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'world' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <Map className="w-5 h-5" />
                    </div>
                    <div title="Analytics" onClick={() => setActiveTab('stats')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'stats' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <BarChart2 className="w-5 h-5" />
                    </div>
                    
                    <div className="mt-auto flex flex-col gap-4 items-center">
                        <div className="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-[10px] font-bold text-slate-400 hover:border-indigo-500 cursor-pointer transition-colors">USER</div>
                    </div>
                </div>

                {/* 2. Secondary Sidebar (Binder) - Only in Write Mode */}
                {!focusMode && activeTab === 'write' && renderSidebar()}

                {/* 3. Main Workspace */}
                <main className="flex-1 flex flex-col relative overflow-hidden bg-[#0b0c0f]">
                    {activeTab === 'write' && renderEditor()}
                    {activeTab === 'plan' && renderTimeline()}
                    {activeTab === 'world' && <WorldView 
                        currentProject={currentProject}
                        setCurrentProject={setCurrentProject}
                        relationships={relationships}
                        setRelationships={setRelationships}
                        relationshipTimeline={relationshipTimeline}
                        setRelationshipTimeline={setRelationshipTimeline}
                        timelineIndex={timelineIndex}
                        setTimelineIndex={setTimelineIndex}
                        showRelationshipEditor={showRelationshipEditor}
                        setShowRelationshipEditor={setShowRelationshipEditor}
                        aiProvider={aiProvider}
                        selectedModel={selectedModel}
                        hfModel={hfModel}
                        githubModel={githubModel}
                        availableModels={availableModels}
                        HF_MODELS={HF_MODELS}
                        GITHUB_MODELS={GITHUB_MODELS}
                        setSelectedModel={setSelectedModel}
                        setHfModel={setHfModel}
                        setGithubModel={setGithubModel}
                        analyzeRelationships={analyzeRelationships}
                        isAiLoading={isAiLoading}
                        analysisScope={analysisScope}
                        setAnalysisScope={setAnalysisScope}
                    />}
                    {activeTab === 'stats' && renderStats()}
                </main>
                
                {/* Project Modal */}
                {showProjectModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                        <div className="bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                            <div className="p-6 border-b border-slate-700 flex items-center justify-between">
                                <h2 className="text-2xl font-bold text-white">Your Projects</h2>
                                <button 
                                    onClick={() => setShowProjectModal(false)}
                                    className="text-slate-400 hover:text-white"
                                >
                                    <X className="w-6 h-6" />
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {projects.map(project => (
                                        <div 
                                            key={project.id}
                                            onClick={() => {
                                                setCurrentProject(project);
                                                if (project.sections.length > 0) {
                                                    setSelectedSectionId(project.sections[0].id);
                                                    if (project.sections[0].chapters.length > 0) {
                                                        setSelectedChapterId(project.sections[0].chapters[0].id);
                                                    }
                                                }
                                                setShowProjectModal(false);
                                            }}
                                            className={`p-4 rounded-xl border-2 cursor-pointer transition-all ${
                                                currentProject && currentProject.id === project.id 
                                                    ? 'border-indigo-500 bg-indigo-500/10' 
                                                    : 'border-slate-700 hover:border-slate-600 bg-slate-800/50'
                                            }`}
                                        >
                                            <h3 className="text-lg font-bold text-white mb-2">{project.name}</h3>
                                            <div className="flex items-center gap-4 text-xs text-slate-400 mb-2">
                                                <span>{project.sections.length} section(s)</span>
                                                <span></span>
                                                <span>{project.sections.reduce((acc, s) => acc + s.chapters.length, 0)} chapter(s)</span>
                                            </div>
                                            <div className="text-xs text-slate-500">
                                                Modified: {new Date(project.lastModified).toLocaleDateString()}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <button 
                                    onClick={() => {
                                        const name = prompt('Project name:', 'My New Novel');
                                        if (name) {
                                            const newProject = ProjectStorage.createProject(name);
                                            setProjects([...projects, newProject]);
                                            setCurrentProject(newProject);
                                            setSelectedSectionId(newProject.sections[0].id);
                                            setSelectedChapterId(newProject.sections[0].chapters[0].id);
                                            setShowProjectModal(false);
                                        }
                                    }}
                                    className="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                                >
                                    <Plus className="w-5 h-5" />
                                    Create New Project
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NarrativeOS />);
    </script>
</body>
</html>
