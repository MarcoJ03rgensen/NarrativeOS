<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Narrative - Creative Writing Platform</title>
    
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="manifest" href="site.webmanifest">
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Narrative - A powerful AI-assisted creative writing platform for novelists and storytellers. Build timelines, manage characters, track relationships, and craft your story with intelligent writing assistance.">
    <meta name="keywords" content="creative writing software, novel writing app, AI writing assistant, story planning tool, character development, timeline builder, narrative design, fiction writing, storytelling platform, writer tool, screenwriting software, book writing software, manuscript editor, plot structure tool, story arc planner, worldbuilding tool, writing productivity, author software, creative writing app, narrative structure, story organizer, writing assistant, plot development, character creator, relationship mapper, storyline, story beats, writing collaboration, cloud writing tool, novelist software, fantasy writing, sci-fi writing, romance writing, thriller writing, nanowrimo tool, writing project manager, story codex, writing dashboard, creative suite, author platform, manuscript management, chapter organizer, AI plot analysis, AI story suggestions, Gemini AI writing, automated plot structure, AI character analysis, intelligent story planning, AI-powered timeline, machine learning writing, AI beat suggestions, AI relationship mapping, GPT writing tool, AI narrative assistant, automated story development, AI story architect, neural writing assistant, smart writing platform, AI content generation, predictive story tools">
    <meta name="author" content="Marco Jørgensen">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://narrativeos.com">
    
    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:title" content="Narrative - Creative Writing Platform">
    <meta property="og:description" content="Build your story with AI assistance. Manage characters, plot timelines, and track relationships in one comprehensive writing environment.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://narrativeos.com">
    <meta property="og:image" content="https://narrativeos.com/android-chrome-512x512.png">
    <meta property="og:site_name" content="Narrative">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Narrative - Creative Writing Platform">
    <meta name="twitter:description" content="Build your story with AI assistance. Manage characters, plot timelines, and track relationships.">
    <meta name="twitter:image" content="https://narrativeos.com/android-chrome-512x512.png">
    
    <!-- Structured Data (JSON-LD) for Google -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
    "name": "Narrative - Creative Writing Platform",
      "applicationCategory": "CreativeWork",
      "operatingSystem": "Web Browser",
      "description": "AI-assisted creative writing platform for novelists featuring timeline building, character management, relationship tracking, and intelligent writing assistance.",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Person",
        "name": "Marco Jørgensen"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "5",
        "ratingCount": "1"
      },
      "featureList": [
        "AI-powered plot analysis",
        "Character relationship mapping",
        "Interactive timeline builder",
        "Story beat suggestions",
        "Firebase Cloud Sync",
        "Real-time word count tracking",
        "Daily writing statistics"
      ]
    }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: #334155;
            border-radius: 20px;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .shadow-glow {
            box-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Editor Title Styling */
        [contenteditable] [data-format="title"] {
            font-size: 2rem !important;
            font-weight: bold !important;
            color: #1e293b !important;
            margin-bottom: 0.5rem !important;
            line-height: 1.2 !important;
            display: block;
        }
        [contenteditable] [data-format="subtitle"] {
            font-size: 1.25rem !important;
            font-style: italic !important;
            color: #64748b !important;
            margin-bottom: 1rem !important;
            line-height: 1.4 !important;
            display: block;
        }
        [contenteditable] h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin: 1.5rem 0 1rem 0;
            line-height: 1.2;
            font-family: Georgia, serif;
            border-bottom: 3px solid #4f46e5;
            padding-bottom: 0.5rem;
        }
        [contenteditable] h2 {
            font-size: 2rem;
            font-weight: 600;
            color: #334155;
            margin: 1.25rem 0 0.75rem 0;
            line-height: 1.3;
            font-family: Georgia, serif;
        }
        [contenteditable] h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #475569;
            margin: 1rem 0 0.5rem 0;
            line-height: 1.4;
        }
        [contenteditable] p {
            margin: 0.75rem 0;
            line-height: 1.8;
        }
    </style>
</head>
<body class="bg-[#0b0c0f] text-slate-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            BookOpen, Layout, Map, BarChart2, Settings, ChevronRight, ChevronDown, 
            Plus, MoreHorizontal, User, Search, Maximize2, Minimize2, Mic, Eye, 
            EyeOff, GitBranch, Target, Clock, Zap, Coffee, Cloud, Save, PenTool, 
            Anchor, Volume2, Image as ImageIcon, MessageSquare, AlertTriangle, 
            RefreshCcw, Play, Pause, Headphones,
            Bold, Italic, Underline, AlignLeft, AlignCenter, AlignRight, 
            AlignJustify, FileUp, CloudLightning, Check, MoreVertical,
            Undo, Redo, Printer, FileText,
            List, ListOrdered, Indent, Outdent, Link as LinkIcon, 
            RemoveFormatting, Strikethrough, Subscript, Superscript, 
            Table as TableIcon, Type, Highlighter, Heading1, Palette,
            Maximize, Minimize, FileDown, X, Loader2, Trash2, ExternalLink, CloudOff, Lightbulb, Database, LogOut, Github
        } from 'https://esm.sh/lucide-react@0.263.1';
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, doc, getDocs, getDoc, addDoc, setDoc, updateDoc, 
            onSnapshot, query, where, orderBy, enableIndexedDbPersistence, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, signInWithPopup, GithubAuthProvider, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        /**
         * NARRATIVE OS: ULTIMATE EDITION
         * A Next-Generation Visual Book Writing Platform Prototype
         */

        // --- PROJECT DATA STRUCTURE ---
        
        const DEFAULT_PROJECT = {
            id: 'default-project',
            name: 'My Novel',
            created: Date.now(),
            lastModified: Date.now(),
            sections: [
                {
                    id: 'section-1',
                    name: 'Part I: The Beginning',
                    chapters: [
                        {
                            id: 'ch-1',
                            title: 'Chapter 1',
                            subtitle: '',
                            content: '<h1>Chapter 1</h1><p>Start writing your story here...</p>',
                            status: 'draft',
                            targetWords: 2500,
                            characterTags: [],
                            notes: ''
                        }
                    ]
                }
            ],
            characters: [],
            locations: [],
            timeline: [],
            settings: {
                targetWords: 80000,
                genre: '',
                theme: ''
            },
            driveFileId: null
        };

        // Storage Management
        const ProjectStorage = {
            getAllProjects() {
                const stored = localStorage.getItem('narrativeos-projects');
                if (!stored) {
                    const defaultProj = { ...DEFAULT_PROJECT };
                    // Save directly without calling getAllProjects
                    localStorage.setItem('narrativeos-projects', JSON.stringify([defaultProj]));
                    return [defaultProj];
                }
                return JSON.parse(stored);
            },
            
            saveProject(project) {
                project.lastModified = Date.now();
                const stored = localStorage.getItem('narrativeos-projects');
                const projects = stored ? JSON.parse(stored) : [];
                const filtered = projects.filter(p => p.id !== project.id);
                filtered.push(project);
                localStorage.setItem('narrativeos-projects', JSON.stringify(filtered));
            },
            
            saveAllProjects(projects) {
                localStorage.setItem('narrativeos-projects', JSON.stringify(projects));
            },
            
            getProject(id) {
                const projects = this.getAllProjects();
                return projects.find(p => p.id === id) || DEFAULT_PROJECT;
            },
            
            createProject(name) {
                const project = {
                    ...DEFAULT_PROJECT,
                    id: `project-${Date.now()}`,
                    name: name,
                    created: Date.now(),
                    lastModified: Date.now(),
                    driveFileId: null,
                    sections: [
                        {
                            id: 'section-1',
                            name: 'Part I: The Beginning',
                            chapters: [
                                {
                                    id: 'ch-1',
                                    title: 'Chapter 1',
                                    subtitle: '',
                                    content: '<h1>Chapter 1</h1><p>Start writing your story here...</p>',
                                    status: 'draft',
                                    targetWords: 2500,
                                    characterTags: [],
                                    notes: ''
                                }
                            ]
                        }
                    ]
                };
                this.saveProject(project);
                return project;
            }
        };

        // Normalize projects loaded from storage to avoid missing fields breaking UI
        const normalizeProject = (project) => {
            if (!project) return null;
            const normalized = { ...project };
            // Ensure sections
            if (!Array.isArray(normalized.sections) || normalized.sections.length === 0) {
                normalized.sections = [...DEFAULT_PROJECT.sections];
            } else {
                normalized.sections = normalized.sections.map((sec, idx) => ({
                    id: sec.id || `section-${idx + 1}`,
                    name: sec.name || `Section ${idx + 1}`,
                    chapters: Array.isArray(sec.chapters) && sec.chapters.length > 0 ? sec.chapters.map((ch, cidx) => ({
                        id: ch.id || `ch-${idx + 1}-${cidx + 1}`,
                        title: ch.title || `Chapter ${cidx + 1}`,
                        subtitle: ch.subtitle || '',
                        content: ch.content || '<p></p>',
                        status: ch.status || 'draft',
                        targetWords: ch.targetWords || 0,
                        characterTags: ch.characterTags || [],
                        notes: ch.notes || ''
                    })) : [...DEFAULT_PROJECT.sections[0].chapters]
                }));
            }
            // Ensure timeline array
            if (!Array.isArray(normalized.timeline)) normalized.timeline = [];
            return normalized;
        };

        // Stats Management
        const StatsStorage = {
            getHistory() {
                const stored = localStorage.getItem('narrativeos-stats');
                return stored ? JSON.parse(stored) : {};
            },
            saveHistory(history) {
                localStorage.setItem('narrativeos-stats', JSON.stringify(history));
            },
            initializeToday(currentTotalWords) {
                const history = this.getHistory();
                const today = new Date().toISOString().split('T')[0];
                
                if (!history[today]) {
                    history[today] = {
                        date: today,
                        startWords: currentTotalWords,
                        currentWords: currentTotalWords,
                        netWords: 0,
                        goal: 500 // Default goal
                    };
                    this.saveHistory(history);
                }
                return history;
            },
            updateWordCount(currentTotalWords) {
                const history = this.getHistory();
                const today = new Date().toISOString().split('T')[0];
                
                if (!history[today]) {
                    this.initializeToday(currentTotalWords);
                    return this.getHistory();
                }

                history[today].currentWords = currentTotalWords;
                // If startWords is missing (legacy data), set it to current
                if (history[today].startWords === undefined) history[today].startWords = currentTotalWords;
                
                history[today].netWords = currentTotalWords - history[today].startWords;
                this.saveHistory(history);
                return history;
            },
            setGoal(goal) {
                const history = this.getHistory();
                const today = new Date().toISOString().split('T')[0];
                if (history[today]) {
                    history[today].goal = parseInt(goal);
                    this.saveHistory(history);
                    return history;
                }
                return history;
            },
            getStreak() {
                const history = this.getHistory();
                const activeDays = Object.values(history)
                    .filter(d => d.netWords > 0)
                    .map(d => d.date)
                    .sort((a, b) => new Date(b) - new Date(a)); // Descending
                    
                if (activeDays.length === 0) return 0;
                
                const todayStr = new Date().toISOString().split('T')[0];
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                // If the most recent active day is not today or yesterday, streak is broken (0)
                if (activeDays[0] !== todayStr && activeDays[0] !== yesterdayStr) {
                    return 0;
                }
                
                let currentStreak = 0;
                let lastDate = null;
                
                for (const dateStr of activeDays) {
                    if (!lastDate) {
                        lastDate = new Date(dateStr);
                        currentStreak++;
                        continue;
                    }
                    
                    const curr = new Date(dateStr);
                    const diffTime = Math.abs(lastDate - curr);
                    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24)); 
                    
                    if (diffDays === 1) {
                        currentStreak++;
                        lastDate = curr;
                    } else {
                        break;
                    }
                }
                return currentStreak;
            }
        };

        // --- UTILITY COMPONENTS ---

        const ProgressBar = ({ current, max, color = 'bg-blue-500' }) => {
            const percent = Math.min((current / max) * 100, 100);
            return (
                <div className="h-1 w-full bg-slate-800 rounded-full overflow-hidden mt-1">
                <div className={`h-full ${color} transition-all duration-500`} style={{ width: `${percent}%` }} />
                </div>
            );
        };

        // --- EDITOR COMPONENTS ---

        const Tooltip = ({ children, text }) => (
          <div className="group relative flex flex-col items-center">
            {children}
            <div className="absolute top-full mt-2 hidden flex-col items-center group-hover:flex z-50 pointer-events-none">
              <span className="relative z-10 p-2 text-xs leading-none text-white whitespace-no-wrap bg-gray-900 shadow-lg rounded-md border border-gray-700">
                {text}
              </span>
              <div className="w-3 h-3 -mt-2 rotate-45 bg-gray-900 border-l border-t border-gray-700"></div>
            </div>
          </div>
        );

        const IconButton = ({ onClick, icon: Icon, active, tooltip, color }) => (
          <Tooltip text={tooltip}>
            <button
              onMouseDown={(e) => e.preventDefault()} 
              onClick={onClick}
              className={`p-2 rounded-xl transition-all duration-200 ease-in-out border border-transparent ${
                active 
                  ? 'bg-purple-600 text-white shadow-lg shadow-purple-500/30' 
                  : 'hover:bg-white/10 hover:border-white/10 text-gray-400 hover:text-white hover:shadow-sm'
              }`}
            >
              <Icon className="w-4 h-4" color={color} />
            </button>
          </Tooltip>
        );

        const Divider = () => <div className="w-px h-6 bg-white/10 mx-2 self-center"></div>;

        function WordEditor({ 
            initialContent, 
            onStatsUpdate, 
            onContentChange, 
            projectName, 
            geminiApiKey, 
            setGeminiApiKey, 
            availableModels, 
            selectedModel, 
            setSelectedModel, 
            aiProvider, 
            setAiProvider, 
            hfToken, 
            setHfToken, 
            hfModel, 
            setHfModel, 
            HF_MODELS, 
            githubToken, 
            setGithubToken, 
            githubModel, 
            setGithubModel, 
            GITHUB_MODELS, 
            isConnectedToCloud, // Changed from isConnectedToDrive
            onConnectCloud,     // Changed from onConnectDrive
            userInfo, 
            setUserInfo 
        }) {
          const [content, setContent] = useState(initialContent || '');
          const [fileName, setFileName] = useState(projectName || 'Untitled Project');
          const [isDirty, setIsDirty] = useState(false);
          const [syncStatus, setSyncStatus] = useState('saved'); 
          const [showCloudModal, setShowCloudModal] = useState(false);
          const [wordCount, setWordCount] = useState(0);
          const [charCount, setCharCount] = useState(0);
          const [focusMode, setFocusMode] = useState(false);
          const [showFind, setShowFind] = useState(false);
          const [findTerm, setFindTerm] = useState('');
          
          // Narrative Features State
          const [splitScreen, setSplitScreen] = useState(false);
          const [showAiPanel, setShowAiPanel] = useState(false);
          const [ambientSound, setAmbientSound] = useState(null);
          const [textMode, setTextMode] = useState('normal'); // normal, rhythm, hemingway, blind, dialogue

          const audioRef = useRef(null);

          // Ambient Sound Effect
          useEffect(() => {
              if (ambientSound) {
                  console.log(`Playing ambient sound: ${ambientSound}`);
              }
          }, [ambientSound]);
          
          // AI State
          const [aiPrompt, setAiPrompt] = useState('');
          const [isAiLoading, setIsAiLoading] = useState(false);
          const [chatHistory, setChatHistory] = useState([]);
          const [showChat, setShowChat] = useState(false);

          const editorRef = useRef(null);
          const imageInputRef = useRef(null);
          
          // Sync filename with project name
          useEffect(() => {
              setFileName(projectName || 'Untitled Project');
          }, [projectName]);

          // Initialize Content
          useEffect(() => {
            if (initialContent) {
                if (editorRef.current) editorRef.current.innerHTML = initialContent;
                setContent(initialContent);
                updateStats(initialContent);
            }
          }, [initialContent]);

          // Auto-save
          useEffect(() => {
            const interval = setInterval(() => {
              if (isDirty) {
                setSyncStatus('syncing');
                
                // Save via callback
                if (onContentChange) {
                    onContentChange(content);
                }
                
                setTimeout(() => {
                    setIsDirty(false);
                    setSyncStatus('saved');
                }, 800);
              }
            }, 5000); // Auto-save every 5s
            return () => clearInterval(interval);
          }, [content, isDirty, onContentChange]);

          const updateStats = (htmlContent) => {
            const text = htmlContent.replace(/<[^>]*>/g, ' ').trim();
            const w = text ? text.split(/\s+/).length : 0;
            const c = text.replace(/\s/g, '').length;
            setWordCount(w);
            setCharCount(c);
            if (onStatsUpdate) onStatsUpdate(w, c);
          };

          const handleInput = (e) => {
            const newContent = e.currentTarget.innerHTML;
            setContent(newContent);
            setIsDirty(true);
            setSyncStatus('unsaved');
            updateStats(newContent);
            
            // Extract and update title/subtitle if they exist
            const parser = new DOMParser();
            const doc = parser.parseFromString(newContent, 'text/html');
            const titleElement = doc.querySelector('[data-format="title"]');
            const subtitleElement = doc.querySelector('[data-format="subtitle"]');
            
            if (titleElement || subtitleElement) {
              const newTitle = titleElement ? titleElement.textContent.trim() : null;
              const newSubtitle = subtitleElement ? subtitleElement.textContent.trim() : null;
              
              // Notify parent to update chapter metadata
              if (onContentChange) {
                onContentChange(newContent, newTitle, newSubtitle);
              }
            }
          };

          const execCmd = (command, value = null) => {
            document.execCommand(command, false, value);
            if (editorRef.current) {
              setTimeout(() => editorRef.current.focus(), 0); 
            }
            if (editorRef.current) {
              handleInput({ currentTarget: editorRef.current });
            }
          };

          const handleInsertImage = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const imgHtml = `<img src="${e.target.result}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;" />`;
                execCmd('insertHTML', imgHtml);
              };
              reader.readAsDataURL(file);
            }
            e.target.value = null;
          };

          const handleInsertTable = () => {
            const rows = 3;
            const cols = 3;
            let tableHTML = '<table style="width:100%; border-collapse: collapse; margin: 1rem 0; border: 1px solid #e2e8f0;"><tbody>';
            for(let i=0; i<rows; i++){
                tableHTML += '<tr>';
                for(let j=0; j<cols; j++){
                    tableHTML += '<td style="border: 1px solid #e2e8f0; padding: 12px; min-width: 50px;">Cell</td>';
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</tbody></table><p><br/></p>';
            execCmd('insertHTML', tableHTML);
          };

          const handleSaveLocal = () => {
            const blob = new Blob([`
              <!DOCTYPE html>
              <html>
              <head>
                <title>${fileName}</title>
                <style>
                  body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; line-height: 1.6; color: #333; }
                  table { width: 100%; border-collapse: collapse; }
                  td, th { border: 1px solid #ccc; padding: 8px; }
                  img { max-width: 100%; }
                </style>
              </head>
              <body>${content}</body>
              </html>
            `], { type: 'text/html' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.html`;
            a.click();
            URL.revokeObjectURL(url);
            setSyncStatus('saved');
          };

          const handleSaveTxt = () => {
             const text = editorRef.current.innerText;
             const blob = new Blob([text], { type: 'text/plain' });
             const url = URL.createObjectURL(blob);
             const a = document.createElement('a');
             a.href = url;
             a.download = `${fileName}.txt`;
             a.click();
             URL.revokeObjectURL(url);
          };

          const handleOpenLocal = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const text = e.target.result;
                if (text.trim().startsWith('<')) {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const newContent = doc.body.innerHTML;
                    if (editorRef.current) editorRef.current.innerHTML = newContent;
                    setContent(newContent);
                    updateStats(newContent);
                } else {
                    const newContent = text.replace(/\n/g, '<br/>');
                    if (editorRef.current) editorRef.current.innerHTML = newContent;
                    setContent(newContent);
                    updateStats(newContent);
                }
                setFileName(file.name.replace(/\.[^/.]+$/, ""));
              };
              reader.readAsText(file);
            }
          };

          const handleFind = () => {
            if (window.find && findTerm) {
                window.find(findTerm);
            }
          };
          
          const getReadingTime = () => {
              const wordsPerMinute = 200;
              const minutes = Math.ceil(wordCount / wordsPerMinute);
              return minutes + ' min read';
          };

          // Render Visual Mode Overlay
          const renderVisualOverlay = () => {
              if (textMode === 'normal') return null;
              
              const text = editorRef.current ? editorRef.current.innerText : content.replace(/<[^>]*>/g, ' ');
              
              if (textMode === 'blind') {
                  return (
                      <div className="absolute inset-0 bg-white z-10 p-[25mm] font-serif text-lg leading-relaxed whitespace-pre-wrap pointer-events-none overflow-hidden">
                          <span className="blur-sm select-none opacity-50">{text.slice(0, -100)}</span>
                          <span className="blur-none">{text.slice(-100)}</span>
                      </div>
                  );
              }

              // Dialogue highlighting mode
              if (textMode === 'dialogue') {
                  const dialogueRegex = /([\"'])(.*?)\1|(".*?")/g;
                  const parts = [];
                  let lastIndex = 0;
                  let match;
                  
                  while ((match = dialogueRegex.exec(text)) !== null) {
                      if (match.index > lastIndex) {
                          parts.push({ text: text.slice(lastIndex, match.index), isDialogue: false });
                      }
                      parts.push({ text: match[0], isDialogue: true });
                      lastIndex = match.index + match[0].length;
                  }
                  if (lastIndex < text.length) {
                      parts.push({ text: text.slice(lastIndex), isDialogue: false });
                  }
                  
                  return (
                      <div className="absolute inset-0 bg-white z-10 p-[25mm] font-serif text-lg leading-relaxed whitespace-pre-wrap pointer-events-none overflow-y-auto">
                          {parts.map((part, i) => (
                              <span key={i} className={part.isDialogue ? 'bg-cyan-400/30 border-l-4 border-cyan-500 pl-1 font-medium text-cyan-900' : ''}>
                                  {part.text}
                              </span>
                          ))}
                      </div>
                  );
              }
              
              const sentences = text.split(/(?<=[.!?])\s+/);
              return (
                  <div className="absolute inset-0 bg-white z-10 p-[25mm] font-serif text-lg leading-relaxed whitespace-pre-wrap pointer-events-none overflow-y-auto">
                      {sentences.map((s, i) => {
                          let className = "";
                          if (textMode === 'rhythm') {
                              const wc = s.split(' ').length;
                              if (wc < 8) className = "bg-emerald-500/20 border-b-2 border-emerald-500/50";
                              else if (wc > 25) className = "bg-red-500/20 border-b-2 border-red-500/50";
                              else className = "bg-yellow-500/20 border-b-2 border-yellow-500/50";
                          } else if (textMode === 'hemingway') {
                              if (s.includes('ly')) className = "bg-blue-500/20 text-blue-200";
                              if (s.includes('was') || s.includes('were')) className = "bg-pink-500/20 text-pink-200";
                          }
                          return <span key={i} className={`rounded px-0.5 ${className}`}>{s} </span>
                      })}
                  </div>
              );
          };

          const handleAiSubmit = async (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!aiPrompt.trim()) return;
                
                if (aiProvider === 'gemini' && !geminiApiKey) {
                    alert('Please enter your Google Gemini API Key first.');
                    return;
                }
                if (aiProvider === 'huggingface' && !hfToken) {
                    alert('Please enter your Hugging Face Token first.');
                    return;
                }
                if (aiProvider === 'github' && !githubToken) {
                    alert('Please enter your GitHub Personal Access Token first.');
                    return;
                }

                const userMessage = { role: 'user', text: aiPrompt };
                setChatHistory(prev => [...prev, userMessage]);
                setAiPrompt('');
                setIsAiLoading(true);

                try {
                    let aiText = "";

                    if (aiProvider === 'gemini') {
                        // Handle model name format (ensure it starts with models/)
                        const modelPath = selectedModel.startsWith('models/') ? selectedModel : `models/${selectedModel}`;
                        
                        // Construct history for API
                        const contents = chatHistory.map(msg => ({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.text }]
                        }));
                        
                        // Add current prompt
                        contents.push({
                            role: 'user',
                            parts: [{ text: `Context: The user is writing a story. Here is the current content: ${content.substring(0, 5000)}... (truncated). 
                            
                            Task: ${userMessage.text}` }]
                        });

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${modelPath}:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                contents,
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_CIVIC_INTEGRITY", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });

                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message);
                        }

                        if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                            aiText = data.candidates[0].content.parts[0].text;
                        }
                    } else if (aiProvider === 'github') {
                        // GitHub Models (Azure AI Inference)
                        const messages = [
                            { role: "system", content: `You are a creative writing assistant. Context: ${content.substring(0, 2000)}...` },
                            ...chatHistory.map(msg => ({ role: msg.role === 'model' ? 'assistant' : 'user', content: msg.text })),
                            { role: "user", content: userMessage.text }
                        ];

                        const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${githubToken}`
                            },
                            body: JSON.stringify({
                                messages: messages,
                                model: githubModel,
                                temperature: 0.7,
                                max_tokens: 1000
                            })
                        });

                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`GitHub Models Error ${response.status}: ${errorText}`);
                        }

                        const data = await response.json();
                        aiText = data.choices[0].message.content;

                    } else {
                        // Hugging Face
                        const promptText = `[INST] You are a creative writing assistant. Context: ${content.substring(0, 2000)}... Task: ${userMessage.text} [/INST]`;
                        
                        try {
                            // Helper function for retrying with delay
                            const fetchWithRetry = async (retries = 5) => {
                                const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
                                    method: "POST",
                                    headers: {
                                        "Authorization": `Bearer ${hfToken}`,
                                        "Content-Type": "application/json",
                                        "x-use-cache": "false"
                                    },
                                    body: JSON.stringify({ 
                                        inputs: promptText,
                                        parameters: {
                                            max_new_tokens: 500,
                                            return_full_text: false,
                                            temperature: 0.7
                                        }
                                    }),
                                });

                                if (response.status === 503) {
                                    const data = await response.json();
                                    if (retries > 0 && data.estimated_time) {
                                        console.log(`Model loading... waiting ${data.estimated_time}s`);
                                        await new Promise(r => setTimeout(r, (data.estimated_time * 1000) + 1000));
                                        return fetchWithRetry(retries - 1);
                                    }
                                }

                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`HF Error ${response.status}: ${errorText}`);
                                }

                                return response.json();
                            };

                            const result = await fetchWithRetry();
                            
                            if (result.error) throw new Error(result.error);
                            aiText = Array.isArray(result) ? result[0].generated_text : result.generated_text;
                            
                            // Clean up [INST] tags if model returns them
                            aiText = aiText.replace(/\[INST\].*?\[\/INST\]/s, '').trim();

                        } catch (hfErr) {
                            console.error("Hugging Face Fetch Error:", hfErr);
                            if (hfErr.message.includes('Failed to fetch')) {
                                throw new Error(`CORS/Network Error. Hugging Face blocked the browser request. Please try using Gemini (Google) which works reliably in the browser, or check the README for the CORS extension workaround.`);
                            }
                            throw new Error(`Failed to connect to Hugging Face. ${hfErr.message}.`);
                        }
                    }

                    setChatHistory(prev => [...prev, { role: 'model', text: aiText }]);

                } catch (error) {
                    console.error('AI Error:', error);
                    setChatHistory(prev => [...prev, { role: 'model', text: `Error: ${error.message}` }]);
                } finally {
                    setIsAiLoading(false);
                }
            }
          };



          return (
            <div className="flex flex-col h-full overflow-hidden font-sans text-slate-800 bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 selection:bg-purple-500/30 selection:text-white">
              
              {/* --- Glassy Header --- */}
              {!focusMode && (
              <div className="flex items-center justify-between px-6 py-3 bg-black/20 backdrop-blur-md border-b border-white/5 shadow-sm z-20">
                <div className="flex items-center space-x-4">
                  <div className="bg-gradient-to-br from-purple-600 to-indigo-700 p-2.5 rounded-xl shadow-lg shadow-black/20">
                    <FileText className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <input 
                      type="text" 
                      value={fileName} 
                      onChange={(e) => setFileName(e.target.value)}
                      className="text-lg font-bold text-gray-200 placeholder-gray-500 border-b-2 border-transparent hover:border-gray-500 focus:border-purple-500 focus:outline-none bg-transparent transition-all truncate w-48 sm:w-64"
                    />
                    <div className="flex items-center space-x-3 text-xs font-medium text-gray-400 mt-1">
                      <button className="hover:text-white transition-colors">File</button>
                      <button className="hover:text-white transition-colors">Edit</button>
                      <button className="hover:text-white transition-colors">View</button>
                      <button className="hover:text-white transition-colors">Insert</button>
                    </div>
                  </div>
                </div>

                <div className="flex items-center space-x-4">
                  {/* Narrative Tools */}
                  <div className="flex items-center bg-black/30 rounded-full p-1 border border-white/5 mr-4">
                      <button 
                          onClick={() => {
                              if (textMode === 'normal') setTextMode('rhythm');
                              else if (textMode === 'rhythm') setTextMode('dialogue');
                              else setTextMode('normal');
                          }}
                          className={`p-2 rounded-full transition-all ${textMode === 'rhythm' ? 'bg-indigo-600 text-white' : textMode === 'dialogue' ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white'}`}
                          title={textMode === 'normal' ? 'Enable Rhythm Mode' : textMode === 'rhythm' ? 'Enable Dialogue Mode' : 'Disable Visual Mode'}
                      >
                          <BarChart2 className="w-4 h-4" />
                      </button>
                      <button 
                          onClick={() => setAmbientSound(ambientSound === 'rain' ? null : 'rain')}
                          className={`p-2 rounded-full transition-all ${ambientSound === 'rain' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                          title="Ambient Sound"
                      >
                          <Cloud className="w-4 h-4" />
                      </button>
                      <button 
                          onClick={() => setSplitScreen(!splitScreen)}
                          className={`p-2 rounded-full transition-all ${splitScreen ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}`}
                          title="Split Screen"
                      >
                          <Layout className="w-4 h-4" />
                      </button>
                  </div>

                  <div className="hidden md:flex items-center text-xs font-medium mr-2 bg-black/30 text-gray-300 px-3 py-1.5 rounded-full border border-white/5 backdrop-blur-md">
                    {syncStatus === 'syncing' && (
                      <span className="flex items-center animate-pulse text-blue-400">
                        <CloudLightning className="w-3 h-3 mr-1.5" /> Syncing...
                      </span>
                    )}
                    {syncStatus === 'saved' && (
                      <span className="flex items-center text-emerald-400">
                        <Check className="w-3 h-3 mr-1.5" /> Saved locally
                      </span>
                    )}
                    {syncStatus === 'unsaved' && (
                      <span className="text-amber-400">Unsaved changes</span>
                    )}
                  </div>

                  <button 
                    onClick={onConnectCloud}
                    className={`flex items-center space-x-2 px-4 py-2 rounded-full text-sm font-semibold transition-all shadow-lg ${
                      isConnectedToCloud 
                        ? 'bg-emerald-500/20 text-emerald-300 border border-emerald-500/30 hover:bg-emerald-500/30' 
                        : 'bg-white/5 text-gray-300 border border-white/10 hover:bg-white/10 hover:text-white'
                    }`}
                  >
                    {isConnectedToCloud ? <Cloud className="w-4 h-4" /> : <CloudOff className="w-4 h-4" />}
                    <span className="hidden sm:inline">{isConnectedToCloud ? 'Cloud Synced' : 'Connect Cloud'}</span>
                  </button>
                  
                  <div className="w-9 h-9 rounded-full bg-gradient-to-tr from-purple-500 to-indigo-500 text-white flex items-center justify-center text-sm font-bold shadow-md ring-2 ring-white/10 cursor-pointer hover:scale-105 transition-transform" title={userInfo ? `Signed in as ${userInfo.displayName} (${userInfo.emailAddress})` : 'Not signed in'}>
                    {userInfo ? (userInfo.photoLink ? <img src={userInfo.photoLink} className="w-full h-full rounded-full" alt="User" /> : userInfo.displayName.charAt(0)) : <img src="N.svg" alt="Narrative" className="w-6 h-6" />}
                  </div>
                </div>
              </div>
              )}

              {/* --- Reconnection Banner --- */}
              {!isConnectedToCloud && !focusMode && (
              <div className="bg-amber-500/10 border-b border-amber-500/30 px-6 py-3 flex items-center justify-between animate-in slide-in-from-top">
                <div className="flex items-center gap-3">
                  <CloudOff className="w-5 h-5 text-amber-400" />
                  <div>
                    <p className="text-sm font-medium text-amber-200">Offline Mode</p>
                    <p className="text-xs text-amber-300/80">Projects are saved locally. Connect to sync across devices.</p>
                  </div>
                </div>
                <button 
                  onClick={onConnectCloud}
                  className="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-medium text-sm transition-colors flex-shrink-0"
                >
                  Connect Cloud
                </button>
              </div>
              )}

              {/* --- Glassy Toolbar --- */}
              {!focusMode && (
              <div className="flex items-center px-6 py-2 bg-black/20 backdrop-blur-md border-b border-white/5 overflow-x-auto gap-2 shadow-sm z-10 no-scrollbar">
                
                <div className="flex items-center space-x-1 pr-2">
                  <IconButton onClick={() => execCmd('undo')} icon={Undo} tooltip="Undo" />
                  <IconButton onClick={() => execCmd('redo')} icon={Redo} tooltip="Redo" />
                  <IconButton onClick={() => window.print()} icon={Printer} tooltip="Print" />
                </div>

                <Divider />

                <div className="flex items-center space-x-2 pr-2 pl-2">
                  <div className="relative group">
                     <select 
                       onChange={(e) => {
                         const value = e.target.value;
                         if (value === 'title' || value === 'subtitle') {
                           // Mark as special format
                           execCmd('formatBlock', 'p');
                           const selection = window.getSelection();
                           if (selection.rangeCount > 0) {
                             const range = selection.getRangeAt(0);
                             const container = range.commonAncestorContainer;
                             const element = container.nodeType === 3 ? container.parentNode : container;
                             element.setAttribute('data-format', value);
                             if (value === 'title') {
                               element.style.fontSize = '2rem';
                               element.style.fontWeight = 'bold';
                               element.style.color = '#1e293b';
                               element.style.marginBottom = '0.5rem';
                             } else if (value === 'subtitle') {
                               element.style.fontSize = '1.25rem';
                               element.style.fontStyle = 'italic';
                               element.style.color = '#64748b';
                               element.style.marginBottom = '1rem';
                             }
                           }
                         } else {
                           execCmd('formatBlock', value);
                         }
                         e.target.value = 'div'; // Reset to Normal
                       }}
                       className="appearance-none h-9 pl-3 pr-8 bg-white/5 border border-white/10 rounded-xl text-sm font-medium text-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-white/10 transition-colors cursor-pointer w-28 backdrop-blur-sm"
                       onMouseDown={(e) => e.stopPropagation()}
                     >
                      <option value="div" className="bg-gray-800">Normal</option>
                      <option value="title" className="bg-gray-800">Title</option>
                      <option value="subtitle" className="bg-gray-800">Subtitle</option>
                      <option value="h1" className="bg-gray-800">Heading 1</option>
                      <option value="h2" className="bg-gray-800">Heading 2</option>
                      <option value="h3" className="bg-gray-800">Heading 3</option>
                      <option value="blockquote" className="bg-gray-800">Quote</option>
                    </select>
                  </div>
                  
                  <select 
                    onChange={(e) => execCmd('fontName', e.target.value)} 
                    className="appearance-none h-9 pl-3 pr-8 bg-white/5 border border-white/10 rounded-xl text-sm font-medium text-gray-300 focus:outline-none focus:ring-2 focus:ring-purple-500 hover:bg-white/10 transition-colors cursor-pointer w-32 backdrop-blur-sm"
                  >
                    <option value="ui-sans-serif, system-ui, sans-serif" className="bg-gray-800">Sans Serif</option>
                    <option value="ui-serif, Georgia, serif" className="bg-gray-800">Serif</option>
                    <option value="ui-monospace, SFMono-Regular, monospace" className="bg-gray-800">Monospace</option>
                    <option value="Comic Sans MS" className="bg-gray-800">Comic Sans</option>
                  </select>
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pr-2 pl-2">
                  <IconButton onClick={() => execCmd('bold')} icon={Bold} tooltip="Bold" />
                  <IconButton onClick={() => execCmd('italic')} icon={Italic} tooltip="Italic" />
                  <IconButton onClick={() => execCmd('underline')} icon={Underline} tooltip="Underline" />
                  <IconButton onClick={() => execCmd('strikeThrough')} icon={Strikethrough} tooltip="Strikethrough" />
                  
                  <div className="relative flex items-center justify-center mx-1 group">
                    <label className="cursor-pointer flex items-center justify-center p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent transition-colors" title="Text Color">
                      <Palette className="w-4 h-4 text-gray-400 hover:text-white" />
                      <input 
                        type="color" 
                        className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                        onChange={(e) => execCmd('foreColor', e.target.value)}
                      />
                    </label>
                  </div>
                  <div className="relative flex items-center justify-center mx-1 group">
                    <label className="cursor-pointer flex items-center justify-center p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent transition-colors" title="Highlight Color">
                      <Highlighter className="w-4 h-4 text-gray-400 hover:text-white" />
                      <input 
                        type="color" 
                        defaultValue="#ffff00"
                        className="absolute inset-0 opacity-0 cursor-pointer w-full h-full"
                        onChange={(e) => execCmd('hiliteColor', e.target.value)}
                      />
                    </label>
                  </div>
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pr-2 pl-2">
                  <IconButton onClick={() => execCmd('justifyLeft')} icon={AlignLeft} tooltip="Left" />
                  <IconButton onClick={() => execCmd('justifyCenter')} icon={AlignCenter} tooltip="Center" />
                  <IconButton onClick={() => execCmd('justifyRight')} icon={AlignRight} tooltip="Right" />
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pr-2 pl-2">
                  <IconButton onClick={() => execCmd('insertUnorderedList')} icon={List} tooltip="Bullet List" />
                  <IconButton onClick={() => execCmd('insertOrderedList')} icon={ListOrdered} tooltip="Number List" />
                  <IconButton onClick={() => execCmd('indent')} icon={Indent} tooltip="Indent" />
                </div>

                <Divider />

                <div className="flex items-center space-x-1 pl-2">
                  <IconButton onClick={() => {
                     const url = prompt('Enter URL:');
                     if(url) execCmd('createLink', url);
                  }} icon={LinkIcon} tooltip="Link" />
                  
                  <Tooltip text="Upload Image">
                    <label className="p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent text-gray-400 hover:text-white cursor-pointer transition-colors block">
                      <ImageIcon className="w-4 h-4" />
                      <input 
                        type="file" 
                        accept="image/*" 
                        className="hidden" 
                        ref={imageInputRef}
                        onChange={handleInsertImage}
                      />
                    </label>
                  </Tooltip>

                  <IconButton onClick={handleInsertTable} icon={TableIcon} tooltip="Table" />
                  
                  <div className="w-px h-6 bg-white/10 mx-2"></div>
                  
                  <Tooltip text="Open File">
                    <label className="p-2 rounded-xl hover:bg-white/10 hover:border-white/10 border border-transparent text-gray-400 hover:text-white cursor-pointer transition-colors block">
                      <FileUp className="w-4 h-4" />
                      <input type="file" className="hidden" accept=".html,.txt" onChange={handleOpenLocal} />
                    </label>
                  </Tooltip>
                  
                  <IconButton onClick={handleSaveLocal} icon={Save} tooltip="Save HTML" />
                  <IconButton onClick={handleSaveTxt} icon={FileDown} tooltip="Save TXT" />

                  <div className="w-px h-6 bg-white/10 mx-2"></div>
                  
                  <IconButton onClick={() => setShowFind(!showFind)} active={showFind} icon={Search} tooltip="Find" />
                  <IconButton onClick={() => setFocusMode(!focusMode)} active={focusMode} icon={Maximize} tooltip="Focus Mode" />

                </div>
              </div>
              )}

              {/* --- Find Bar --- */}
              {showFind && !focusMode && (
                <div className="flex items-center px-6 py-2 bg-gray-800/80 backdrop-blur-xl border-b border-white/10 shadow-inner z-10 animate-in slide-in-from-top-2">
                    <span className="text-sm font-medium text-gray-300 mr-2">Find:</span>
                    <input 
                        type="text" 
                        value={findTerm}
                        onChange={(e) => setFindTerm(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && handleFind()}
                        className="h-8 px-3 rounded-lg bg-black/40 border border-white/10 text-gray-200 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 w-64 mr-2 placeholder-gray-500"
                        placeholder="Type and press Enter..."
                        autoFocus
                    />
                    <button onClick={handleFind} className="px-3 py-1.5 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700">Next</button>
                    <button onClick={() => setShowFind(false)} className="ml-2 text-gray-400 hover:text-white text-sm">Close</button>
                </div>
              )}

              {/* --- Main Editor Area --- */}
              <div className="flex-1 flex overflow-hidden">
                  <div 
                    className="flex-1 overflow-y-auto cursor-text p-8 md:p-12 relative"
                    onClick={() => editorRef.current?.focus()}
                  >
                    <div className="max-w-[210mm] mx-auto transition-transform duration-500 ease-out relative">
                    {focusMode && (
                        <div className="fixed top-4 right-8 z-50 group">
                            <button 
                                onClick={() => setFocusMode(false)}
                                className="bg-black/40 hover:bg-black/60 text-white p-2 rounded-full backdrop-blur-sm transition-colors border border-white/10"
                            >
                                <Minimize className="w-5 h-5" />
                            </button>
                            <span className="absolute right-full mr-2 top-1.5 text-xs text-white bg-black/50 px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Exit Focus</span>
                        </div>
                    )}
                  
                  {/* The Page */}
                  <div 
                    className={`bg-white min-h-[297mm] p-[25mm] shadow-2xl rounded-sm ring-1 ring-black/5 transition-all duration-700 relative ${focusMode ? 'scale-105 shadow-[0_0_100px_rgba(0,0,0,0.5)]' : ''}`}
                    style={{ width: '100%' }}
                  >
                        {/* Visual Mode Overlay */}
                        {renderVisualOverlay()}
                        
                        {/* Sign-in Overlay */}
                        {!isConnectedToCloud && (
                          <div className="absolute inset-0 bg-white/95 backdrop-blur-sm z-20 flex items-center justify-center">
                            <div className="text-center max-w-md p-8">
                              <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                                <Cloud className="w-8 h-8 text-white" />
                              </div>
                              <h2 className="text-2xl font-bold text-gray-900 mb-3">Sync to Cloud</h2>
                              <p className="text-gray-600 mb-6">Connect to Firebase to enable cloud save, multi-device access, and safe backups.</p>
                              <button 
                                onClick={onConnectCloud}
                                className="px-6 py-3 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl font-semibold shadow-lg transition-all hover:scale-105 flex items-center gap-2 mx-auto"
                              >
                                <Cloud className="w-5 h-5" />
                                Connect to Cloud
                              </button>
                              <p className="mt-4 text-xs text-gray-400">Or continue offline (changes saved to browser)</p>
                            </div>
                          </div>
                        )}
                    <div
                      ref={editorRef}
                      contentEditable={true} // Allow offline editing
                      suppressContentEditableWarning
                      className="outline-none min-h-full text-base leading-relaxed text-left text-black empty:before:content-[attr(placeholder)] empty:before:text-slate-400 selection:bg-purple-200 selection:text-purple-900"
                      onInput={handleInput}
                      spellCheck={true}
                      placeholder="Type something amazing..."
                      style={{
                        color: 'inherit'
                      }}
                    />
                  </div>
                  
                  <div className="h-24 text-center text-white/20 text-sm font-medium py-8 italic">
                     End of Document
                  </div>
                </div>
              </div>

                  {/* Split Pane (Context) */}
                  {splitScreen && (
                        <div className="w-[400px] border-l border-slate-800 bg-[#0f1116] flex flex-col animate-in slide-in-from-right-10 z-30">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Contextual Reference</h3>
                            <button onClick={() => setSplitScreen(false)}><Minimize2 className="w-3 h-3 text-slate-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {/* Auto-detected Entity Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800 hover:border-indigo-500/50 transition-colors cursor-pointer group">
                                <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">K</div>
                                <div>
                                    <div className="font-bold text-slate-200 group-hover:text-indigo-400 transition-colors">Kael</div>
                                    <div className="text-xs text-slate-500">Protagonist • Mercenary</div>
                                </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-3">
                                    <div className="bg-slate-950 p-2 rounded">AGE: 32</div>
                                    <div className="bg-slate-950 p-2 rounded">EYES: Cybernetic</div>
                                </div>
                                <p className="text-sm text-slate-400 leading-snug">
                                <span className="text-indigo-400 font-bold">Goal:</span> Secure credits for optic repair.<br/>
                                <span className="text-indigo-400 font-bold">Lie:</span> "I don't need anyone."
                                </p>
                            </div>

                            {/* Location Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                <div className="flex items-center gap-2 mb-2">
                                <Map className="w-4 h-4 text-emerald-500" />
                                <span className="font-bold text-slate-200">Sector 7 Docks</span>
                                </div>
                                <div className="h-32 bg-slate-950 rounded mb-2 overflow-hidden relative group border border-slate-800">
                                    {/* Mock Map */}
                                    <svg className="w-full h-full opacity-50" viewBox="0 0 100 100">
                                        <rect width="100" height="100" fill="#0f172a" />
                                        <path d="M 20 20 L 40 40 L 80 20" stroke="#334155" fill="none" />
                                        <circle cx="40" cy="40" r="3" fill="#10b981" />
                                        <text x="45" y="42" fill="white" fontSize="5">You Are Here</text>
                                    </svg>
                                </div>
                                <p className="text-xs text-slate-500">
                                    Atmosphere: Rain, Neon, Industrial Decay.<br/>
                                    Sensory: Smell of ozone and rotting fish.
                                </p>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* AI FAB */}
                    {!focusMode && (
                        <div className="absolute bottom-8 right-8 z-30">
                        <button 
                            onClick={() => setShowAiPanel(true)}
                            className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-full shadow-[0_0_20px_rgba(79,70,229,0.5)] flex items-center justify-center text-white transition-transform hover:scale-110 active:scale-95"
                            title="AI Creative Assistant"
                        >
                            <Zap className="w-6 h-6" />
                        </button>
                        </div>
                    )}

                    {/* AI MODAL */}
                    {showAiPanel && (
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-end">
                            <div className="w-[450px] h-full bg-purple-900/20 backdrop-blur-xl border-l border-white/10 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                                <div className="p-6 border-b border-white/10 flex justify-between items-center bg-purple-900/30">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2"><Zap className="w-5 h-5 text-purple-400" /> Creative Assistant</h2>
                                    <button onClick={() => setShowAiPanel(false)} className="text-slate-400 hover:text-white"><Minimize2 className="w-4 h-4" /></button>
                                </div>
                                
                                {/* Chat History Area */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin">
                                    {chatHistory.length === 0 && (
                                        <div className="text-center text-slate-400 mt-10">
                                            <Zap className="w-12 h-12 mx-auto mb-4 opacity-20" />
                                            <p>Ask me anything about your story.</p>
                                            <p className="text-xs mt-2 opacity-50">I can read your current chapter context.</p>
                                        </div>
                                    )}
                                    {chatHistory.map((msg, idx) => (
                                        <div key={idx} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] rounded-2xl p-3 text-sm whitespace-pre-wrap ${
                                                msg.role === 'user' 
                                                    ? 'bg-indigo-600 text-white rounded-br-none' 
                                                    : 'bg-slate-800/80 text-slate-200 rounded-bl-none border border-white/5'
                                            }`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    ))}
                                    {isAiLoading && (
                                        <div className="flex justify-start">
                                            <div className="bg-slate-800/80 rounded-2xl p-3 rounded-bl-none border border-white/5">
                                                <div className="flex gap-1">
                                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '0ms'}}></div>
                                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                                                    <div className="w-2 h-2 bg-purple-400 rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="p-4 border-t border-white/10 bg-purple-900/30">
                                    {/* Provider Selector */}
                                    <div className="flex justify-between items-center mb-3 px-1">
                                        <span className="text-[10px] text-slate-400 uppercase font-bold">Provider</span>
                                        <select 
                                            value={aiProvider}
                                            onChange={(e) => {
                                                setAiProvider(e.target.value);
                                                localStorage.setItem('narrativeos-ai-provider', e.target.value);
                                            }}
                                            className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none font-bold"
                                        >
                                            <option value="gemini" className="bg-slate-900 text-slate-300">Google Gemini</option>
                                            <option value="huggingface" className="bg-slate-900 text-slate-300">Hugging Face (Open Source)</option>
                                            <option value="github" className="bg-slate-900 text-slate-300">GitHub Models (Azure AI)</option>
                                        </select>
                                    </div>

                                    {/* Gemini Configuration */}
                                    {aiProvider === 'gemini' && (
                                        <>
                                            {!geminiApiKey ? (
                                                <div className="space-y-2 mb-3">
                                                    <p className="text-xs text-slate-300">Enter your Google Gemini API Key (Free):</p>
                                                    <input 
                                                        type="password" 
                                                        placeholder="Paste API Key here..." 
                                                        className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-purple-500"
                                                        onChange={(e) => {
                                                            setGeminiApiKey(e.target.value);
                                                            localStorage.setItem('gemini-api-key', e.target.value);
                                                        }}
                                                    />
                                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-xs text-purple-300 hover:underline block">Get a free API key here</a>
                                                </div>
                                            ) : (
                                                availableModels.length > 0 && (
                                                    <div className="flex justify-between items-center px-1 mb-3">
                                                        <span className="text-[10px] text-slate-400 uppercase font-bold">Model</span>
                                                        <select 
                                                            value={selectedModel}
                                                            onChange={(e) => {
                                                                setSelectedModel(e.target.value);
                                                                localStorage.setItem('gemini-model', e.target.value);
                                                            }}
                                                            className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none"
                                                        >
                                                            {availableModels.map(model => (
                                                                <option key={model.name} value={model.name} className="bg-slate-900 text-slate-300">
                                                                    {model.displayName || model.name.replace('models/', '')}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                )
                                            )}
                                        </>
                                    )}

                                    {/* Hugging Face Configuration */}
                                    {aiProvider === 'huggingface' && (
                                        <>
                                            {!hfToken ? (
                                                <div className="space-y-2 mb-3">
                                                    <p className="text-xs text-slate-300">Enter your Hugging Face Token:</p>
                                                    <input 
                                                        type="password" 
                                                        placeholder="Paste HF Token here..." 
                                                        className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-purple-500"
                                                        onChange={(e) => {
                                                            setHfToken(e.target.value);
                                                            localStorage.setItem('hf-token', e.target.value);
                                                        }}
                                                    />
                                                    <a href="https://huggingface.co/settings/tokens" target="_blank" className="text-xs text-purple-300 hover:underline block">Get a free token here</a>
                                                </div>
                                            ) : (
                                                <div className="flex justify-between items-center px-1 mb-3">
                                                    <span className="text-[10px] text-slate-400 uppercase font-bold">Model</span>
                                                    <select 
                                                        value={hfModel}
                                                        onChange={(e) => {
                                                            setHfModel(e.target.value);
                                                            localStorage.setItem('hf-model', e.target.value);
                                                        }}
                                                        className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none"
                                                    >
                                                        {HF_MODELS.map(model => (
                                                            <option key={model.id} value={model.id} className="bg-slate-900 text-slate-300">
                                                                {model.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {/* GitHub Models Settings */}
                                    {aiProvider === 'github' && (
                                        <>
                                            {!githubToken ? (
                                                <div className="space-y-2 mb-3">
                                                    <input 
                                                        type="password" 
                                                        placeholder="Enter GitHub Personal Access Token" 
                                                        className="w-full bg-black/40 border border-white/10 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-purple-500"
                                                        onChange={(e) => {
                                                            setGithubToken(e.target.value);
                                                            localStorage.setItem('github-token', e.target.value);
                                                        }}
                                                    />
                                                    <a href="https://github.com/settings/tokens" target="_blank" className="text-xs text-purple-300 hover:underline block">Get a token here (Classic, No scopes needed)</a>
                                                </div>
                                            ) : (
                                                <div className="flex justify-between items-center px-1 mb-3">
                                                    <span className="text-[10px] text-slate-400 uppercase font-bold">Model</span>
                                                    <select 
                                                        value={githubModel}
                                                        onChange={(e) => {
                                                            setGithubModel(e.target.value);
                                                            localStorage.setItem('github-model', e.target.value);
                                                        }}
                                                        className="bg-transparent text-xs text-purple-300 border-none outline-none cursor-pointer hover:text-purple-200 text-right appearance-none"
                                                    >
                                                        {GITHUB_MODELS.map(model => (
                                                            <option key={model.id} value={model.id} className="bg-slate-900 text-slate-300">
                                                                {model.name}
                                                            </option>
                                                        ))}
                                                    </select>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    <div className="relative">
                                        <input 
                                            type="text" 
                                            value={aiPrompt}
                                            onChange={(e) => setAiPrompt(e.target.value)}
                                            onKeyDown={handleAiSubmit}
                                            disabled={isAiLoading}
                                            placeholder={isAiLoading ? "AI is thinking..." : "Ask AI..."} 
                                            className="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-sm text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500/50 disabled:opacity-50 placeholder-slate-500" 
                                        />
                                        <button 
                                            onClick={() => handleAiSubmit({ key: 'Enter', preventDefault: () => {} })}
                                            className="absolute right-2 top-2 p-1 text-purple-400 hover:text-white transition-colors"
                                        >
                                            <Zap className="w-4 h-4" />
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
              </div>

              {/* --- Footer / Status Bar --- */}
              {!focusMode && (
              <div className="bg-black/20 backdrop-blur-md border-t border-white/5 px-6 py-2 flex justify-between items-center text-xs font-medium text-gray-400 z-20">
                 <div className="flex space-x-6">
                   <span className="hover:text-white transition-colors cursor-pointer">Page 1 of 1</span>
                   <span className="hover:text-white transition-colors cursor-pointer">{wordCount} words</span>
                   <span className="hover:text-white transition-colors cursor-pointer">{charCount} chars</span>
                   <span className="flex items-center hover:text-white transition-colors cursor-pointer"><Clock className="w-3 h-3 mr-1"/> {getReadingTime()}</span>
                 </div>
                 <div className="flex items-center space-x-3">
                   <div className="w-32 bg-white/10 rounded-full h-1.5 overflow-hidden">
                     <div className="bg-purple-500 w-full h-1.5 rounded-full shadow-[0_0_10px_rgba(168,85,247,0.5)]"></div>
                   </div>
                   <span className="text-gray-300 font-bold drop-shadow-md">100%</span>
                 </div>
              </div>
              )}

              {/* --- Modern Glass Modal --- */}
              {/* Note: This modal is handled in the main NarrativeOS component now */}

            </div>
          );
        }

        // --- MAIN APPLICATION ---

        const WorldView = ({
            currentProject,
            setCurrentProject,
            relationships,
            setRelationships,
            relationshipTimeline,
            setRelationshipTimeline,
            timelineIndex,
            setTimelineIndex,
            showRelationshipEditor,
            setShowRelationshipEditor,
            aiProvider,
            selectedModel,
            hfModel,
            githubModel,
            availableModels,
            HF_MODELS,
            GITHUB_MODELS,
            setSelectedModel,
            setHfModel,
            setGithubModel,
            analyzeRelationships,
            isAiLoading,
            analysisScope,
            setAnalysisScope,
            relationshipViewMode,
            setRelationshipViewMode,
            setRelationships: persistRelationships,
            setRelationshipTimeline: persistRelationshipTimeline
        }) => {
            // Icons are imported at the top level

            if (!currentProject) return null;
            
            const characters = currentProject.characters || [];
            const hasCharacters = characters.length > 0;
            const [selectedCharacter, setSelectedCharacter] = useState(null); // name string

            // Build chapter-based timeline view from AI timeline data
            const chapterTimeline = useMemo(() => {
                if (!currentProject || relationshipTimeline.length === 0) return [];
                const chapters = currentProject.sections.flatMap(s => s.chapters);
                return chapters.map((ch, idx) => {
                    const rels = [];
                    relationshipTimeline.forEach(step => {
                        (step.relationships || []).forEach(r => {
                            const match = r.chapterId === ch.id || r.chapter === ch.title || r.chapterTitle === ch.title;
                            if (match) rels.push(r);
                        });
                    });
                    return {
                        label: `Chapter ${idx + 1}: ${ch.title}`,
                        description: rels.length > 0 ? `Relationships appearing in ${ch.title}` : 'No relationships found for this chapter.',
                        relationships: rels
                    };
                });
            }, [currentProject, relationshipTimeline]);

            const activeTimeline = relationshipViewMode === 'chapters' ? chapterTimeline : relationshipTimeline;

            // Keep timeline index in range and update relationships when mode changes
            useEffect(() => {
                if (activeTimeline.length === 0) {
                    setTimelineIndex(0);
                    setRelationships([]);
                    return;
                }
                const clamped = Math.min(timelineIndex, activeTimeline.length - 1);
                if (clamped !== timelineIndex) setTimelineIndex(clamped);
                setRelationships(activeTimeline[clamped].relationships || []);
            }, [relationshipViewMode, activeTimeline.length]);

            const characterRelationships = useMemo(() => {
                if (!selectedCharacter) return relationships;
                return relationships.filter(r => r.source === selectedCharacter || r.target === selectedCharacter);
            }, [relationships, selectedCharacter]);

            // --- Force Directed Graph Logic ---
            const [nodes, setNodes] = useState([]);
            const [links, setLinks] = useState([]);
            const [showLabels, setShowLabels] = useState(true);
            const [zoom, setZoom] = useState(1);
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [isPanning, setIsPanning] = useState(false);
            const [draggingNode, setDraggingNode] = useState(null);
            const [isDraggingNode, setIsDraggingNode] = useState(false);
            const svgRef = useRef(null);
            const panStartRef = useRef({ x: 0, y: 0 });

            useEffect(() => {
                if (relationships.length > 0) {
                    // 1. Extract unique nodes from relationships
                    const uniqueNames = new Set();
                    relationships.forEach(r => {
                        uniqueNames.add(r.source);
                        uniqueNames.add(r.target);
                    });
                    
                    // Create node objects
                    const newNodes = Array.from(uniqueNames).map((name, i) => ({
                        id: name,
                        x: Math.random() * 800,
                        y: Math.random() * 600,
                        vx: 0,
                        vy: 0,
                        color: `hsl(${Math.random() * 360}, 70%, 60%)`
                    }));

                    // Create link objects
                    const newLinks = relationships.map(r => ({
                        source: r.source,
                        target: r.target,
                        type: r.type,
                        strength: r.strength || 1
                    }));

                    setNodes(newNodes);
                    setLinks(newLinks);
                }
            }, [relationships]);

            // Simple Force Simulation Loop
            useEffect(() => {
                if (nodes.length === 0) return;
                if (isDraggingNode) return; // Pause physics while dragging

                let animationFrameId;
                
                const simulate = () => {
                    setNodes(prevNodes => {
                        const nextNodes = prevNodes.map(n => ({ ...n })); // Deep copy for immutability
                        const width = 1000; // Canvas width
                        const height = 800; // Canvas height
                        const center = { x: width / 2, y: height / 2 };

                        // 1. Repulsion (Nodes push away from each other)
                        for (let i = 0; i < nextNodes.length; i++) {
                            for (let j = i + 1; j < nextNodes.length; j++) {
                                const dx = nextNodes[i].x - nextNodes[j].x;
                                const dy = nextNodes[i].y - nextNodes[j].y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                const force = 5000 / (dist * dist); // Increased Repulsion
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;

                                nextNodes[i].vx += fx;
                                nextNodes[i].vy += fy;
                                nextNodes[j].vx -= fx;
                                nextNodes[j].vy -= fy;
                            }
                        }

                        // 2. Attraction (Links pull nodes together)
                        links.forEach(link => {
                            const source = nextNodes.find(n => n.id === link.source);
                            const target = nextNodes.find(n => n.id === link.target);
                            if (source && target) {
                                const dx = target.x - source.x;
                                const dy = target.y - source.y;
                                const dist = Math.sqrt(dx * dx + dy * dy) || 1;
                                const force = (dist - 300) * 0.05; // Increased Spring Length (300)
                                const fx = (dx / dist) * force;
                                const fy = (dy / dist) * force;

                                source.vx += fx;
                                source.vy += fy;
                                target.vx -= fx;
                                target.vy -= fy;
                            }
                        });

                        // 3. Center Gravity (Keep nodes on screen)
                        nextNodes.forEach(node => {
                            node.vx += (center.x - node.x) * 0.01;
                            node.vy += (center.y - node.y) * 0.01;

                            // Apply Velocity
                            node.vx *= 0.8; // Damping
                            node.vy *= 0.8;
                            node.x += node.vx;
                            node.y += node.vy;
                        });

                        return nextNodes;
                    });
                    animationFrameId = requestAnimationFrame(simulate);
                };

                simulate();
                return () => cancelAnimationFrame(animationFrameId);
            }, [links, isDraggingNode]); // Re-run simulation setup only when links change (which implies nodes changed too)

            const clampZoom = (value) => Math.min(3, Math.max(0.5, value));

            const toLocalPoint = (clientX, clientY) => {
                const rect = svgRef.current?.getBoundingClientRect();
                if (!rect) return { x: clientX, y: clientY };
                return {
                    x: (clientX - rect.left - pan.x) / zoom,
                    y: (clientY - rect.top - pan.y) / zoom
                };
            };

            const handleNodePointerDown = (id) => (e) => {
                e.stopPropagation();
                setDraggingNode(id);
                setIsDraggingNode(true);
            };

            const handlePointerMove = (e) => {
                if (draggingNode) {
                    if (e.buttons !== 1) {
                        setDraggingNode(null);
                        setIsDraggingNode(false);
                        return;
                    }
                    const { x, y } = toLocalPoint(e.clientX, e.clientY);
                    setNodes(prev => prev.map(n => n.id === draggingNode ? { ...n, x, y, vx: 0, vy: 0 } : n));
                    return;
                }
                if (isPanning) {
                    setPan({ x: e.clientX - panStartRef.current.x, y: e.clientY - panStartRef.current.y });
                }
            };

            const handlePointerUp = () => {
                setDraggingNode(null);
                setIsDraggingNode(false);
                setIsPanning(false);
            };

            const handleBackgroundPointerDown = (e) => {
                setIsPanning(true);
                panStartRef.current = { x: e.clientX - pan.x, y: e.clientY - pan.y };
            };

            const handleWheel = (e) => {
                e.preventDefault();
                const factor = e.deltaY < 0 ? 1.1 : 0.9;
                setZoom(z => clampZoom(z * factor));
            };

            const resetView = () => {
                setPan({ x: 0, y: 0 });
                setZoom(1);
            };

            
            return (
            <div className="flex-1 bg-slate-950 relative flex flex-col items-center justify-center overflow-hidden">
                <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-slate-950 z-0"></div>

                <div className="absolute top-6 left-6 z-10 bg-slate-900/80 backdrop-blur p-4 rounded-xl border border-slate-800 shadow-xl">
                    <h2 className="text-lg font-bold text-slate-200">Story Codex</h2>
                    <p className="text-xs text-slate-500">Characters, Locations & Relationships</p>
                </div>

                {/* Visualization Layer */}
                {nodes.length > 0 ? (
                    <div 
                        className="absolute inset-0 z-0 flex items-center justify-center"
                        onPointerDown={handleBackgroundPointerDown}
                        onPointerMove={handlePointerMove}
                        onPointerUp={handlePointerUp}
                        onPointerLeave={handlePointerUp}
                        onWheel={handleWheel}
                        style={{ touchAction: 'none' }}
                    >
                        <svg ref={svgRef} width="100%" height="100%" viewBox="0 0 1000 800" className="overflow-visible">
                            <defs>
                                <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                                    <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            <g transform={`translate(${pan.x} ${pan.y}) scale(${zoom})`}>
                                {/* Links */}
                                {links.map((link, i) => {
                                    const source = nodes.find(n => n.id === link.source);
                                    const target = nodes.find(n => n.id === link.target);
                                    if (!source || !target) return null;
                                    return (
                                        <g key={i}>
                                            <line 
                                                x1={source.x} y1={source.y} 
                                                x2={target.x} y2={target.y} 
                                                stroke="#4f46e5" 
                                                strokeWidth={Math.max(1, link.strength / 2)} 
                                                strokeOpacity="0.4" 
                                            />
                                            {showLabels && (
                                                <text 
                                                    x={(source.x + target.x) / 2} 
                                                    y={(source.y + target.y) / 2} 
                                                    fill="#94a3b8" 
                                                    fontSize="10" 
                                                    textAnchor="middle"
                                                    className="bg-black"
                                                >
                                                    {link.type}
                                                </text>
                                            )}
                                        </g>
                                    );
                                })}
                                {/* Nodes */}
                                {nodes.map((node) => (
                                    <g 
                                        key={node.id} 
                                        transform={`translate(${node.x},${node.y})`} 
                                        className="cursor-grab group"
                                        onPointerDown={handleNodePointerDown(node.id)}
                                    >
                                        <circle r="30" fill="#1e1b4b" stroke={node.color} strokeWidth="2" filter="url(#glow)" className="transition-transform duration-200 group-hover:scale-110" />
                                        {showLabels && (
                                            <>
                                                <text dy="5" textAnchor="middle" fill="white" fontSize="16" fontWeight="bold" pointerEvents="none">
                                                    {node.id.substring(0, 2).toUpperCase()}
                                                </text>
                                                <text dy="50" textAnchor="middle" fill="#cbd5e1" fontSize="14" fontWeight="bold" className="drop-shadow-md bg-black/50 px-2 rounded">
                                                    {node.id}
                                                </text>
                                            </>
                                        )}
                                    </g>
                                ))}
                            </g>
                        </svg>
                    </div>
                ) : (
                    !hasCharacters && (
                    <div className="text-center text-slate-500 z-10">
                        <Map className="w-16 h-16 mx-auto mb-4 opacity-30" />
                        <p className="text-lg mb-2">No characters yet</p>
                        <p className="text-sm mb-6">Add characters to visualize relationships</p>
                    </div>
                    )
                )}

                {/* Timeline & Editor Controls */}
                <div className="absolute bottom-8 left-8 z-10 flex flex-col gap-4">
                    {hasCharacters && (
                        <div className="bg-slate-900/90 backdrop-blur p-4 rounded-xl border border-slate-800 shadow-xl w-[420px]">
                            <div className="flex items-center justify-between mb-2">
                                <div>
                                    <p className="text-xs font-bold text-slate-400 uppercase">Character Viewer</p>
                                    <p className="text-[11px] text-slate-500">See relationships for a single character</p>
                                </div>
                                <button
                                    onClick={() => setSelectedCharacter(null)}
                                    className={`text-[10px] px-2 py-1 rounded-full border ${selectedCharacter ? 'border-slate-700 text-slate-300 hover:border-slate-500' : 'border-emerald-500 text-emerald-200 bg-emerald-500/10'}`}
                                    title="Show all characters"
                                >
                                    All
                                </button>
                            </div>
                            <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto scrollbar-thin pr-1">
                                {characters.map((ch) => (
                                    <button
                                        key={ch.id}
                                        onClick={() => setSelectedCharacter(ch.name)}
                                        className={`w-full text-left px-3 py-2 rounded-lg border text-xs font-semibold transition-colors ${selectedCharacter === ch.name ? 'border-indigo-500 bg-indigo-500/10 text-indigo-100' : 'border-slate-700 bg-slate-800/60 text-slate-200 hover:border-slate-600'}`}
                                        title={ch.name}
                                    >
                                        {ch.name || 'Unnamed'}
                                    </button>
                                ))}
                                {characters.length === 0 && (
                                    <div className="text-xs text-slate-500">No characters yet.</div>
                                )}
                            </div>
                            <div className="mt-3 pt-3 border-t border-slate-800">
                                <div className="text-[11px] text-slate-400 mb-2">Relationships {selectedCharacter ? `for ${selectedCharacter}` : '(all)'} — {characterRelationships.length}</div>
                                {characterRelationships.length === 0 ? (
                                    <div className="text-xs text-slate-500">No relationships found.</div>
                                ) : (
                                    <div className="space-y-2 max-h-32 overflow-y-auto pr-1 scrollbar-thin">
                                        {characterRelationships.slice(0, 12).map((r, idx) => (
                                            <div key={idx} className="text-[11px] text-slate-200/90 bg-slate-800/60 border border-slate-700/70 rounded-md px-2 py-1 leading-tight">
                                                <div className="font-semibold">{r.source} → {r.target}</div>
                                                <div className="text-[10px] text-slate-400">{r.type || 'relation'}{r.strength ? ` • strength ${r.strength}` : ''}</div>
                                                {r.chapterTitle && <div className="text-[10px] text-slate-500">{r.chapterTitle}</div>}
                                            </div>
                                        ))}
                                        {characterRelationships.length > 12 && (
                                            <div className="text-[10px] text-slate-500">+ {characterRelationships.length - 12} more…</div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTimeline.length > 0 && (
                        <div className="bg-slate-900/90 backdrop-blur p-4 rounded-xl border border-slate-800 shadow-xl w-[420px]">
                            <div className="flex justify-between items-center mb-3">
                                <div className="flex items-center gap-2 text-xs font-bold text-slate-400 uppercase">
                                    <span className="px-2 py-1 rounded-full bg-slate-800 text-slate-200">{relationshipViewMode === 'chapters' ? 'Chapters' : 'AI Timeline'}</span>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setRelationshipViewMode('analysis')}
                                        className={`text-[10px] px-2 py-1 rounded-full border ${relationshipViewMode === 'analysis' ? 'border-indigo-500 text-indigo-200 bg-indigo-500/10' : 'border-slate-700 text-slate-400 hover:border-slate-600'}`}
                                    >
                                        AI Timeline
                                    </button>
                                    <button
                                        onClick={() => setRelationshipViewMode('chapters')}
                                        className={`text-[10px] px-2 py-1 rounded-full border ${relationshipViewMode === 'chapters' ? 'border-emerald-500 text-emerald-200 bg-emerald-500/10' : 'border-slate-700 text-slate-400 hover:border-slate-600'}`}
                                    >
                                        By Chapter
                                    </button>
                                </div>
                            </div>
                            <div className="flex justify-between items-center mb-2">
                                <span className="text-xs text-indigo-400 font-bold truncate max-w-[260px]">{activeTimeline[timelineIndex]?.label || 'No data'}</span>
                                <span className="text-[10px] text-slate-500">{timelineIndex + 1}/{activeTimeline.length}</span>
                            </div>
                            <input 
                                type="range" 
                                min="0" 
                                max={Math.max(0, activeTimeline.length - 1)} 
                                value={Math.min(timelineIndex, Math.max(0, activeTimeline.length - 1))} 
                                onChange={(e) => {
                                    const idx = parseInt(e.target.value);
                                    setTimelineIndex(idx);
                                    setRelationships(activeTimeline[idx]?.relationships || []);
                                }}
                                className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                            />
                            <p className="text-xs text-slate-300 mt-2 italic min-h-[32px]">
                                "{activeTimeline[timelineIndex]?.description || 'No description available.'}"
                            </p>
                            <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-800">
                                <button 
                                    onClick={() => {
                                        const allRels = [];
                                        const seen = new Set();
                                        // Iterate backwards to prioritize latest relationships
                                        [...activeTimeline].reverse().forEach(step => {
                                            (step.relationships || []).forEach(r => {
                                                const key = `${r.source}-${r.target}-${r.type || ''}`;
                                                if (!seen.has(key)) {
                                                    seen.add(key);
                                                    allRels.push(r);
                                                }
                                            });
                                        });
                                        setRelationships(allRels);
                                    }}
                                    className="text-xs text-indigo-400 hover:text-indigo-300 font-bold flex items-center gap-1"
                                >
                                    <Maximize2 className="w-3 h-3" /> Show All Relationships
                                </button>
                                <span className="text-[10px] text-slate-500">{(activeTimeline[timelineIndex]?.relationships || []).length} link(s)</span>
                            </div>
                        </div>
                    )}
                    
                    <button 
                        onClick={() => setShowRelationshipEditor(true)}
                        className="self-start px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-lg text-xs font-bold border border-slate-700 flex items-center gap-2"
                    >
                        <PenTool className="w-3 h-3" /> Edit Data
                    </button>
                </div>

                {/* View Controls */}
                <div className="absolute top-6 right-6 z-10 bg-slate-900/80 backdrop-blur p-3 rounded-xl border border-slate-800 shadow-xl flex flex-col gap-2">
                    <div className="flex items-center gap-2">
                        <button 
                            onClick={() => setShowLabels(v => !v)}
                            className="px-3 py-1 text-[11px] rounded-lg border border-slate-700 bg-slate-800 text-slate-200 hover:border-indigo-500"
                        >
                            {showLabels ? 'Hide Text' : 'Show Text'}
                        </button>
                        <div className="flex items-center bg-slate-800/80 border border-slate-700 rounded-lg overflow-hidden text-slate-200 text-[11px]">
                            <button className="px-2 hover:bg-slate-700" onClick={() => setZoom(z => clampZoom(z * 1.1))}>+</button>
                            <div className="px-2 border-l border-r border-slate-700">{zoom.toFixed(1)}x</div>
                            <button className="px-2 hover:bg-slate-700" onClick={() => setZoom(z => clampZoom(z * 0.9))}>-</button>
                        </div>
                        <button 
                            onClick={resetView}
                            className="px-3 py-1 text-[11px] rounded-lg border border-slate-700 bg-slate-800 text-slate-200 hover:border-emerald-500"
                        >
                            Reset View
                        </button>
                    </div>
                    <p className="text-[10px] text-slate-500">Scroll to zoom, drag background to pan, drag nodes to reposition.</p>
                </div>

                {/* Relationship Editor Modal */}
                {showRelationshipEditor && (
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-10">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-4xl h-[80vh] flex flex-col">
                            <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                                <h3 className="text-xl font-bold text-white">Edit Relationships</h3>
                                <button onClick={() => setShowRelationshipEditor(false)} className="text-slate-400 hover:text-white">
                                    <X className="w-6 h-6" />
                                </button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-6">
                                <table className="w-full text-left text-sm text-slate-300">
                                    <thead className="text-xs uppercase bg-slate-800 text-slate-400">
                                        <tr>
                                            <th className="p-3 rounded-tl-lg">Source</th>
                                            <th className="p-3">Target</th>
                                            <th className="p-3">Type</th>
                                            <th className="p-3">Strength (1-10)</th>
                                            <th className="p-3 rounded-tr-lg">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-800">
                                        {relationships.map((rel, idx) => (
                                            <tr key={idx} className="hover:bg-slate-800/50">
                                                <td className="p-3">
                                                    <input 
                                                        type="text" 
                                                        value={rel.source} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].source = e.target.value;
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-full"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input 
                                                        type="text" 
                                                        value={rel.target} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].target = e.target.value;
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-full"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input 
                                                        type="text" 
                                                        value={rel.type} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].type = e.target.value;
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-full"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <input 
                                                        type="number" 
                                                        min="1" max="10"
                                                        value={rel.strength} 
                                                        onChange={(e) => {
                                                            const newRels = [...relationships];
                                                            newRels[idx].strength = parseInt(e.target.value);
                                                            setRelationships(newRels);
                                                        }}
                                                        className="bg-transparent border-b border-slate-700 focus:border-indigo-500 outline-none w-16"
                                                    />
                                                </td>
                                                <td className="p-3">
                                                    <button 
                                                        onClick={() => {
                                                            const newRels = relationships.filter((_, i) => i !== idx);
                                                            setRelationships(newRels);
                                                        }}
                                                        className="text-red-400 hover:text-red-300"
                                                    >
                                                        <X className="w-4 h-4" />
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                                <button 
                                    onClick={() => setRelationships([...relationships, { source: 'New', target: 'New', type: 'unknown', strength: 1 }])}
                                    className="mt-4 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold flex items-center gap-2"
                                >
                                    <Plus className="w-4 h-4" /> Add Relationship
                                </button>
                            </div>
                            <div className="p-6 border-t border-slate-800 flex justify-end">
                                <button 
                                    onClick={() => setShowRelationshipEditor(false)}
                                    className="px-6 py-3 bg-white text-slate-900 hover:bg-slate-200 rounded-lg font-bold"
                                >
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Controls */}
                <div className="absolute bottom-8 right-8 z-10 flex gap-2 items-center">
                    {/* Model Selector */}
                    <div className="bg-slate-900/80 backdrop-blur rounded-full border border-slate-700 px-4 py-3 flex items-center gap-2 shadow-lg">
                        <span className="text-xs text-slate-400 font-bold uppercase mr-1">{aiProvider}</span>
                        <select 
                            className="bg-transparent text-xs text-white font-mono outline-none cursor-pointer max-w-[150px] truncate"
                            value={
                                aiProvider === 'gemini' ? selectedModel :
                                aiProvider === 'huggingface' ? hfModel :
                                githubModel
                            }
                            onChange={(e) => {
                                if (aiProvider === 'gemini') setSelectedModel(e.target.value);
                                else if (aiProvider === 'huggingface') setHfModel(e.target.value);
                                else setGithubModel(e.target.value);
                            }}
                        >
                            {aiProvider === 'gemini' && availableModels.map(m => (
                                <option key={m.name} value={m.name} className="bg-slate-900">{m.displayName || m.name.split('/').pop()}</option>
                            ))}
                            {aiProvider === 'gemini' && availableModels.length === 0 && (
                                <option value="gemini-1.5-flash" className="bg-slate-900">Gemini 1.5 Flash</option>
                            )}
                            
                            {aiProvider === 'huggingface' && HF_MODELS.map(m => (
                                <option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>
                            ))}
                            
                            {aiProvider === 'github' && GITHUB_MODELS.map(m => (
                                <option key={m.id} value={m.id} className="bg-slate-900">{m.name}</option>
                            ))}
                        </select>
                        <ChevronDown className="w-3 h-3 text-slate-500" />
                    </div>

                    {/* Scope Selector */}
                    <div className="bg-slate-900/80 backdrop-blur rounded-full border border-slate-700 px-4 py-3 flex items-center gap-2 shadow-lg">
                        <span className="text-xs text-slate-400 font-bold uppercase mr-1">Scope</span>
                        <select 
                            className="bg-transparent text-xs text-white font-mono outline-none cursor-pointer"
                            value={analysisScope}
                            onChange={(e) => setAnalysisScope(e.target.value)}
                        >
                            <option value="project" className="bg-slate-900">Full Book</option>
                            <option value="chapter" className="bg-slate-900">Current Chapter</option>
                        </select>
                        <ChevronDown className="w-3 h-3 text-slate-500" />
                    </div>

                        <button 
                        onClick={() => analyzeRelationships()}
                        disabled={isAiLoading}
                        className={`px-6 py-3 ${isAiLoading ? 'bg-purple-800 cursor-wait' : 'bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500'} text-white rounded-full font-bold shadow-lg shadow-purple-900/50 flex items-center gap-2 transition-all hover:scale-105`}
                    >
                        {isAiLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Zap className="w-5 h-5" />} 
                        {isAiLoading ? 'Analyzing Story...' : 'Generate Relationship Graph'}
                    </button>
                    
                    <button 
                        onClick={() => {
                            const name = prompt('Character name:');
                            if (name && currentProject) {
                                const newChar = {
                                    id: `char-${Date.now()}`,
                                    name: name,
                                    role: '',
                                    description: '',
                                    avatar: name.charAt(0).toUpperCase(),
                                    color: `#${Math.floor(Math.random()*16777215).toString(16)}`
                                };
                                const updatedProject = { ...currentProject };
                                updatedProject.characters = [...(updatedProject.characters || []), newChar];
                                setCurrentProject(updatedProject);
                                ProjectStorage.saveProject(updatedProject);
                            }
                        }}
                        className="px-4 py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-full font-bold shadow-lg border border-slate-700 flex items-center gap-2"
                    >
                        <Plus className="w-5 h-5" /> Add Node
                    </button>
                </div>
            </div>
            );
        };

        function NarrativeOS() {
            // Project State
            const [currentProject, setCurrentProject] = useState(null);
            const [projects, setProjects] = useState([]);
            const [showProjectModal, setShowProjectModal] = useState(false);
            const [selectedSectionId, setSelectedSectionId] = useState(null);
            const [selectedChapterId, setSelectedChapterId] = useState(null);
            
            // Stats State
            const [stats, setStats] = useState({});
            const [streak, setStreak] = useState(0);
            const [globalWordCount, setGlobalWordCount] = useState(0);
            const [globalCharCount, setGlobalCharCount] = useState(0);

            // Navigation State
            const [activeTab, setActiveTab] = useState('write'); 
            
            // Editor State
            const [focusMode, setFocusMode] = useState(false);
            const [splitScreen, setSplitScreen] = useState(false);
            const [textMode, setTextMode] = useState('normal'); // normal, rhythm, hemingway, blind
            const [ambientSound, setAmbientSound] = useState(null); // null, rain, coffee
            
            // Feature Panels
            const [showAiPanel, setShowAiPanel] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showComments, setShowComments] = useState(false);

            // Initialize Stats
            useEffect(() => {
                setStats(StatsStorage.getHistory());
                setStreak(StatsStorage.getStreak());
            }, []);

            // Update Stats when Project Changes
            useEffect(() => {
                if (currentProject) {
                    // Calculate total words in project
                    let totalWords = 0;
                    currentProject.sections.forEach(section => {
                        section.chapters.forEach(chapter => {
                            const text = chapter.content.replace(/<[^>]*>/g, ' ').trim();
                            totalWords += text ? text.split(/\s+/).length : 0;
                        });
                    });
                    
                    setGlobalWordCount(totalWords);
                    
                    // Update Stats Storage
                    const newHistory = StatsStorage.updateWordCount(totalWords);
                    setStats(newHistory);
                    setStreak(StatsStorage.getStreak());
                }
            }, [currentProject]);

            // Keep Codex state in sync when switching projects
            useEffect(() => {
                if (!currentProject) return;
                if (currentProject.relationships) setRelationships(currentProject.relationships);
                if (currentProject.relationshipTimeline) setRelationshipTimeline(currentProject.relationshipTimeline);
            }, [currentProject]);
            
            // Visualization State
            const [timeSlider, setTimeSlider] = useState(1);
            const [versionSlider, setVersionSlider] = useState(10);

            // AI State (Lifted from WordEditor)
            const [aiProvider, setAiProvider] = useState(() => localStorage.getItem('narrativeos-ai-provider') || 'gemini'); // 'gemini' | 'huggingface' | 'github'
            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini-api-key') || '');
            const [hfToken, setHfToken] = useState(() => localStorage.getItem('hf-token') || '');
            const [githubToken, setGithubToken] = useState(() => localStorage.getItem('github-token') || '');
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState(() => localStorage.getItem('gemini-model') || 'gemini-1.5-flash');
            const [hfModel, setHfModel] = useState(() => localStorage.getItem('hf-model') || 'bigscience/bloom');
            const [githubModel, setGithubModel] = useState(() => localStorage.getItem('github-model') || 'gpt-4o');
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [relationships, setRelationships] = useState([]); // Store AI-analyzed relationships
            const [analysisScope, setAnalysisScope] = useState('project'); // 'project' or 'chapter'
            const [relationshipTimeline, setRelationshipTimeline] = useState([]); // Store timeline of relationships
            const [timelineIndex, setTimelineIndex] = useState(0); // Current point in timeline
            const [relationshipViewMode, setRelationshipViewMode] = useState('analysis'); // 'analysis' | 'chapters'
            const [showRelationshipEditor, setShowRelationshipEditor] = useState(false); // Toggle for editor modal
            
            // Timeline AI State
            const [suggestedBeats, setSuggestedBeats] = useState([]); // AI-suggested story beats
            const [isAnalyzingTimeline, setIsAnalyzingTimeline] = useState(false); // Loading state for AI analysis
            const [editingBeat, setEditingBeat] = useState(null); // Currently editing beat
            const [showBeatEditor, setShowBeatEditor] = useState(false); // Beat editor modal

            // Persist Codex data into project (and trigger Drive autosave via currentProject change)
            const persistRelationships = (rels) => {
                setRelationships(rels);
                setCurrentProject(prev => {
                    if (!prev) return prev;
                    const updated = { ...prev, relationships: rels, lastModified: Date.now() };
                    ProjectStorage.saveProject(updated);
                    return updated;
                });
            };

            const persistRelationshipTimeline = (timelineData) => {
                setRelationshipTimeline(timelineData);
                setCurrentProject(prev => {
                    if (!prev) return prev;
                    const updated = { ...prev, relationshipTimeline: timelineData, lastModified: Date.now() };
                    ProjectStorage.saveProject(updated);
                    return updated;
                });
            };

            // Cloud Sync State
            // Cloud Sync State (Firebase)
            const [showCloudModal, setShowCloudModal] = useState(false);
            const [firebaseConfig, setFirebaseConfig] = useState(() => JSON.parse(localStorage.getItem('narrativeos-firebase-config') || 'null'));
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [userInfo, setUserInfo] = useState(null);
            const [isConnectedToCloud, setIsConnectedToCloud] = useState(false);
            const [syncStatus, setSyncStatus] = useState('saved'); 
            const [isCloudLoading, setIsCloudLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState("Loading..."); // New State
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);

            // Cloud Connections
            const handleConnectCloud = () => setShowCloudModal(true);
            
            // Initialize Firebase
            useEffect(() => {
                if (firebaseConfig) {
                    try {
                        const app = initializeApp(firebaseConfig);
                        const dbInstance = getFirestore(app);
                        const authInstance = getAuth(app);
                        
                        // Offline Persistence
                        enableIndexedDbPersistence(dbInstance).catch((err) => {
                             console.warn("Persistence error:", err.code);
                        });

                        setDb(dbInstance);
                        setAuth(authInstance);

                        const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                setFirebaseUser(user);
                                setIsConnectedToCloud(true);
                                setUserInfo({
                                    displayName: user.displayName,
                                    photoLink: user.photoURL,
                                    emailAddress: user.email
                                });

                                // Fetch User's Books from Firestore
                                try {
                                    const booksRef = collection(dbInstance, "books");
                                    const q = query(booksRef, where("author_id", "==", user.uid));
                                    const snap = await getDocs(q);
                                    const cloudProjects = [];
                                    snap.forEach(d => {
                                        const data = d.data();
                                        cloudProjects.push({ 
                                            id: d.id, 
                                            name: data.title || "Untitled", 
                                            lastModified: data.updated_at ? data.updated_at.toMillis() : Date.now(),
                                            sections: [], // Content loaded on demand
                                            isCloud: true 
                                        });
                                    });
                                    
                                    if (cloudProjects.length > 0) {
                                        setProjects(prev => {
                                            const existingIds = new Set(prev.map(p => p.id));
                                            const newProjs = cloudProjects.filter(p => !existingIds.has(p.id));
                                            return [...prev, ...newProjs];
                                        });
                                    }
                                } catch (e) {
                                    console.error("Error fetching books:", e);
                                }

                                // Fetch User Stats
                                try {
                                    const userDocRef = doc(dbInstance, "users", user.uid);
                                    const userDoc = await getDoc(userDocRef);
                                    if (userDoc.exists() && userDoc.data().stats) {
                                        const cloudStats = userDoc.data().stats;
                                        setStats(cloudStats);
                                        StatsStorage.saveHistory(cloudStats);
                                    }
                                } catch (e) {
                                    console.error("Error fetching stats:", e);
                                }

                            } else {
                                setFirebaseUser(null);
                                setIsConnectedToCloud(false);
                            }
                        });
                        return () => unsubscribe();
                    } catch (e) {
                        console.error("Firebase Init Error", e);
                        setIsConnectedToCloud(false);
                    }
                }
            }, [firebaseConfig]);

            // Auto-Sync Stats to Cloud
            useEffect(() => {
                if (!db || !firebaseUser || !Object.keys(stats).length) return;

                const timer = setTimeout(async () => {
                    try {
                        const userDocRef = doc(db, "users", firebaseUser.uid);
                        // Store stats in a 'stats' field inside the user document
                        await setDoc(userDocRef, { 
                            stats: stats,
                            last_active: serverTimestamp() 
                        }, { merge: true });
                    } catch (e) {
                        console.error("Failed to sync stats", e);
                    }
                }, 5000); // Debounce 5s

                return () => clearTimeout(timer);
            }, [stats, db, firebaseUser]);

            // Refresh Stats when opening Stats Tab
            useEffect(() => {
                if (activeTab === 'stats' && isConnectedToCloud && db && firebaseUser) {
                    const fetchLatestStats = async () => {
                        try {
                            const userDocRef = doc(db, "users", firebaseUser.uid);
                            const userDoc = await getDoc(userDocRef);
                            if (userDoc.exists() && userDoc.data().stats) {
                                const cloudStats = userDoc.data().stats;
                                setStats(cloudStats);
                                StatsStorage.saveHistory(cloudStats);
                            }
                        } catch (e) {
                            console.error("Refetch stats error", e);
                        }
                    };
                    fetchLatestStats();
                }
            }, [activeTab, isConnectedToCloud, db, firebaseUser]);

            const handleGithubLogin = async () => {
                if (!auth) {
                    alert("Firebase is not initialized. Please reset the configuration and try again.");
                    return;
                }
                setIsCloudLoading(true);
                setLoadingMessage("Connecting to GitHub...");
                const provider = new GithubAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Login failed", error);
                    alert("Login failed: " + error.message);
                } finally {
                    setIsCloudLoading(false);
                }
            };
            
            const handleLogout = async () => {
                if (!auth) return;
                await signOut(auth);
                setFirebaseUser(null);
                setIsConnectedToCloud(false);
                setUserInfo(null);
            };

            // Enhanced switch project to support Firestore
            const switchToProject = async (projectId) => {
                if (!isConnectedToCloud || !db) {
                     // Local switch
                     const target = projects.find(p => p.id === projectId);
                     if (target) {
                         setCurrentProject(target);
                         localStorage.setItem('narrativeos-current-project-id', target.id);
                     }
                     return;
                }

                setIsCloudLoading(true);
                setLoadingMessage("Opening Project...");
                try {
                    // Fetch Book Metadata
                    const bookRef = doc(db, "books", projectId);
                    const bookSnap = await getDoc(bookRef);
                    
                    if (!bookSnap.exists()) {
                        throw new Error("Book not found in cloud");
                    }
                    
                    const bookData = bookSnap.data();
                    
                    // Fetch Chapters (Sub-collection)
                    const chaptersRef = collection(db, "books", projectId, "chapters");
                    const q = query(chaptersRef, orderBy("order_index"));
                    const querySnapshot = await getDocs(q);
                    
                    const loadedChapters = [];
                    querySnapshot.forEach((doc) => {
                        loadedChapters.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Reconstruct Project Object for UI
                    // Convert flat chapters list back to sections structure
                    // bookData.sections should be an array of {id, name}
                    
                    let rehydratedSections = [];
                    
                    if (bookData.sections && Array.isArray(bookData.sections)) {
                        // Use stored structure
                        rehydratedSections = bookData.sections.map(secMeta => ({
                            ...secMeta,
                            chapters: loadedChapters.filter(c => c.sectionId === secMeta.id)
                        }));
                        
                        // Handle orphaned chapters (legacy or bug)
                        const orphans = loadedChapters.filter(c => !c.sectionId || !bookData.sections.find(s => s.id === c.sectionId));
                        if (orphans.length > 0) {
                             if (rehydratedSections.length > 0) rehydratedSections[0].chapters.push(...orphans);
                             else rehydratedSections.push({ id: "default", name: "Manuscript", chapters: orphans });
                        }
                    } else {
                        // Default fallback (single section)
                        rehydratedSections = [
                            {
                                id: "main-section",
                                name: "Manuscript",
                                chapters: loadedChapters 
                            }
                        ];
                    }
                    
                    const reconstructedProject = {
                        id: bookSnap.id,
                        ...bookData,
                        sections: rehydratedSections,
                        isCloud: true
                    };
                    
                    setCurrentProject(reconstructedProject);
                    localStorage.setItem('narrativeos-current-project-id', projectId);
                    
                    // Reset selection to first chapter
                    if (reconstructedProject.sections.length > 0) {
                        setSelectedSectionId(reconstructedProject.sections[0].id);
                        if (reconstructedProject.sections[0].chapters.length > 0) {
                            setSelectedChapterId(reconstructedProject.sections[0].chapters[0].id);
                        } else {
                            setSelectedChapterId(null);
                        }
                    }
                } catch (e) {
                    console.error("Error switching book:", e);
                    alert("Error opening book: " + e.message);
                } finally {
                    setIsCloudLoading(false);
                }
            };

            // Real-time Chapter Sync
            useEffect(() => {
                if (!currentProject || !db || !isConnectedToCloud || !selectedChapterId) return;
                
                // Only listen for cloud projects
                if (!currentProject.isCloud) return;
                
                // Find chapter in current structure
                // We assume flat structure for now based on recent fetch, 
                // but need to handle the fact that UI expects sections.
                
                const unsubscribe = onSnapshot(doc(db, "books", currentProject.id, "chapters", selectedChapterId), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        const remoteContent = data.content;
                        
                        // Update local state without triggering a save loop
                        setCurrentProject(prev => {
                            if (!prev) return prev;
                            const newProj = {...prev};
                            // Deep find and update
                            newProj.sections.forEach(s => {
                                const ch = s.chapters.find(c => c.id === selectedChapterId);
                                if (ch && ch.content !== remoteContent) {
                                    ch.content = remoteContent;
                                }
                            });
                            return newProj;
                        });
                    }
                });
                
                return () => unsubscribe();
            }, [db, isConnectedToCloud, selectedChapterId, currentProject?.id]); // Note: dependency on currentProject.id is key

            // Save Chapter changes to Firestore
            const saveChapterToCloud = async (bookId, chapterId, content, title) => {
                if (!db || !isConnectedToCloud) return;
                
                try {
                    const chapterRef = doc(db, "books", bookId, "chapters", chapterId);
                    const updatePayload = {
                        content: content,
                        last_updated: serverTimestamp()
                    };
                    if (title !== undefined && title !== null) updatePayload.title = title;

                    await updateDoc(chapterRef, updatePayload);
                    setSyncStatus('saved');
                } catch (e) {
                    console.error("Save failed", e);
                    setSyncStatus('unsaved');
                }
            };
            
            const uploadProjectToCloud = async (project) => {
                if (!db || !firebaseUser) return;
                
                // Confirm upload
                if (!confirm(`Upload "${project.name}" to the cloud? This will make it available on all your devices.`)) return;

                setIsCloudLoading(true);
                setLoadingMessage("Uploading to Cloud...");
                try {
                    // Fetch full project data locally to ensure we have chapters
                    const fullProject = ProjectStorage.getProject(project.id);

                    // 1. Create Book Document
                    const bookRef = doc(db, "books", fullProject.id);
                    
                    // Metadata
                    await setDoc(bookRef, {
                        title: fullProject.name,
                        author_id: firebaseUser.uid,
                        created_at: serverTimestamp(),
                        updated_at: serverTimestamp(),
                        sections: fullProject.sections.map(s => ({ id: s.id, name: s.name }))
                    });
                    
                    // 2. Upload Chapters
                    const chaptersRef = collection(db, "books", fullProject.id, "chapters");
                    
                    let chapterCount = 0;
                    for (const section of fullProject.sections) {
                        for (const chapter of section.chapters) {
                            const chapterDoc = doc(chaptersRef, chapter.id);
                            await setDoc(chapterDoc, {
                                ...chapter,
                                sectionId: section.id,
                                author_id: firebaseUser.uid,
                                last_updated: serverTimestamp()
                            });
                            chapterCount++;
                        }
                    }
                    
                    // 3. Update Local State
                    setProjects(prev => prev.map(p => {
                        if (p.id === fullProject.id) {
                            return { ...p, isCloud: true };
                        }
                        return p;
                    }));

                    if (currentProject && currentProject.id === fullProject.id) {
                        setCurrentProject(prev => ({ ...prev, isCloud: true }));
                    }
                    
                    alert(`Project uploaded successfully! (${chapterCount} chapters synced)`);
                    
                } catch (e) {
                    console.error("Upload failed", e);
                    alert("Upload failed: " + e.message);
                } finally {
                    setIsCloudLoading(false);
                }
            };

            // Override save function
            const saveChapterContent = (content, title, subtitle) => {
                if (!currentProject || !selectedSectionId || !selectedChapterId) return;
                
                const updatedProject = { ...currentProject };
                const sectionIndex = updatedProject.sections.findIndex(s => s.id === selectedSectionId);
                if (sectionIndex === -1) return;
                
                const chapterIndex = updatedProject.sections[sectionIndex].chapters.findIndex(c => c.id === selectedChapterId);
                if (chapterIndex === -1) return;
                
                updatedProject.sections[sectionIndex].chapters[chapterIndex].content = content;
                
                // Update title and subtitle if provided
                if (title !== null && title !== undefined) {
                    updatedProject.sections[sectionIndex].chapters[chapterIndex].title = title;
                }
                if (subtitle !== null && subtitle !== undefined) {
                    updatedProject.sections[sectionIndex].chapters[chapterIndex].subtitle = subtitle;
                }
                
                updatedProject.lastModified = Date.now();
                setCurrentProject(updatedProject);
                
                // Cloud Save
                if (isConnectedToCloud && db && currentProject.isCloud) {
                     setSyncStatus('syncing');
                     // Debounce handled by UI usually, but we call direct here.
                     // In prod, use a dedicated debounced function.
                     saveChapterToCloud(currentProject.id, selectedChapterId, content, title);
                } else {
                    ProjectStorage.saveProject(updatedProject);
                }
            };

            // Hugging Face Models List
            const HF_MODELS = [
                { id: 'bigscience/bloom', name: 'Bloom (176B) - May Timeout' },
                { id: 'bigscience/bloomz-7b1', name: 'Bloomz (7B) - Recommended' },
                { id: 'meta-llama/Meta-Llama-3-8B-Instruct', name: 'Llama 3 (8B)' },
                { id: 'mistralai/Mistral-7B-Instruct-v0.2', name: 'Mistral 7B' },
                { id: 'google/gemma-7b-it', name: 'Gemma 7B' }
            ];

            // GitHub Models List
            const GITHUB_MODELS = [
                { id: 'gpt-4o', name: 'GPT-4o' },
                { id: 'gpt-4o-mini', name: 'GPT-4o Mini' },
                { id: 'Phi-3-mini-4k-instruct', name: 'Phi-3 Mini' },
                { id: 'Mistral-Nemo', name: 'Mistral Nemo' },
                { id: 'Llama-3.1-8B-Instruct', name: 'Llama 3.1 (8B)' },
                { id: 'Llama-3.1-70B-Instruct', name: 'Llama 3.1 (70B)' }
            ];

            // Fetch available models when API key is set (Gemini Only)
            useEffect(() => {
                if (aiProvider === 'gemini' && geminiApiKey) {
                    fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiApiKey}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.models) {
                                const generateModels = data.models.filter(m => 
                                    m.supportedGenerationMethods && 
                                    m.supportedGenerationMethods.includes('generateContent')
                                ).sort((a, b) => {
                                    const aName = a.name.toLowerCase();
                                    const bName = b.name.toLowerCase();
                                    if (aName.includes('flash') && !bName.includes('flash')) return -1;
                                    if (!aName.includes('flash') && bName.includes('flash')) return 1;
                                    return aName.localeCompare(bName);
                                });
                                setAvailableModels(generateModels);
                                
                                if (!selectedModel || !generateModels.find(m => m.name === selectedModel || m.name === `models/${selectedModel}`)) {
                                    const defaultModel = generateModels.find(m => m.name.includes('gemini-1.5-flash')) || generateModels[0];
                                    if (defaultModel) {
                                        setSelectedModel(defaultModel.name);
                                    }
                                }
                            }
                        })
                        .catch(err => console.error('Failed to fetch models:', err));
                }
            }, [geminiApiKey, aiProvider]);

            const callHuggingFace = async (promptText) => {
                // Helper function for retrying with delay
                const fetchWithRetry = async (retries = 5) => {
                    const response = await fetch(`https://api-inference.huggingface.co/models/${hfModel}`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${hfToken}`,
                            "Content-Type": "application/json",
                            "x-use-cache": "false"
                        },
                        body: JSON.stringify({ 
                            inputs: promptText,
                            parameters: {
                                max_new_tokens: 1000,
                                return_full_text: false,
                                temperature: 0.7
                            }
                        }),
                    });

                    if (response.status === 503) {
                        const data = await response.json();
                        if (retries > 0 && data.estimated_time) {
                            console.log(`Model loading... waiting ${data.estimated_time}s`);
                            await new Promise(r => setTimeout(r, (data.estimated_time * 1000) + 1000));
                            return fetchWithRetry(retries - 1);
                        }
                    }

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HF Error ${response.status}: ${errorText}`);
                    }

                    return response.json();
                };

                const result = await fetchWithRetry();
                if (result.error) throw new Error(result.error);
                // HF returns array of objects or single object depending on task
                return Array.isArray(result) ? result[0].generated_text : result.generated_text;
            };

            const analyzeRelationships = async () => {
                  console.log("Starting AI Analysis...");
                  
                  if (aiProvider === 'gemini' && !geminiApiKey) {
                      alert('Please enter your Google Gemini API Key.');
                      return;
                  }
                  if (aiProvider === 'huggingface' && !hfToken) {
                      alert('Please enter your Hugging Face Token.');
                      return;
                  }
                  if (aiProvider === 'github' && !githubToken) {
                      alert('Please enter your GitHub Personal Access Token.');
                      return;
                  }
                  
                  if (!currentProject) {
                      console.error("No current project loaded.");
                      return;
                  }

                  let textToAnalyze = "";
                  if (analysisScope === 'chapter') {
                      if (!selectedChapterId) {
                          alert("Please select a chapter in the editor first.");
                          return;
                      }
                      // Find the chapter
                      let foundChapter = null;
                      for (const section of currentProject.sections) {
                          const ch = section.chapters.find(c => c.id === selectedChapterId);
                          if (ch) {
                              foundChapter = ch;
                              break;
                          }
                      }
                      if (foundChapter) {
                          textToAnalyze = foundChapter.content.replace(/<[^>]*>/g, ' ');
                      } else {
                          alert("Could not find selected chapter content.");
                          return;
                      }
                  } else {
                      // Full Project
                      textToAnalyze = currentProject.sections.map(s => s.chapters.map(c => c.content).join('\n')).join('\n').replace(/<[^>]*>/g, ' ');
                  }

                  console.log(`Analyzing text length: ${textToAnalyze.length} chars (Scope: ${analysisScope})`);
                  
                  const prompt = `
                  Analyze the relationships between characters based on the following fictional story content.
                  
                  CRITICAL: You must return a JSON object with a "timeline" property.
                  The "timeline" property must be an array of objects, representing the evolution of relationships through the story (e.g. "Beginning", "Middle", "End" or by Chapter).
                  
                  Each item in the "timeline" array must have:
                  - "label": string (e.g. "Chapter 1" or "The Meeting")
                  - "description": string (short summary of relationship dynamics at this point)
                  - "relationships": array of objects with fields: source (character name), target (character name), type (relationship type e.g. friend, enemy, sibling), strength (1-10).
                  
                  If the story is short, just return one timeline item labeled "Current State".
                  
                  STORY CONTENT (FICTIONAL):
                  ${textToAnalyze.substring(0, 95000)}`;
                  
                  setIsAiLoading(true);
                  try {
                      let jsonString = "";

                      if (aiProvider === 'gemini') {
                        const modelPath = selectedModel.startsWith('models/') ? selectedModel : `models/${selectedModel}`;
                        console.log(`Using Gemini model: ${modelPath}`);
                        
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${modelPath}:generateContent?key=${geminiApiKey}`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    system_instruction: {
                                        parts: [{ text: "You are a literary analysis tool for a creative writing application. You are analyzing fictional story content. You must not flag fictional violence, conflict, or mature themes as harmful, as they are part of the creative work. Do not censor the analysis of fictional themes." }]
                                    },
                                    contents: [{ parts: [{ text: prompt }] }],
                                    safetySettings: [
                                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                                        { category: "HARM_CATEGORY_CIVIC_INTEGRITY", threshold: "BLOCK_NONE" }
                                    ]
                                })
                            });
                            
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        if (data.promptFeedback && data.promptFeedback.blockReason) {
                            throw new Error(`Blocked: ${data.promptFeedback.blockReason}`);
                        }
                        if (data.candidates && data.candidates[0]) {
                            jsonString = data.candidates[0].content.parts[0].text;
                        }
                      } else if (aiProvider === 'github') {
                          // GitHub Models
                          console.log(`Using GitHub model: ${githubModel}`);
                          const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": `Bearer ${githubToken}`
                                },
                                body: JSON.stringify({
                                    messages: [{ role: "user", content: prompt }],
                                    model: githubModel,
                                    temperature: 0.7,
                                    max_tokens: 2000
                                })
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                throw new Error(`GitHub Models Error ${response.status}: ${errorText}`);
                            }
                            
                            const data = await response.json();
                            jsonString = data.choices[0].message.content;
                      } else {
                          // Hugging Face
                          console.log(`Using HF model: ${hfModel}`);
                          jsonString = await callHuggingFace(prompt);
                      }

                      // Try to extract JSON
                      const jsonMatch = jsonString.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                      if (jsonMatch) {
                          const parsedData = JSON.parse(jsonMatch[0]);
                          
                          if (parsedData.timeline && Array.isArray(parsedData.timeline)) {
                              persistRelationshipTimeline(parsedData.timeline);
                              setTimelineIndex(parsedData.timeline.length - 1); // Start at the end
                              persistRelationships(parsedData.timeline[parsedData.timeline.length - 1].relationships);
                              setRelationshipViewMode('analysis');
                          } else if (Array.isArray(parsedData)) {
                              // Fallback for old format (just array of relationships)
                              const fallbackTimeline = [{ label: "Current State", description: "Analysis of current text", relationships: parsedData }];
                              persistRelationshipTimeline(fallbackTimeline);
                              setTimelineIndex(0);
                              persistRelationships(parsedData);
                              setRelationshipViewMode('analysis');
                          } else {
                              console.error("Unexpected JSON format", parsedData);
                          }
                      } else {
                          console.warn("No JSON found in response", jsonString);
                      }

                  } catch (err) {
                      console.error("Analysis failed:", err);
                      alert('Analysis failed: ' + err.message);
                  } finally {
                      setIsAiLoading(false);
                  }
              };

            const analyzeTimelinePlot = async () => {
                if (!currentProject) return;
                if (aiProvider === 'gemini' && !geminiApiKey) {
                    alert('Please enter your Google Gemini API Key in the AI panel.');
                    return;
                }
                if (aiProvider === 'huggingface' && !hfToken) {
                    alert('Please enter your Hugging Face Token.');
                    return;
                }
                if (aiProvider === 'github' && !githubToken) {
                    alert('Please enter your GitHub Personal Access Token.');
                    return;
                }

                setIsAnalyzingTimeline(true);
                
                try {
                    // Gather all text from project
                    const fullText = currentProject.sections.map(s => 
                        s.chapters.map(c => c.content).join('\n')
                    ).join('\n').replace(/<[^>]*>/g, ' ');

                    const prompt = `Analyze this story and extract the key plot beats in chronological order.
                    
                    STORY CONTENT (FICTIONAL):
                    ${fullText.substring(0, 95000)}
                    
                    Return ONLY a JSON object with:
                    - "beats": array of plot beats with fields:
                      - "title": short beat name (e.g., "Inciting Incident", "First Plot Point")
                      - "description": one sentence summary
                      - "chapter": estimated chapter number (1-based)
                      - "lane": story lane ("Main Plot", "Character Arc", "B-Plot", or "Theme")
                      - "intensity": emotional/tension intensity (1-10)`;

                    let jsonString = "";
                    
                    if (aiProvider === 'gemini') {
                        const modelPath = selectedModel.startsWith('models/') ? selectedModel : `models/${selectedModel}`;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${modelPath}:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                system_instruction: {
                                    parts: [{ text: "You are a story structure analyst. Analyze fictional content without censorship." }]
                                },
                                contents: [{ parts: [{ text: prompt }] }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_CIVIC_INTEGRITY", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        if (data.candidates && data.candidates[0]) {
                            jsonString = data.candidates[0].content.parts[0].text;
                        }
                    } else if (aiProvider === 'github') {
                        const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${githubToken}`
                            },
                            body: JSON.stringify({
                                messages: [{ role: "user", content: prompt }],
                                model: githubModel,
                                temperature: 0.7,
                                max_tokens: 2000
                            })
                        });
                        if (!response.ok) throw new Error(`GitHub Models Error ${response.status}`);
                        const data = await response.json();
                        jsonString = data.choices[0].message.content;
                    } else {
                        jsonString = await callHuggingFace(prompt);
                    }

                    // Parse JSON response
                    const jsonMatch = jsonString.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const parsedData = JSON.parse(jsonMatch[0]);
                        
                        if (parsedData.beats && Array.isArray(parsedData.beats)) {
                            // Convert beats to timeline format
                            const convertedBeats = parsedData.beats.map((beat, idx) => ({
                                id: `ai-beat-${Date.now()}-${idx}`,
                                title: beat.title,
                                description: beat.description || '',
                                lane: beat.lane || 'Main Plot',
                                start: beat.chapter || idx + 1,
                                duration: 1,
                                intensity: beat.intensity || 5,
                                color: getLaneColor(beat.lane || 'Main Plot'),
                                type: 'beat'
                            }));
                            
                            // Update project timeline
                            const updatedProject = { ...currentProject };
                            updatedProject.timeline = convertedBeats;
                            setCurrentProject(updatedProject);
                            ProjectStorage.saveProject(updatedProject);
                            
                            alert('Plot analysis complete! Timeline updated with story beats.');
                        }
                    } else {
                        throw new Error('Could not parse AI response');
                    }
                } catch (err) {
                    console.error('Timeline analysis failed:', err);
                    alert('Analysis failed: ' + err.message);
                } finally {
                    setIsAnalyzingTimeline(false);
                }
            };
            
            const suggestNextBeats = async () => {
                if (!currentProject || !currentProject.timeline || currentProject.timeline.length === 0) {
                    alert('Please analyze your plot first or add some beats manually.');
                    return;
                }
                if (aiProvider === 'gemini' && !geminiApiKey) {
                    alert('Please enter your Google Gemini API Key.');
                    return;
                }
                if (aiProvider === 'huggingface' && !hfToken) {
                    alert('Please enter your Hugging Face Token.');
                    return;
                }
                if (aiProvider === 'github' && !githubToken) {
                    alert('Please enter your GitHub Personal Access Token.');
                    return;
                }

                setIsAnalyzingTimeline(true);
                
                try {
                    const existingBeats = currentProject.timeline.map(b => 
                        `${b.title} (Chapter ${b.start}, ${b.lane}, Intensity: ${b.intensity})`
                    ).join('\n');
                    
                    const fullText = currentProject.sections.map(s => 
                        s.chapters.map(c => c.content).join('\n')
                    ).join('\n').replace(/<[^>]*>/g, ' ');

                    const prompt = `Based on this story and its existing plot structure, suggest 3-5 future story beats that would logically follow.
                    
                    EXISTING BEATS:
                    ${existingBeats}
                    
                    STORY CONTENT (FICTIONAL):
                    ${fullText.substring(0, 50000)}
                    
                    Return ONLY a JSON object with:
                    - "suggestions": array of 3-5 suggested future beats with fields:
                      - "title": short beat name
                      - "description": one sentence summary
                      - "chapter": estimated chapter number (should be after current beats)
                      - "lane": story lane ("Main Plot", "Character Arc", "B-Plot", or "Theme")
                      - "intensity": emotional/tension intensity (1-10)`;

                    let jsonString = "";
                    
                    if (aiProvider === 'gemini') {
                        const modelPath = selectedModel.startsWith('models/') ? selectedModel : `models/${selectedModel}`;
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/${modelPath}:generateContent?key=${geminiApiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                system_instruction: {
                                    parts: [{ text: "You are a story structure consultant. Generate creative suggestions for fictional content." }]
                                },
                                contents: [{ parts: [{ text: prompt }] }],
                                safetySettings: [
                                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
                                    { category: "HARM_CATEGORY_CIVIC_INTEGRITY", threshold: "BLOCK_NONE" }
                                ]
                            })
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message);
                        if (data.candidates && data.candidates[0]) {
                            jsonString = data.candidates[0].content.parts[0].text;
                        }
                    } else if (aiProvider === 'github') {
                        const response = await fetch("https://models.inference.ai.azure.com/chat/completions", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${githubToken}`
                            },
                            body: JSON.stringify({
                                messages: [{ role: "user", content: prompt }],
                                model: githubModel,
                                temperature: 0.8,
                                max_tokens: 1500
                            })
                        });
                        if (!response.ok) throw new Error(`GitHub Models Error ${response.status}`);
                        const data = await response.json();
                        jsonString = data.choices[0].message.content;
                    } else {
                        jsonString = await callHuggingFace(prompt);
                    }

                    const jsonMatch = jsonString.match(/\{[\s\S]*\}|\[[\s\S]*\]/);
                    if (jsonMatch) {
                        const parsedData = JSON.parse(jsonMatch[0]);
                        
                        if (parsedData.suggestions && Array.isArray(parsedData.suggestions)) {
                            const lastChapter = Math.max(...currentProject.timeline.map(b => b.start));
                            const convertedSuggestions = parsedData.suggestions.map((beat, idx) => ({
                                id: `suggestion-${Date.now()}-${idx}`,
                                title: beat.title,
                                description: beat.description || '',
                                lane: beat.lane || 'Main Plot',
                                start: beat.chapter || (lastChapter + idx + 1),
                                duration: 1,
                                intensity: beat.intensity || 5,
                                color: getLaneColor(beat.lane || 'Main Plot'),
                                type: 'suggestion',
                                suggested: true
                            }));
                            setSuggestedBeats(convertedSuggestions);
                            alert(`Generated ${convertedSuggestions.length} beat suggestions!`);
                        }
                    } else {
                        throw new Error('Could not parse AI response');
                    }
                } catch (err) {
                    console.error('Suggestion generation failed:', err);
                    alert('Failed to generate suggestions: ' + err.message);
                } finally {
                    setIsAnalyzingTimeline(false);
                }
            };
            
            const getLaneColor = (lane) => {
                const colors = {
                    'Main Plot': 'bg-blue-500',
                    'Character Arc': 'bg-purple-500',
                    'B-Plot': 'bg-emerald-500',
                    'Theme': 'bg-amber-500'
                };
                return colors[lane] || 'bg-slate-500';
            };
            
            const acceptSuggestion = (suggestion) => {
                const updatedProject = { ...currentProject };
                const newBeat = { ...suggestion, type: 'beat', suggested: false };
                updatedProject.timeline = [...(updatedProject.timeline || []), newBeat];
                setCurrentProject(updatedProject);
                ProjectStorage.saveProject(updatedProject);
                setSuggestedBeats(prev => prev.filter(s => s.id !== suggestion.id));
            };
            
            const deleteBeat = (beatId) => {
                const updatedProject = { ...currentProject };
                updatedProject.timeline = (updatedProject.timeline || []).filter(b => b.id !== beatId);
                setCurrentProject(updatedProject);
                ProjectStorage.saveProject(updatedProject);
            };
            
            const updateBeat = (beatId, updates) => {
                const updatedProject = { ...currentProject };
                const beatIndex = (updatedProject.timeline || []).findIndex(b => b.id === beatId);
                if (beatIndex !== -1) {
                    updatedProject.timeline[beatIndex] = { ...updatedProject.timeline[beatIndex], ...updates };
                    setCurrentProject(updatedProject);
                    ProjectStorage.saveProject(updatedProject);
                }
            };
            
            // Initialize Projects
            useEffect(() => {
                const allProjectsRaw = ProjectStorage.getAllProjects();
                const allProjects = allProjectsRaw.map(normalizeProject);
                setProjects(allProjects);
                if (allProjects.length > 0) {
                    const first = normalizeProject(allProjects[0]);
                    setCurrentProject(first);
                    if (first.sections.length > 0) {
                        setSelectedSectionId(first.sections[0].id);
                        if (first.sections[0].chapters.length > 0) {
                            setSelectedChapterId(first.sections[0].chapters[0].id);
                        }
                    }
                }
            }, []);
            
            // Calculate total word count
            useEffect(() => {
                if (!currentProject) return;
                let totalWords = 0;
                let totalChars = 0;
                currentProject.sections.forEach(section => {
                    section.chapters.forEach(chapter => {
                        const text = chapter.content.replace(/<[^>]*>/g, ' ').trim();
                        totalWords += text ? text.split(/\s+/).length : 0;
                        totalChars += text.replace(/\s/g, '').length;
                    });
                });
                setGlobalWordCount(totalWords);
                setGlobalCharCount(totalChars);
            }, [currentProject]);
            
            // Get current chapter
            const getCurrentChapter = () => {
                if (!currentProject || !selectedSectionId || !selectedChapterId) return null;
                const section = currentProject.sections.find(s => s.id === selectedSectionId);
                if (!section) return null;
                return section.chapters.find(c => c.id === selectedChapterId);
            };
            
            // Save chapter content handled by cloud-aware override above
            
            // Add new section
            const addSection = async (name) => {
                if (!currentProject) return;
                const newSection = {
                    id: `section-${Date.now()}`,
                    name: name,
                    chapters: []
                };
                
                const updatedProject = { ...currentProject };
                updatedProject.sections.push(newSection);
                setCurrentProject(updatedProject);
                
                if (isConnectedToCloud && db && currentProject.isCloud) {
                     const sectionsMeta = updatedProject.sections.map(s => ({ id: s.id, name: s.name }));
                     try {
                         const bookRef = doc(db, "books", currentProject.id);
                         await updateDoc(bookRef, { sections: sectionsMeta });
                     } catch(e) { console.error("Cloud section add error", e); }
                } else {
                    ProjectStorage.saveProject(updatedProject);
                }
            };
            
            // Add new chapter
            const addChapter = async (sectionId) => {
                if (!currentProject) return;
                const section = currentProject.sections.find(s => s.id === sectionId);
                if (!section) return;
                
                const chapterNum = section.chapters.length + 1;
                const newChapter = {
                    id: `ch-${Date.now()}`,
                    title: `Chapter ${chapterNum}`,
                    subtitle: '',
                    content: `<h1>Chapter ${chapterNum}</h1><p>Start writing...</p>`,
                    status: 'draft',
                    targetWords: 2500,
                    characterTags: [],
                    notes: '',
                    sectionId: sectionId,
                    order_index: Date.now() 
                };
                
                // Optimistic Update
                const updatedProject = { ...currentProject };
                const sectionIndex = updatedProject.sections.findIndex(s => s.id === sectionId);
                updatedProject.sections[sectionIndex].chapters.push(newChapter);
                setCurrentProject(updatedProject);
                
                if (isConnectedToCloud && db && currentProject.isCloud) {
                    try {
                         const chaptersRef = collection(db, "books", currentProject.id, "chapters");
                         const { id, ...chapterData } = newChapter;
                         const docRef = await addDoc(chaptersRef, {
                             ...chapterData,
                             last_updated: serverTimestamp()
                         });
                         
                         // Update with real ID
                         const finalProject = { ...updatedProject };
                         finalProject.sections[sectionIndex].chapters[finalProject.sections[sectionIndex].chapters.length - 1].id = docRef.id;
                         setCurrentProject(finalProject);
                         setSelectedChapterId(docRef.id);
                    } catch(e) { console.error("Cloud chapter add error", e); }
                } else {
                    ProjectStorage.saveProject(updatedProject);
                    setSelectedChapterId(newChapter.id);
                }
            };
            
            // Update chapter details
            const updateChapter = async (sectionId, chapterId, updates) => {
                if (!currentProject) return;
                const updatedProject = { ...currentProject };
                const sectionIndex = updatedProject.sections.findIndex(s => s.id === sectionId);
                if (sectionIndex === -1) return;
                
                const chapterIndex = updatedProject.sections[sectionIndex].chapters.findIndex(c => c.id === chapterId);
                if (chapterIndex === -1) return;
                
                updatedProject.sections[sectionIndex].chapters[chapterIndex] = {
                    ...updatedProject.sections[sectionIndex].chapters[chapterIndex],
                    ...updates
                };
                
                setCurrentProject(updatedProject);
                
                if (isConnectedToCloud && db && currentProject.isCloud) {
                    try {
                        const chapterRef = doc(db, "books", currentProject.id, "chapters", chapterId);
                        await updateDoc(chapterRef, {
                            ...updates,
                            last_updated: serverTimestamp()
                        });
                    } catch(e) { console.error("Cloud chapter update error", e); }
                } else {
                    ProjectStorage.saveProject(updatedProject);
                }
            };

            // --- RENDERERS ---

            // 1. THE SIDEBAR (BINDER)
            const renderSidebar = () => {
                if (focusMode || !currentProject) return null;

                return (
                <aside className="w-72 bg-slate-950 border-r border-slate-900 flex flex-col h-full transition-all duration-300">
                    <div className="p-4 border-b border-slate-900 flex items-center justify-between">
                        <div className="flex items-center gap-2 flex-1 min-w-0">
                            <img src="N.svg" alt="NarrativeOS" className="w-10 h-10 flex-shrink-0" />
                            <input 
                                type="text" 
                                value={currentProject.name}
                                onChange={(e) => {
                                    const updatedProject = { ...currentProject, name: e.target.value };
                                    setCurrentProject(updatedProject);
                                    ProjectStorage.saveProject(updatedProject);
                                }}
                                className="font-bold text-slate-200 tracking-wide bg-transparent border-none outline-none hover:text-white focus:text-white truncate flex-1 min-w-0"
                                placeholder="Project Name"
                            />
                        </div>
                        <div className="flex items-center gap-2 flex-shrink-0">
                            <button 
                                onClick={() => setShowProjectModal(true)}
                                className="text-slate-600 hover:text-slate-300 cursor-pointer"
                                title="Projects"
                            >
                                <BookOpen className="w-4 h-4" />
                            </button>
                            <Settings className="w-4 h-4 text-slate-600 hover:text-slate-300 cursor-pointer" />
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-2 scrollbar-thin">
                        <div className="flex items-center justify-between text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-2 px-2">
                            <span>Manuscript Structure</span>
                            <button 
                                onClick={() => {
                                    const name = prompt('Section name:', `Part ${currentProject.sections.length + 1}`);
                                    if (name) addSection(name);
                                }}
                                className="text-indigo-500 hover:text-indigo-400"
                                title="Add Section"
                            >
                                <Plus className="w-3 h-3" />
                            </button>
                        </div>
                        
                        {/* Render Sections and Chapters */}
                        {currentProject.sections.map((section, sectionIdx) => (
                            <div key={section.id} className="mb-2">
                                <div className="flex items-center text-slate-300 hover:bg-slate-900 p-2 rounded cursor-pointer group">
                                    <ChevronDown className="w-3 h-3 mr-2 text-slate-500" />
                                    <input
                                        type="text"
                                        value={section.name}
                                        onChange={(e) => {
                                            const updatedProject = { ...currentProject };
                                            updatedProject.sections[sectionIdx].name = e.target.value;
                                            setCurrentProject(updatedProject);
                                            ProjectStorage.saveProject(updatedProject);
                                        }}
                                        className="font-medium text-sm flex-1 bg-transparent border-none outline-none"
                                        onClick={(e) => e.stopPropagation()}
                                    />
                                    <button
                                        onClick={() => addChapter(section.id)}
                                        className="opacity-0 group-hover:opacity-100 text-indigo-500 hover:text-indigo-400"
                                        title="Add Chapter"
                                    >
                                        <Plus className="w-3 h-3" />
                                    </button>
                                </div>
                                
                                <div className="ml-4 border-l border-slate-800 pl-2">
                                    {section.chapters.map((chapter) => {
                                        const text = chapter.content.replace(/<[^>]*>/g, ' ').trim();
                                        const wordCount = text ? text.split(/\s+/).length : 0;
                                        const isSelected = selectedChapterId === chapter.id;
                                        
                                        return (
                                            <div 
                                                key={chapter.id}
                                                onClick={() => { 
                                                    setSelectedSectionId(section.id);
                                                    setSelectedChapterId(chapter.id); 
                                                    setActiveTab('write'); 
                                                }}
                                                className={`group relative p-2 rounded mb-1 cursor-pointer transition-all border border-transparent ${isSelected ? 'bg-slate-900 border-slate-800' : 'hover:bg-slate-900/50'}`}
                                            >
                                                <div className="flex items-center justify-between mb-1">
                                                    <input
                                                        type="text"
                                                        value={chapter.title}
                                                        onChange={(e) => updateChapter(section.id, chapter.id, { title: e.target.value })}
                                                        className={`text-sm ${isSelected ? 'text-white' : 'text-slate-400'} bg-transparent border-none outline-none flex-1`}
                                                        onClick={(e) => e.stopPropagation()}
                                                    />
                                                    <div 
                                                        className={`w-2 h-2 rounded-full ${
                                                            chapter.status === 'final' ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]' :
                                                            chapter.status === 'revised' ? 'bg-yellow-500' :
                                                            'bg-red-500'
                                                        }`} 
                                                        title={`Status: ${chapter.status}`} 
                                                    />
                                                </div>
                                                <input
                                                    type="text"
                                                    value={chapter.subtitle}
                                                    onChange={(e) => updateChapter(section.id, chapter.id, { subtitle: e.target.value })}
                                                    placeholder="Chapter subtitle..."
                                                    className="text-xs text-slate-500 truncate mb-1 bg-transparent border-none outline-none w-full"
                                                    onClick={(e) => e.stopPropagation()}
                                                />
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-1">
                                                        {chapter.characterTags.map(tag => (
                                                            <span key={tag} className="text-[10px] px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-400 border border-blue-500/20">{tag}</span>
                                                        ))}
                                                    </div>
                                                    <span className="text-[10px] text-slate-600">{wordCount} / {chapter.targetWords}</span>
                                                </div>
                                                <ProgressBar current={wordCount} max={chapter.targetWords} color={wordCount >= chapter.targetWords ? "bg-emerald-500" : "bg-indigo-500"} />
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        ))}

                        <div className="text-[10px] font-bold text-slate-600 uppercase tracking-wider mb-2 mt-6 px-2">Story Codex</div>
                        {['Characters', 'Locations', 'Lore', 'Items'].map(item => (
                            <div 
                                key={item} 
                                onClick={() => setActiveTab('world')}
                                className="flex items-center text-slate-400 hover:bg-slate-800 p-2 rounded cursor-pointer text-sm"
                            >
                                <BookOpen className="w-3 h-3 mr-2 text-indigo-500" /> {item}
                            </div>
                        ))}
                    </div>
                </aside>
                );
            };

            // 2. THE EDITOR (CREATOR MODE)
            const renderEditor = () => {
                const currentChapter = getCurrentChapter();
                if (!currentChapter) {
                    return (
                        <div className="flex-1 h-full bg-[#0b0c0f] flex items-center justify-center">
                            <div className="text-center text-slate-500">
                                <PenTool className="w-12 h-12 mx-auto mb-4 opacity-50" />
                                <p>Select or create a chapter to start writing</p>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <div className="flex-1 h-full bg-[#0b0c0f] relative">
                        <WordEditor 
                            key={selectedChapterId}
                            initialContent={currentChapter.content}
                            projectName={currentProject.name}
                            geminiApiKey={geminiApiKey}
                            setGeminiApiKey={setGeminiApiKey}
                            availableModels={availableModels}
                            selectedModel={selectedModel}
                            setSelectedModel={setSelectedModel}
                            aiProvider={aiProvider}
                            setAiProvider={setAiProvider}
                            hfToken={hfToken}
                            setHfToken={setHfToken}
                            hfModel={hfModel}
                            setHfModel={setHfModel}
                            HF_MODELS={HF_MODELS}
                            githubToken={githubToken}
                            setGithubToken={setGithubToken}
                            githubModel={githubModel}
                            setGithubModel={setGithubModel}
                            GITHUB_MODELS={GITHUB_MODELS}
                            isConnectedToCloud={isConnectedToCloud}
                            onConnectCloud={handleConnectCloud}
                            userInfo={userInfo}
                            setUserInfo={setUserInfo}
                            onContentChange={(content) => saveChapterContent(content)}
                            onStatsUpdate={(w, c) => {
                                setGlobalWordCount(w);
                                setGlobalCharCount(c);
                            }}
                        />
                    </div>
                );
            };

            const renderEditorOld = () => {
                // Text Processing Logic for Visual Modes
                const renderText = () => {
                    if (textMode === 'blind') {
                        return (
                            <div className="font-serif text-slate-300 leading-relaxed text-lg whitespace-pre-wrap outline-none relative">
                                <span className="blur-sm select-none opacity-50 transition-all duration-1000">{SAMPLE_TEXT.slice(0, -100)}</span>
                                <span className="blur-none">{SAMPLE_TEXT.slice(-100)}</span>
                                <span className="animate-pulse text-indigo-500">|</span>
                            </div>
                        )
                    }

                    const sentences = SAMPLE_TEXT.split(/(?<=[.!?])\s+/);
                    
                    return (
                        <div className="font-serif text-slate-300 leading-relaxed text-lg whitespace-pre-wrap outline-none">
                            {sentences.map((s, i) => {
                                let className = "";
                                let style = {};
                                
                                if (textMode === 'rhythm') {
                                    const wordCount = s.split(' ').length;
                                    if (wordCount < 8) className = "bg-emerald-500/20 border-b-2 border-emerald-500/50";
                                    else if (wordCount > 25) className = "bg-red-500/20 border-b-2 border-red-500/50";
                                    else className = "bg-yellow-500/20 border-b-2 border-yellow-500/50";
                                } else if (textMode === 'hemingway') {
                                    if (s.includes('ly')) className = "bg-blue-500/20 text-blue-200"; // crude adverb check
                                    if (s.includes('was') || s.includes('were')) className = "bg-pink-500/20 text-pink-200"; // crude passive check
                                }

                                return <span key={i} className={`rounded px-0.5 transition-colors duration-500 ${className}`}>{s} </span>
                            })}
                        </div>
                    )
                };

                return (
                <div className={`flex-1 flex flex-col h-full bg-[#0b0c0f] relative transition-all duration-700 ${focusMode ? 'scale-100' : ''}`}>
                    
                    {/* Editor Toolbar */}
                    <div className={`h-14 border-b border-slate-900 flex items-center justify-between px-6 bg-[#0b0c0f] z-20 transition-opacity duration-500 ${focusMode ? 'opacity-0 hover:opacity-100' : 'opacity-100'}`}>
                    <div className="flex items-center gap-4">
                        <span className="text-slate-400 font-serif italic text-lg">Chapter 1: The Inciting Incident</span>
                        <div className="h-4 w-px bg-slate-800"></div>
                        
                        {/* VISUAL LAYERS MENU */}
                        <div className="flex bg-slate-900 rounded-lg p-0.5 border border-slate-800">
                            <button 
                                onClick={() => setTextMode('normal')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'normal' ? 'bg-slate-700 text-white' : 'text-slate-500 hover:text-white'}`}
                            >Normal</button>
                            <button 
                                onClick={() => setTextMode('rhythm')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'rhythm' ? 'bg-indigo-600 text-white' : 'text-slate-500 hover:text-white'}`}
                            >Rhythm</button>
                            <button 
                                onClick={() => setTextMode('hemingway')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'hemingway' ? 'bg-pink-600 text-white' : 'text-slate-500 hover:text-white'}`}
                            >Hemingway</button>
                            <button 
                                onClick={() => setTextMode('blind')}
                                className={`px-3 py-1 rounded-md text-xs font-medium transition-all ${textMode === 'blind' ? 'bg-slate-200 text-black' : 'text-slate-500 hover:text-white'}`}
                            >Blind</button>
                        </div>

                        {/* AMBIENT CONTROL */}
                        <div className="flex items-center gap-2 ml-2">
                            <button 
                                onClick={() => setAmbientSound(ambientSound === 'rain' ? null : 'rain')}
                                className={`p-1.5 rounded-full ${ambientSound === 'rain' ? 'bg-blue-500/20 text-blue-400' : 'text-slate-600 hover:text-slate-300'}`}
                                title="Rain Soundscape"
                            >
                                <Cloud className="w-4 h-4" />
                            </button>
                            <button 
                                onClick={() => setAmbientSound(ambientSound === 'coffee' ? null : 'coffee')}
                                className={`p-1.5 rounded-full ${ambientSound === 'coffee' ? 'bg-amber-500/20 text-amber-400' : 'text-slate-600 hover:text-slate-300'}`}
                                title="Coffee Shop"
                            >
                                <Coffee className="w-4 h-4" />
                            </button>
                        </div>
                    </div>

                    <div className="flex items-center gap-3">
                        <button 
                            onClick={() => setShowHistory(!showHistory)}
                            className={`p-2 rounded ${showHistory ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500 hover:bg-slate-800'}`}
                            title="Version History (Time Machine)"
                        >
                        <GitBranch className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setShowComments(!showComments)}
                            className={`p-2 rounded ${showComments ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500 hover:bg-slate-800'}`}
                            title="Beta Reader Reactions"
                        >
                        <MessageSquare className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setSplitScreen(!splitScreen)}
                            className={`p-2 rounded ${splitScreen ? 'bg-indigo-500/20 text-indigo-400' : 'text-slate-500 hover:bg-slate-800'}`}
                            title="Split Screen Reference"
                        >
                        <Layout className="w-4 h-4" />
                        </button>
                        <button 
                            onClick={() => setFocusMode(!focusMode)} 
                            className={`flex items-center gap-2 px-3 py-1.5 rounded-full transition-all border ${focusMode ? 'bg-indigo-500 border-indigo-500 text-white shadow-[0_0_15px_rgba(99,102,241,0.5)]' : 'bg-transparent border-slate-700 text-slate-300 hover:border-slate-500'}`}
                        >
                        {focusMode ? <Minimize2 className="w-3 h-3" /> : <Maximize2 className="w-3 h-3" />}
                        <span className="text-xs font-medium">{focusMode ? 'Exit Focus' : 'Deep Focus'}</span>
                        </button>
                    </div>
                    </div>

                    {/* TIME MACHINE OVERLAY (Version Control) */}
                    {showHistory && (
                        <div className="h-16 bg-[#0f1116] border-b border-slate-800 flex items-center px-8 gap-4 animate-in slide-in-from-top-2">
                            <GitBranch className="w-4 h-4 text-emerald-500" />
                            <span className="text-xs font-bold text-slate-400 uppercase">Time Machine</span>
                            <input 
                                type="range" 
                                min="1" max="10" 
                                value={versionSlider} 
                                onChange={(e) => setVersionSlider(e.target.value)}
                                className="flex-1 accent-emerald-500 h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer"
                            />
                            <div className="text-xs text-slate-300 font-mono">
                                {versionSlider === 10 ? 'Current Draft' : `Draft v1.${versionSlider} (${10 - versionSlider} days ago)`}
                            </div>
                            <div className="flex gap-2">
                                <span className="text-[10px] text-red-400">-12 deletions</span>
                                <span className="text-[10px] text-emerald-400">+45 additions</span>
                            </div>
                        </div>
                    )}

                    {/* Main Typing Area */}
                    <div className="flex-1 overflow-y-auto relative flex scrollbar-hide">
                    
                    {/* Main Pane */}
                    <div className={`flex-1 flex justify-center py-12 transition-all duration-500 relative`}>
                        {/* REACTION MAP LAYER */}
                        {showComments && (
                            <div className="absolute top-0 right-8 bottom-0 w-8 py-12 flex flex-col items-center gap-12 pointer-events-none opacity-80">
                                <div className="mt-[320px] text-xl" title="3 Readers loved this">❤️</div>
                                <div className="mt-[20px] text-xl grayscale opacity-50" title="1 Reader was bored">😴</div>
                                <div className="mt-[100px] text-xl" title="5 Readers were shocked">😲</div>
                            </div>
                        )}

                        <div className="w-full max-w-2xl px-8">
                        {/* Typewriter Padding */}
                        <div className="h-[35vh] w-full pointer-events-none"></div>
                        
                        <h1 className="text-4xl font-serif text-slate-100 mb-10 tracking-tight">Chapter 1: The Inciting Incident</h1>
                        
                        {renderText()}
                        
                        {/* Bottom Padding */}
                        <div className="h-[50vh] w-full pointer-events-none"></div>
                        </div>
                    </div>

                    {/* Split Pane (Context) */}
                    {splitScreen && (
                        <div className="w-[400px] border-l border-slate-800 bg-[#0f1116] flex flex-col animate-in slide-in-from-right-10">
                        <div className="p-4 border-b border-slate-800 flex items-center justify-between">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-wider">Contextual Reference</h3>
                            <button onClick={() => setSplitScreen(false)}><Minimize2 className="w-3 h-3 text-slate-500" /></button>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {/* Auto-detected Entity Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800 hover:border-indigo-500/50 transition-colors cursor-pointer group">
                                <div className="flex items-center gap-3 mb-3">
                                <div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">K</div>
                                <div>
                                    <div className="font-bold text-slate-200 group-hover:text-indigo-400 transition-colors">Kael</div>
                                    <div className="text-xs text-slate-500">Protagonist • Mercenary</div>
                                </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-400 mb-3">
                                    <div className="bg-slate-950 p-2 rounded">AGE: 32</div>
                                    <div className="bg-slate-950 p-2 rounded">EYES: Cybernetic</div>
                                </div>
                                <p className="text-sm text-slate-400 leading-snug">
                                <span className="text-indigo-400 font-bold">Goal:</span> Secure credits for optic repair.<br/>
                                <span className="text-indigo-400 font-bold">Lie:</span> "I don't need anyone."
                                </p>
                            </div>

                            {/* Location Card */}
                            <div className="bg-slate-900 p-4 rounded-lg border border-slate-800">
                                <div className="flex items-center gap-2 mb-2">
                                <Map className="w-4 h-4 text-emerald-500" />
                                <span className="font-bold text-slate-200">Sector 7 Docks</span>
                                </div>
                                <div className="h-32 bg-slate-950 rounded mb-2 overflow-hidden relative group border border-slate-800">
                                    {/* Mock Map */}
                                    <svg className="w-full h-full opacity-50" viewBox="0 0 100 100">
                                        <rect width="100" height="100" fill="#0f172a" />
                                        <path d="M 20 20 L 40 40 L 80 20" stroke="#334155" fill="none" />
                                        <circle cx="40" cy="40" r="3" fill="#10b981" />
                                        <text x="45" y="42" fill="white" fontSize="5">You Are Here</text>
                                    </svg>
                                </div>
                                <p className="text-xs text-slate-500">
                                    Atmosphere: Rain, Neon, Industrial Decay.<br/>
                                    Sensory: Smell of ozone and rotting fish.
                                </p>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* AI FAB */}
                    {!focusMode && (
                        <div className="absolute bottom-8 right-8 z-30">
                        <button 
                            onClick={() => setShowAiPanel(true)}
                            className="w-14 h-14 bg-gradient-to-br from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 rounded-full shadow-[0_0_20px_rgba(79,70,229,0.5)] flex items-center justify-center text-white transition-transform hover:scale-110 active:scale-95"
                            title="AI Creative Assistant"
                        >
                            <Zap className="w-6 h-6" />
                        </button>
                        </div>
                    )}
                    </div>
                    
                    {/* AI MODAL */}
                    {showAiPanel && (
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-end">
                            <div className="w-[450px] h-full bg-[#13151a] border-l border-slate-800 shadow-2xl flex flex-col animate-in slide-in-from-right duration-300">
                                <div className="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
                                    <h2 className="text-lg font-bold text-white flex items-center gap-2"><Zap className="w-5 h-5 text-purple-400" /> Creative Assistant</h2>
                                    <button onClick={() => setShowAiPanel(false)} className="text-slate-500 hover:text-white"><Minimize2 className="w-4 h-4" /></button>
                                </div>
                                <div className="p-6 flex-1 overflow-y-auto space-y-6">
                                    {/* 1. Generate Image */}
                                    <div className="bg-slate-900 rounded-xl p-4 border border-slate-800">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><ImageIcon className="w-3 h-3" /> Generative Storyboard</h3>
                                        <div className="bg-black/40 p-3 rounded text-sm text-slate-300 italic mb-3 border border-slate-800">
                                            "The neon reflections of the noodle shop dancing in his artificial retina..."
                                        </div>
                                        <div className="aspect-video bg-slate-950 rounded border border-slate-800 flex items-center justify-center mb-3 group cursor-pointer relative overflow-hidden">
                                            <div className="absolute inset-0 bg-gradient-to-br from-blue-900/20 to-purple-900/20 group-hover:scale-105 transition-transform"></div>
                                            <span className="text-xs text-slate-500 flex items-center gap-2 z-10"><RefreshCcw className="w-3 h-3" /> Generate Image</span>
                                        </div>
                                    </div>

                                    {/* 2. Structural Critique */}
                                    <div className="bg-slate-900 rounded-xl p-4 border border-slate-800">
                                        <h3 className="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><AlertTriangle className="w-3 h-3" /> The Brutal Bot</h3>
                                        <div className="space-y-3">
                                            <div className="flex gap-3">
                                                <div className="w-1 h-full bg-red-500 rounded-full"></div>
                                                <div>
                                                    <div className="text-xs text-red-400 font-bold">Pacing Alert</div>
                                                    <p className="text-xs text-slate-400 mt-1">Paragraph 3 is 40% slower than the preceding action beat. Consider shortening sentences to maintain tension.</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-3">
                                                <div className="w-1 h-full bg-yellow-500 rounded-full"></div>
                                                <div>
                                                    <div className="text-xs text-yellow-400 font-bold">Show, Don't Tell</div>
                                                    <p className="text-xs text-slate-400 mt-1">"He was angry" detected. Try describing his physical reaction instead.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t border-slate-800 bg-slate-900">
                                    <input type="text" placeholder="Ask AI to expand scene..." className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500" />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                );
            };

            // 3. THE ARCHITECT (TIMELINE MODE)
            // 3. THE TIMELINE (ARCHITECT)
            const renderTimeline = () => {
                if (!currentProject) return null;
                
                const timeline = currentProject.timeline || [];
                const hasTimeline = timeline.length > 0;
                const totalChapters = currentProject.sections.reduce((acc, s) => acc + s.chapters.length, 0);

                // Layout helpers to prevent overlap and stretch grid if beats overflow chapters
                const chapterWidthRem = 12;
                const clampChapter = (val) => Math.max(1, Math.round(val || 1));
                let maxChaptersSpan = totalChapters;

                const computeLaneLayout = (lane) => {
                    let cursor = 1; // rolling chapter pointer to avoid overlap
                    const items = [
                        ...timeline.filter(t => t.lane === lane).map(t => ({ ...t, _kind: 'beat' })),
                        ...suggestedBeats.filter(s => s.lane === lane).map(s => ({ ...s, _kind: 'suggestion' }))
                    ].sort((a, b) => clampChapter(a.start) - clampChapter(b.start));

                    return items.map(item => {
                        const duration = Math.max(1, Math.round(item.duration || 1));
                        const start = clampChapter(item.start);
                        const placedStart = Math.max(start, cursor);
                        const leftRem = (placedStart - 1) * chapterWidthRem;
                        const widthRem = duration * chapterWidthRem;
                        cursor = placedStart + duration;
                        maxChaptersSpan = Math.max(maxChaptersSpan, cursor - 1);
                        return { item, layout: { leftRem, widthRem, placedStart, duration } };
                    });
                };

                const laneLayouts = {
                    'Main Plot': computeLaneLayout('Main Plot'),
                    'Character Arc': computeLaneLayout('Character Arc'),
                    'B-Plot': computeLaneLayout('B-Plot'),
                    'Theme': computeLaneLayout('Theme')
                };

                const effectiveChapters = Math.max(10, totalChapters, maxChaptersSpan);
                
                return (
                <div className="flex-1 bg-[#13151a] flex flex-col overflow-hidden">
                    <div className="h-12 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900">
                        <div className="flex items-center gap-4">
                            <div className="flex bg-slate-800 rounded p-1">
                                <button className="px-3 py-1 text-xs font-medium bg-slate-700 text-white rounded shadow-sm">Timeline View</button>
                            </div>
                            <div className="text-xs text-slate-400">
                                {timeline.length} beat(s) • {suggestedBeats.length} suggestion(s) • {totalChapters} chapter(s)
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={analyzeTimelinePlot}
                                disabled={isAnalyzingTimeline}
                                className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 hover:bg-purple-500 disabled:bg-purple-800 disabled:cursor-not-allowed text-white text-xs font-bold rounded shadow-lg transition-colors"
                            >
                                {isAnalyzingTimeline ? (
                                    <><Loader2 className="w-3 h-3 animate-spin" /> Analyzing...</>
                                ) : (
                                    <><Zap className="w-3 h-3" /> AI Analyze Plot</>
                                )}
                            </button>
                            <button 
                                onClick={suggestNextBeats}
                                disabled={isAnalyzingTimeline || timeline.length === 0}
                                className="flex items-center gap-2 px-3 py-1.5 bg-emerald-600 hover:bg-emerald-500 disabled:bg-emerald-800 disabled:cursor-not-allowed text-white text-xs font-bold rounded shadow-lg transition-colors"
                                title="Generate AI suggestions for future story beats"
                            >
                                <Lightbulb className="w-3 h-3" /> Suggest Next Beats
                            </button>
                            <button 
                                onClick={() => {
                                    setEditingBeat(null);
                                    setShowBeatEditor(true);
                                }}
                                className="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold rounded shadow-lg"
                            >
                                <Plus className="w-3 h-3" /> Add Beat
                            </button>
                        </div>
                    </div>

                    {!hasTimeline ? (
                        <div className="flex-1 flex items-center justify-center text-slate-500">
                            <div className="text-center max-w-md">
                                <Layout className="w-16 h-16 mx-auto mb-4 opacity-30" />
                                <p className="text-lg mb-2 font-semibold">No timeline beats yet</p>
                                <p className="text-sm mb-6">Build your story structure beat by beat</p>
                                
                                <div className="flex flex-col gap-3 items-center">
                                    <button
                                        onClick={() => {
                                            setEditingBeat(null);
                                            setShowBeatEditor(true);
                                        }}
                                        className="flex items-center gap-2 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-lg shadow-lg transition-colors"
                                    >
                                        <Plus className="w-4 h-4" /> Add First Beat Manually
                                    </button>
                                    
                                    <div className="flex items-center gap-2 my-2">
                                        <div className="h-px w-16 bg-slate-700"></div>
                                        <span className="text-xs text-slate-600">OR</span>
                                        <div className="h-px w-16 bg-slate-700"></div>
                                    </div>
                                    
                                    <button
                                        onClick={analyzeTimelinePlot}
                                        disabled={isAnalyzingTimeline}
                                        className="flex items-center gap-2 px-6 py-3 bg-purple-600 hover:bg-purple-500 disabled:bg-purple-800 disabled:cursor-not-allowed text-white text-sm font-bold rounded-lg shadow-lg transition-colors"
                                    >
                                        {isAnalyzingTimeline ? (
                                            <><Loader2 className="w-4 h-4 animate-spin" /> Analyzing...</>
                                        ) : (
                                            <><Zap className="w-4 h-4" /> Let AI Analyze Your Story</>
                                        )}
                                    </button>
                                </div>
                                
                                <p className="text-xs text-slate-600 mt-6 italic">
                                    Click any beat to edit • Drag beats to reorder • Delete with confirmation
                                </p>
                            </div>
                        </div>
                    ) : (
                        <div className="flex-1 overflow-x-auto overflow-y-hidden p-8 relative min-w-full bg-[#13151a]">
                            <div className="absolute inset-0 opacity-10" style={{ backgroundImage: 'linear-gradient(#334155 1px, transparent 1px), linear-gradient(90deg, #334155 1px, transparent 1px)', backgroundSize: '40px 40px' }}></div>
                            
                            <div className="flex flex-col gap-6 relative z-10" style={{ minWidth: `${effectiveChapters * chapterWidthRem}rem` }}>
                                <div className="flex pl-24 relative" style={{ minWidth: `${effectiveChapters * chapterWidthRem}rem` }}>
                                    {currentProject.sections.flatMap(s => s.chapters).map((chapter, idx) => (
                                        <div key={chapter.id} className="absolute text-xs font-medium text-slate-500 mb-2 border-b border-slate-800 pb-2 truncate" title={chapter.title} style={{ left: `${idx * chapterWidthRem}rem`, width: `${chapterWidthRem}rem` }}>
                                            {idx + 1}. {chapter.title}
                                        </div>
                                    ))}
                                    {/* Add placeholder columns if beats extend beyond chapter count */}
                                    {Array.from({ length: Math.max(0, effectiveChapters - totalChapters) }).map((_, idx) => (
                                        <div key={`placeholder-${idx}`} className="absolute text-xs text-slate-700 mb-2 border-b border-slate-800 pb-2" style={{ left: `${(totalChapters + idx) * chapterWidthRem}rem`, width: `${chapterWidthRem}rem` }}>—</div>
                                    ))}
                                    {/* Spacer to maintain layout height */}
                                    <div className="h-6 w-full"></div>
                                </div>

                                {/* Render lanes dynamically */}
                                {['Main Plot', 'Character Arc', 'B-Plot', 'Theme'].map(lane => {
                                    const laneItems = laneLayouts[lane];
                                    const laneHasData = laneItems.some(l => l.item._kind === 'beat' || l.item._kind === 'suggestion');
                                    if (!laneHasData) return null;

                                    return (
                                        <div key={lane} className="flex items-center h-28 relative group">
                                            <div className="w-24 text-[10px] font-bold text-slate-400 text-right pr-4 uppercase tracking-wider">{lane}</div>
                                            <div className="flex-1 bg-slate-900/50 rounded-lg h-24 flex items-center relative border border-slate-800/50 backdrop-blur-sm">
                                                {/* Actual Beats with non-overlapping layout */}
                                                {laneItems.filter(l => l.item._kind === 'beat').map(({ item, layout }) => (
                                                    <div 
                                                        key={item.id}
                                                        onClick={() => {
                                                            setEditingBeat(item);
                                                            setShowBeatEditor(true);
                                                        }}
                                                        className={`absolute top-2 bottom-2 rounded-md p-3 ${item.color || 'bg-blue-500'} shadow-lg cursor-pointer hover:brightness-110 flex flex-col justify-between border-t border-white/10 transition-all`}
                                                        style={{ left: `${layout.leftRem}rem`, width: `${layout.widthRem}rem` }}
                                                        title={item.description || item.title}
                                                    >
                                                        <div className="flex items-start justify-between">
                                                            <span className="text-xs font-bold text-white/90 drop-shadow-md">{item.title}</span>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    if (confirm(`Delete "${item.title}"?`)) deleteBeat(item.id);
                                                                }}
                                                                className="opacity-0 group-hover:opacity-100 hover:bg-red-500/20 rounded p-1 transition-opacity"
                                                            >
                                                                <X className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                        {item.description && (
                                                            <span className="text-[10px] text-white/70">{item.description.substring(0, 50)}...</span>
                                                        )}
                                                    </div>
                                                ))}
                                                
                                                {/* Suggested Beats (non-overlapping, dashed border) */}
                                                {laneItems.filter(l => l.item._kind === 'suggestion').map(({ item, layout }) => (
                                                    <div 
                                                        key={item.id}
                                                        className={`absolute top-2 bottom-2 rounded-md p-3 ${item.color || 'bg-blue-500'} opacity-50 shadow-lg cursor-pointer hover:opacity-70 flex flex-col justify-between border-2 border-dashed border-white/40 transition-all`}
                                                        style={{ left: `${layout.leftRem}rem`, width: `${layout.widthRem}rem` }}
                                                        title={`SUGGESTION: ${item.description || item.title}`}
                                                    >
                                                        <div className="flex items-start justify-between">
                                                            <span className="text-xs font-bold text-white/90 drop-shadow-md flex items-center gap-1">
                                                                <Zap className="w-3 h-3" />
                                                                {item.title}
                                                            </span>
                                                        </div>
                                                        {item.description && (
                                                            <span className="text-[10px] text-white/70">{item.description.substring(0, 40)}...</span>
                                                        )}
                                                        <div className="flex gap-1 mt-2">
                                                            <button
                                                                onClick={() => acceptSuggestion(item)}
                                                                className="flex-1 bg-emerald-500/80 hover:bg-emerald-500 text-white text-[10px] font-bold py-1 px-2 rounded transition-colors"
                                                            >
                                                                Accept
                                                            </button>
                                                            <button
                                                                onClick={() => setSuggestedBeats(prev => prev.filter(s => s.id !== item.id))}
                                                                className="bg-red-500/80 hover:bg-red-500 text-white text-[10px] font-bold py-1 px-2 rounded transition-colors"
                                                            >
                                                                <X className="w-3 h-3" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    <div className="h-80 bg-[#0f1116] border-t border-slate-800 p-4 relative">
                        <div className="absolute top-2 left-4 text-[10px] font-bold text-slate-500 uppercase flex flex-col gap-2">
                            <div className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-indigo-500"></span> Tension
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-emerald-500"></span> Pacing
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="w-2 h-2 rounded-full bg-amber-500"></span> Emotion
                            </div>
                        </div>
                        <svg className="w-full h-full pt-4" viewBox="0 0 1000 250" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="gradientTension" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stopColor="#6366f1" stopOpacity="0.3" />
                                    <stop offset="100%" stopColor="#6366f1" stopOpacity="0" />
                                </linearGradient>
                                <linearGradient id="gradientPacing" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stopColor="#10b981" stopOpacity="0.2" />
                                    <stop offset="100%" stopColor="#10b981" stopOpacity="0" />
                                </linearGradient>
                                <linearGradient id="gradientEmotion" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" stopColor="#f59e0b" stopOpacity="0.2" />
                                    <stop offset="100%" stopColor="#f59e0b" stopOpacity="0" />
                                </linearGradient>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                    <feMerge>
                                        <feMergeNode in="coloredBlur"/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>
                            {/* Grid lines */}
                            <line x1="0" y1="62.5" x2="1000" y2="62.5" stroke="#1e293b" strokeWidth="0.5" strokeDasharray="2 2" opacity="0.3" />
                            <line x1="0" y1="125" x2="1000" y2="125" stroke="#1e293b" strokeWidth="1" strokeDasharray="4 4" />
                            <line x1="0" y1="187.5" x2="1000" y2="187.5" stroke="#1e293b" strokeWidth="0.5" strokeDasharray="2 2" opacity="0.3" />
                            
                            {/* Tension curve (Intensity) */}
                            {timeline.length > 0 && (
                                <>
                                    <path 
                                        d={`M0,${250 - (timeline[0]?.intensity || 5) * 25} ${timeline.map((b) => `L${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - (b.intensity || 5) * 25}`).join(' ')}`}
                                        fill="none" 
                                        stroke="#6366f1" 
                                        strokeWidth="3" 
                                        filter="url(#glow)"
                                    />
                                    <path 
                                        d={`M0,${250 - (timeline[0]?.intensity || 5) * 25} ${timeline.map((b) => `L${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - (b.intensity || 5) * 25}`).join(' ')} L1000,250 L0,250 Z`}
                                        fill="url(#gradientTension)" 
                                    />
                                </>
                            )}
                            
                            {/* Pacing curve (Duration inverse - shorter beats = faster pacing) */}
                            {timeline.length > 0 && (
                                <>
                                    <path 
                                        d={`M0,${250 - (10 / (timeline[0]?.duration || 2)) * 25} ${timeline.map((b) => `L${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - (10 / (b.duration || 2)) * 25}`).join(' ')}`}
                                        fill="none" 
                                        stroke="#10b981" 
                                        strokeWidth="2" 
                                        opacity="0.7"
                                    />
                                    <path 
                                        d={`M0,${250 - (10 / (timeline[0]?.duration || 2)) * 25} ${timeline.map((b) => `L${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - (10 / (b.duration || 2)) * 25}`).join(' ')} L1000,250 L0,250 Z`}
                                        fill="url(#gradientPacing)" 
                                    />
                                </>
                            )}
                            
                            {/* Emotional Impact curve (using intensity with different calculation) */}
                            {timeline.length > 0 && (
                                <>
                                    <path 
                                        d={`M0,${250 - ((timeline[0]?.intensity || 5) * (timeline[0]?.duration || 2) / 2) * 15} ${timeline.map((b) => `L${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - ((b.intensity || 5) * (b.duration || 2) / 2) * 15}`).join(' ')}`}
                                        fill="none" 
                                        stroke="#f59e0b" 
                                        strokeWidth="2" 
                                        opacity="0.6"
                                    />
                                    <path 
                                        d={`M0,${250 - ((timeline[0]?.intensity || 5) * (timeline[0]?.duration || 2) / 2) * 15} ${timeline.map((b) => `L${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - ((b.intensity || 5) * (b.duration || 2) / 2) * 15}`).join(' ')} L1000,250 L0,250 Z`}
                                        fill="url(#gradientEmotion)" 
                                    />
                                </>
                            )}
                            
                            {/* Beat markers with hover labels */}
                            {timeline.map((beat, i) => {
                                    const x = (beat.start / Math.max(10, effectiveChapters)) * 1000;
                                    const y = 250 - (beat.intensity || 5) * 25;
                                    const labelWidth = 240;
                                    const labelHeight = 60;
                                    const clampedX = Math.min(Math.max(x, labelWidth / 2), 1000 - labelWidth / 2);
                                    return (
                                        <g key={beat.id} className="group cursor-pointer">
                                            <circle cx={x} cy={y} r="5" fill="#6366f1" stroke="white" strokeWidth="2" className="transition-all group-hover:r-7" />
                                            {/* Hover label with glassmorphism background */}
                                            <foreignObject x={clampedX - labelWidth / 2} y={y - labelHeight - 12} width={labelWidth} height={labelHeight} className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                <div className="bg-slate-900/85 backdrop-blur-md border border-slate-700/50 rounded-lg px-3 py-2 shadow-xl text-left">
                                                    <div className="text-xs font-bold text-white mb-1 leading-tight line-clamp-2" title={beat.title}>{beat.title}</div>
                                                    {beat.description && (
                                                        <div className="text-[11px] text-slate-200/90 leading-tight line-clamp-2" title={beat.description}>{beat.description}</div>
                                                    )}
                                                </div>
                                            </foreignObject>
                                        </g>
                                    );
                            })}
                            
                            {/* Suggested beats curve (dashed) */}
                            {suggestedBeats.length > 0 && (
                                <>
                                    <path 
                                        d={`${suggestedBeats.map((b, i) => `${i === 0 ? 'M' : 'L'}${(b.start / Math.max(10, effectiveChapters)) * 1000},${250 - (b.intensity || 5) * 25}`).join(' ')}`}
                                        fill="none" 
                                        stroke="#a855f7" 
                                        strokeWidth="2" 
                                        strokeDasharray="5 5"
                                        opacity="0.5"
                                    />
                                    {/* Suggestion markers */}
                                    {suggestedBeats.map((beat, i) => {
                                        const x = (beat.start / Math.max(10, effectiveChapters)) * 1000;
                                        const y = 250 - (beat.intensity || 5) * 25;
                                        const labelWidth = 240;
                                        const labelHeight = 60;
                                        const clampedX = Math.min(Math.max(x, labelWidth / 2), 1000 - labelWidth / 2);
                                        return (
                                            <g key={beat.id} className="group cursor-pointer">
                                                <circle cx={x} cy={y} r="4" fill="#a855f7" stroke="white" strokeWidth="1.5" opacity="0.7" className="transition-all group-hover:r-6" />
                                                <foreignObject x={clampedX - labelWidth / 2} y={y - labelHeight - 12} width={labelWidth} height={labelHeight} className="opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                                    <div className="bg-purple-900/85 backdrop-blur-md border border-purple-700/50 rounded-lg px-3 py-2 shadow-xl text-left">
                                                        <div className="text-xs font-bold text-white mb-1 leading-tight line-clamp-2" title={beat.title}>AI: {beat.title}</div>
                                                        {beat.description && (
                                                            <div className="text-[11px] text-purple-100/90 leading-tight line-clamp-2" title={beat.description}>{beat.description}</div>
                                                        )}
                                                    </div>
                                                </foreignObject>
                                            </g>
                                        );
                                    })}
                                </>
                            )}
                        </svg>
                    </div>

                    {/* Beat Editor Modal */}
                    {showBeatEditor && (
                        <div className="absolute inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
                            <div className="bg-slate-900 rounded-xl shadow-2xl w-[500px] border border-slate-700">
                                <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-white">{editingBeat ? 'Edit Beat' : 'Add New Beat'}</h3>
                                    <button onClick={() => setShowBeatEditor(false)} className="text-slate-500 hover:text-white">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                <div className="p-6 space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Title</label>
                                        <input 
                                            type="text" 
                                            defaultValue={editingBeat?.title || ''}
                                            id="beat-title"
                                            className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500"
                                            placeholder="e.g., Inciting Incident"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Description</label>
                                        <textarea 
                                            defaultValue={editingBeat?.description || ''}
                                            id="beat-description"
                                            className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500 h-20"
                                            placeholder="Brief summary of what happens..."
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Lane</label>
                                            <select 
                                                defaultValue={editingBeat?.lane || 'Main Plot'}
                                                id="beat-lane"
                                                className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500"
                                            >
                                                <option>Main Plot</option>
                                                <option>Character Arc</option>
                                                <option>B-Plot</option>
                                                <option>Theme</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Chapter</label>
                                            <input 
                                                type="number" 
                                                min="1"
                                                defaultValue={editingBeat?.start || 1}
                                                id="beat-chapter"
                                                className="w-full bg-slate-950 border border-slate-800 rounded px-3 py-2 text-sm text-slate-300 focus:outline-none focus:border-indigo-500"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 uppercase mb-2 block">Intensity (1-10)</label>
                                        <input 
                                            type="range" 
                                            min="1" 
                                            max="10"
                                            defaultValue={editingBeat?.intensity || 5}
                                            id="beat-intensity"
                                            className="w-full accent-indigo-500"
                                        />
                                    </div>
                                </div>
                                <div className="p-6 border-t border-slate-800 flex justify-end gap-2">
                                    <button 
                                        onClick={() => setShowBeatEditor(false)}
                                        className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded font-medium text-sm transition-colors"
                                    >
                                        Cancel
                                    </button>
                                    <button 
                                        onClick={() => {
                                            const title = document.getElementById('beat-title').value;
                                            const description = document.getElementById('beat-description').value;
                                            const lane = document.getElementById('beat-lane').value;
                                            const chapter = parseInt(document.getElementById('beat-chapter').value);
                                            const intensity = parseInt(document.getElementById('beat-intensity').value);
                                            
                                            if (!title) {
                                                alert('Please enter a title');
                                                return;
                                            }
                                            
                                            if (editingBeat) {
                                                updateBeat(editingBeat.id, {
                                                    title,
                                                    description,
                                                    lane,
                                                    start: chapter,
                                                    intensity,
                                                    color: getLaneColor(lane)
                                                });
                                            } else {
                                                const updatedProject = { ...currentProject };
                                                const newBeat = {
                                                    id: `beat-${Date.now()}`,
                                                    title,
                                                    description,
                                                    lane,
                                                    start: chapter,
                                                    duration: 1,
                                                    intensity,
                                                    color: getLaneColor(lane),
                                                    type: 'beat'
                                                };
                                                updatedProject.timeline = [...(updatedProject.timeline || []), newBeat];
                                                setCurrentProject(updatedProject);
                                                ProjectStorage.saveProject(updatedProject);
                                            }
                                            setShowBeatEditor(false);
                                            setEditingBeat(null);
                                        }}
                                        className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-medium text-sm transition-colors"
                                    >
                                        {editingBeat ? 'Update' : 'Create'} Beat
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
                );
            };



            // 5. INSIGHTS (STATS)
            const renderStats = () => {
                // Prepare Heatmap Data (Last 98 days)
                const today = new Date();
                const heatmapData = [];
                for (let i = 97; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    const dayStats = stats[dateStr];
                    heatmapData.push({
                        date: dateStr,
                        count: dayStats ? dayStats.netWords : 0
                    });
                }

                // Prepare Goal Data (Last 7 days)
                const goalData = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    const dayStats = stats[dateStr];
                    goalData.push({
                        date: dateStr,
                        count: dayStats ? dayStats.netWords : 0,
                        goal: dayStats ? (dayStats.goal || 500) : 500,
                        isToday: i === 0
                    });
                }
                
                const todayStats = stats[today.toISOString().split('T')[0]];
                const todayCount = todayStats ? todayStats.netWords : 0;
                const todayGoal = todayStats ? (todayStats.goal || 500) : 500;

                return (
                <div className="flex-1 bg-[#0b0c0f] p-12 overflow-y-auto">
                <header className="mb-10 flex justify-between items-end">
                    <div>
                        <h2 className="text-3xl font-bold text-white mb-2">Writer Analytics</h2>
                        <p className="text-slate-500">Productivity & Progress Tracking</p>
                    </div>
                    <div className="flex gap-2">
                        <div className="px-4 py-2 bg-slate-800 rounded-lg border border-slate-700 text-center">
                            <div className="text-xs text-slate-500 uppercase">Streak</div>
                            <div className="font-bold text-emerald-400">{streak} Days</div>
                        </div>
                        <div className="px-4 py-2 bg-slate-800 rounded-lg border border-slate-700 text-center">
                            <div className="text-xs text-slate-500 uppercase">Total Words</div>
                            <div className="font-bold text-blue-400">{globalWordCount}</div>
                        </div>
                    </div>
                </header>
                
                <div className="grid grid-cols-2 gap-8">
                    {/* Heatmap */}
                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg">
                    <h3 className="text-xs font-bold text-slate-400 uppercase mb-6 flex items-center gap-2"><Anchor className="w-4 h-4" /> Activity Heatmap (Last 3 Months)</h3>
                    <div className="grid grid-cols-[repeat(14,minmax(0,1fr))] gap-1.5 h-auto">
                        {heatmapData.map((day, i) => {
                            let color = 'bg-slate-800/50';
                            if (day.count > 0) color = 'bg-emerald-900';
                            if (day.count > 500) color = 'bg-emerald-700';
                            if (day.count > 1000) color = 'bg-emerald-500';
                            if (day.count > 2000) color = 'bg-emerald-400';
                            
                            return (
                            <div 
                            key={i} 
                            className={`aspect-square rounded-sm transition-all hover:scale-125 ${color}`}
                            title={`${day.date}: ${day.count} words`}
                            />
                        )})}
                    </div>
                    </div>

                    {/* Goal Tracking */}
                    <div className="bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-lg relative overflow-hidden flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2"><Target className="w-4 h-4" /> Daily Goal Tracking</h3>
                        <div className="flex items-center gap-2">
                            <span className="text-xs text-slate-500">Goal:</span>
                            <input 
                                type="number" 
                                value={todayGoal} 
                                onChange={(e) => {
                                    const newGoal = e.target.value;
                                    const newHistory = StatsStorage.setGoal(newGoal);
                                    setStats(newHistory);
                                }}
                                className="w-16 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs text-white focus:outline-none focus:border-indigo-500"
                            />
                        </div>
                    </div>
                    <div className="flex items-end gap-3 flex-1 px-4 pb-4 border-b border-slate-800 mb-4">
                        {goalData.map((day, i) => {
                            const percent = Math.min((day.count / day.goal) * 100, 100);
                            return (
                            <div key={i} className="flex-1 bg-indigo-500/10 rounded-t relative group flex flex-col justify-end h-full" title={`${day.date}: ${day.count} / ${day.goal}`}>
                            <div className={`rounded-t w-full transition-all duration-1000 relative ${day.count >= day.goal ? 'bg-emerald-500' : 'bg-indigo-500'}`} style={{ height: `${Math.max(percent, 5)}%` }}>
                                {day.isToday && <div className="absolute -top-6 left-1/2 -translate-x-1/2 text-[10px] font-bold text-white bg-indigo-600 px-1.5 py-0.5 rounded">Today</div>}
                            </div>
                            </div>
                        )})}
                    </div>
                    <div className="flex justify-between items-center">
                        <p className="text-xs text-slate-500 italic">
                            {todayCount >= todayGoal ? "Goal reached! Great job!" : `${todayGoal - todayCount} words to reach your daily goal.`}
                        </p>
                        <div className="text-xs font-bold text-white">
                            {todayCount} / {todayGoal}
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            );
            };

            // -- MAIN LAYOUT COMPOSITION --
            
            return (
                <div className="h-screen w-full font-sans flex text-slate-300 bg-[#0b0c0f] selection:bg-indigo-500/30 overflow-hidden">
                
                {/* 1. App Rail (Navigation) */}
                <div className={`w-16 bg-[#050608] border-r border-slate-900 flex flex-col items-center py-6 gap-6 z-50 transition-all duration-500 ${focusMode ? '-translate-x-full absolute' : ''}`}>
                    <div title="Editor" onClick={() => setActiveTab('write')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'write' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <PenTool className="w-5 h-5" />
                    </div>
                    <div title="Architect (Timeline)" onClick={() => setActiveTab('plan')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'plan' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <Layout className="w-5 h-5" />
                    </div>
                    <div title="Story Codex" onClick={() => setActiveTab('world')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'world' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <Map className="w-5 h-5" />
                    </div>
                    <div title="Analytics" onClick={() => setActiveTab('stats')} className={`p-3 rounded-2xl cursor-pointer transition-all ${activeTab === 'stats' ? 'bg-indigo-600 text-white shadow-[0_0_20px_rgba(79,70,229,0.4)]' : 'text-slate-500 hover:bg-slate-800 hover:text-white'}`}>
                        <BarChart2 className="w-5 h-5" />
                    </div>
                    
                    <div className="mt-auto flex flex-col gap-4 items-center">
                        <div 
                            className="w-10 h-10 rounded-full bg-gradient-to-tr from-purple-500 to-indigo-500 flex items-center justify-center border-2 border-slate-700 hover:border-indigo-500 cursor-pointer transition-colors overflow-hidden"
                            title={userInfo ? `Signed in as ${userInfo.displayName}` : 'Not signed in'}
                        >
                            {userInfo ? (
                                userInfo.photoLink ? (
                                    <img src={userInfo.photoLink} className="w-full h-full object-cover" alt="User" />
                                ) : (
                                    <span className="text-sm font-bold text-white">{userInfo.displayName.charAt(0)}</span>
                                )
                            ) : (
                                <img src="N.svg" alt="NarrativeOS" className="w-7 h-7" />
                            )}
                        </div>
                    </div>
                </div>

                {/* 2. Secondary Sidebar (Binder) - Only in Write Mode */}
                {!focusMode && activeTab === 'write' && renderSidebar()}

                {/* 3. Main Workspace */}
                <main 
                    key={`${currentProject ? currentProject.id : 'none'}-${activeTab}`}
                    className="flex-1 flex flex-col relative overflow-hidden bg-[#0b0c0f] animate-fade-in"
                >
                    {activeTab === 'write' && renderEditor()}
                    {activeTab === 'plan' && renderTimeline()}
                    {activeTab === 'world' && <WorldView 
                        currentProject={currentProject}
                        setCurrentProject={setCurrentProject}
                        relationships={relationships}
                        setRelationships={setRelationships}
                        relationshipTimeline={relationshipTimeline}
                        setRelationshipTimeline={setRelationshipTimeline}
                        timelineIndex={timelineIndex}
                        setTimelineIndex={setTimelineIndex}
                        showRelationshipEditor={showRelationshipEditor}
                        setShowRelationshipEditor={setShowRelationshipEditor}
                        aiProvider={aiProvider}
                        selectedModel={selectedModel}
                        hfModel={hfModel}
                        githubModel={githubModel}
                        availableModels={availableModels}
                        HF_MODELS={HF_MODELS}
                        GITHUB_MODELS={GITHUB_MODELS}
                        setSelectedModel={setSelectedModel}
                        setHfModel={setHfModel}
                        setGithubModel={setGithubModel}
                        analyzeRelationships={analyzeRelationships}
                        isAiLoading={isAiLoading}
                        analysisScope={analysisScope}
                        setAnalysisScope={setAnalysisScope}
                        relationshipViewMode={relationshipViewMode}
                        setRelationshipViewMode={setRelationshipViewMode}
                    />}
                    {activeTab === 'stats' && renderStats()}
                </main>
                
                {/* Project Modal */}
                {showProjectModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                        <div className="bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
                            <div className="p-6 border-b border-slate-700 flex items-center justify-between">
                                <h2 className="text-2xl font-bold text-white">Your Projects</h2>
                                <button 
                                    onClick={() => setShowProjectModal(false)}
                                    className="text-slate-400 hover:text-white"
                                >
                                    <X className="w-6 h-6" />
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto p-6">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {projects.map(project => (
                                        <div 
                                            key={project.id}
                                            onClick={async () => {
                                                setShowProjectModal(false); // Close immediately for responsiveness
                                                if (project.isCloud) {
                                                    await switchToProject(project.id);
                                                } else {
                                                    // Add artificial delay for smoothness consistency? No, keep it fast.
                                                    const stored = ProjectStorage.getProject(project.id) || project;
                                                    const fresh = normalizeProject(stored);
                                                    setCurrentProject(fresh);
                                                    if (fresh.sections.length > 0) {
                                                        setSelectedSectionId(fresh.sections[0].id);
                                                        if (fresh.sections[0].chapters.length > 0) {
                                                            setSelectedChapterId(fresh.sections[0].chapters[0].id);
                                                        }
                                                    }
                                                }
                                            }}
                                            className={`p-4 rounded-xl border-2 cursor-pointer transition-all ${
                                                currentProject && currentProject.id === project.id 
                                                    ? 'border-indigo-500 bg-indigo-500/10' 
                                                    : 'border-slate-700 hover:border-slate-600 bg-slate-800/50'
                                            }`}
                                        >
                                            <div className="flex justify-between items-start mb-2">
                                                <h3 className="text-lg font-bold text-white max-w-[80%] truncate">{project.name}</h3>
                                                {project.isCloud ? (
                                                    <Cloud className="w-4 h-4 text-emerald-400" />
                                                ) : isConnectedToCloud ? (
                                                    <button 
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            uploadProjectToCloud(project);
                                                        }}
                                                        className="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-2 py-1 rounded flex items-center gap-1 z-10 relative"
                                                        title="Upload to Cloud"
                                                    >
                                                        <CloudLightning className="w-3 h-3" /> Sync
                                                    </button>
                                                ) : null}
                                            </div>
                                            <div className="flex items-center gap-4 text-xs text-slate-400 mb-2">
                                                <span>{project.sections.length} section(s)</span>
                                                <span>•</span>
                                                <span>{project.sections.reduce((acc, s) => acc + s.chapters.length, 0)} chapter(s)</span>
                                            </div>
                                            <div className="text-xs text-slate-500">
                                                Modified: {new Date(project.lastModified).toLocaleDateString()}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                
                                <button 
                                    onClick={() => {
                                        const name = prompt('Project name:', 'My New Novel');
                                        if (name) {
                                            const newProject = ProjectStorage.createProject(name);
                                            setProjects([...projects, newProject]);
                                            setCurrentProject(newProject);
                                            setSelectedSectionId(newProject.sections[0].id);
                                            setSelectedChapterId(newProject.sections[0].chapters[0].id);
                                            setShowProjectModal(false);
                                        }
                                    }}
                                    className="w-full py-4 px-6 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition-all"
                                >
                                    <Plus className="w-5 h-5" />
                                    Create New Project
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Cloud Connection Modal */}
                {showCloudModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] p-4">
                        <div className="bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl w-full max-w-md overflow-hidden flex flex-col">
                            <div className="p-6 border-b border-slate-700 flex items-center justify-between">
                                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                    <Cloud className="w-5 h-5 text-indigo-500" /> 
                                    Cloud Sync (Firebase)
                                </h2>
                                <button 
                                    onClick={() => setShowCloudModal(false)}
                                    className="text-slate-400 hover:text-white"
                                >
                                    <X className="w-5 h-5" />
                                </button>
                            </div>
                            
                            <div className="p-6 space-y-6">
                                {!firebaseConfig ? (
                                    <div className="space-y-4">
                                        <div className="bg-amber-500/10 border border-amber-500/20 rounded-lg p-4 text-xs text-amber-200">
                                            <p className="font-bold mb-1">Configuration Required</p>
                                            <p>To enable sync, please paste your Firebase Configuration details below.</p>
                                            <p className="mt-1 opacity-75">You can paste the raw JS code block (e.g., <code>const firebaseConfig = ...</code>) or the JSON object.</p>
                                        </div>
                                        <textarea
                                            placeholder={'const firebaseConfig = {\n  apiKey: "...",\n  authDomain: "...",\n  projectId: "..."\n};'}
                                            className="w-full h-40 bg-black/50 border border-slate-700 rounded-lg p-3 text-xs font-mono text-slate-300 focus:outline-none focus:border-indigo-500"
                                            id="firebase-config-input"
                                        ></textarea>
                                        <button
                                            onClick={() => {
                                                const input = document.getElementById('firebase-config-input').value;
                                                
                                                const parseConfig = (str) => {
                                                    try {
                                                        // 1. Locate the object
                                                        let clean = str.trim();
                                                        const start = clean.indexOf('{');
                                                        const end = clean.lastIndexOf('}');
                                                        if (start === -1 || end === -1) throw new Error("No config object found in text");
                                                        
                                                        let objectBody = clean.substring(start, end + 1);
                                                        
                                                        // 2. Try strict JSON parse first
                                                        try { return JSON.parse(objectBody); } catch(e) {}
                                                        
                                                        // 3. Try evaluating as a JavaScript object literal
                                                        // This handles unquoted keys, comments, and trailing commas correctly
                                                        try {
                                                            return new Function("return " + objectBody)();
                                                        } catch(e) {
                                                            // If that fails, fall back to manual cleanup (less reliable)
                                                            console.warn("Eval failed, attempting manual parse", e);
                                                        }

                                                        // 4. Manual Parsing (Backup for when CSP forbids eval)
                                                        // Remove comments
                                                        objectBody = objectBody.replace(/\/\/.*$/gm, ""); 
                                                        objectBody = objectBody.replace(/\/\*[\s\S]*?\*\//g, "");
                                                        
                                                        // Quote unquoted keys - Use strict start-of-line anchor to avoid matching inside strings
                                                        // This assumes pretty-printed input with keys at start of lines
                                                        let fixedJson = objectBody.replace(/^\s*([a-zA-Z0-9_]+)\s*:/gm, '"$1":');
                                                        
                                                        // Also try to catch keys that are start of definition but maybe not start of line (e.g. minified)
                                                        // This is risky as seen before, so we only applying the safer regex above first.
                                                        
                                                        // Replace single quoted values with double quoted
                                                        fixedJson = fixedJson.replace(/:\s*'([^']+)'/g, ': "$1"');
                                                        // Remove trailing commas
                                                        fixedJson = fixedJson.replace(/,(\s*})/g, '$1');
                                                        
                                                        return JSON.parse(fixedJson);
                                                    } catch (e) {
                                                        console.error("Parsing error", e);
                                                        throw new Error("Could not automatically parse the config. Please ensure it is valid JSON or a standard JS object.");
                                                    }
                                                };

                                                try {
                                                    const config = parseConfig(input);
                                                    
                                                    // Basic validation
                                                    if (!config.apiKey || !config.projectId) {
                                                        throw new Error("Config appears incomplete (missing apiKey or projectId)");
                                                    }
                                                    
                                                    setFirebaseConfig(config);
                                                    localStorage.setItem('narrativeos-firebase-config', JSON.stringify(config));
                                                } catch (e) {
                                                    alert("Configuration Error: " + e.message);
                                                }
                                            }}
                                            className="w-full py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold text-sm"
                                        >
                                            Save Configuration
                                        </button>
                                    </div>
                                ) : (
                                    <div className="space-y-6">
                                        {!firebaseUser ? (
                                            <div className="text-center">
                                                <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4">
                                                    <User className="w-8 h-8 text-slate-500" />
                                                </div>
                                                <h3 className="text-lg font-bold text-white mb-2">Firebase Cloud Sync</h3>
                                                <p className="text-sm text-slate-400 mb-6">Connect via GitHub to sync with your Firebase database.</p>
                                                
                                                <button
                                                    onClick={handleGithubLogin}
                                                    disabled={!auth}
                                                    className={`w-full py-3 bg-slate-900 text-white border border-slate-700 rounded-lg font-bold text-sm flex items-center justify-center gap-2 ${!auth ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-800'}`}
                                                >
                                                    <Github className="w-5 h-5" />
                                                    {auth ? "Sign in with GitHub" : "Initializing..."}
                                                </button>
                                                
                                                <button 
                                                    onClick={() => {
                                                        if (confirm("Reset configuration?")) {
                                                            setFirebaseConfig(null);
                                                            localStorage.removeItem('narrativeos-firebase-config');
                                                            setAuth(null);
                                                        }
                                                    }}
                                                    className="mt-4 text-xs text-slate-500 hover:text-slate-400 underline"
                                                >
                                                    Reset Configuration
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="text-center">
                                                <img src={firebaseUser.photoURL} alt={firebaseUser.displayName} className="w-20 h-20 rounded-full mx-auto mb-4 border-2 border-indigo-500" />
                                                <h3 className="text-lg font-bold text-white mb-1">{firebaseUser.displayName}</h3>
                                                <p className="text-sm text-slate-400 mb-6">{firebaseUser.email}</p>
                                                
                                                <div className="bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-3 mb-6 flex items-center justify-center gap-2">
                                                    <Check className="w-4 h-4 text-emerald-500" />
                                                    <span className="text-sm text-emerald-400 font-medium">Cloud Sync Active</span>
                                                </div>
                                                
                                                <button
                                                    onClick={handleLogout}
                                                    className="w-full py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-lg font-bold text-sm flex items-center justify-center gap-2"
                                                >
                                                    <LogOut className="w-4 h-4" /> Sign Out
                                                </button>
                                            </div>
                                        )}
                                        
                                        <div className="border-t border-slate-800 pt-4 mt-6">
                                             <button 
                                                onClick={() => {
                                                    if(confirm("Clear configuration?")) {
                                                        setFirebaseConfig(null);
                                                        localStorage.removeItem('narrativeos-firebase-config');
                                                    }
                                                }}
                                                className="text-xs text-red-400 hover:text-red-300 underline"
                                             >
                                                Reset Configuration
                                             </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Cloud Loading Overlay */}
                {isCloudLoading && (
                    <div className="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-[100] animate-in fade-in duration-200">
                        <div className="bg-slate-900 border border-slate-700 rounded-2xl p-8 shadow-2xl flex flex-col items-center gap-4">
                            <div className="w-16 h-16 border-4 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin"></div>
                            <div className="text-white font-semibold">{loadingMessage}</div>
                            <div className="text-xs text-slate-400">This may take a moment</div>
                        </div>
                    </div>
                )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NarrativeOS />);
    </script>
</body>
</html>